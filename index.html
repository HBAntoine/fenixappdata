<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fenix Handball Stats</title>

    <!-- PWA -->
    <meta name="theme-color" content="#EB275C">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Fenix Stats">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
    <link rel="apple-touch-icon" href="/icon-192.png">

    <!-- Libraries -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- Index des photos (genere par generer-index.py, fonctionne en file://) -->
    <script src="photos-index.js"></script>

    <!-- data.js est charge dynamiquement par autoLoadCSV() pour garantir la fraicheur -->
    
    <style>
        @font-face {
            font-family: 'ITC Avant Garde Gothic';
            src: url('ITC Avant Garde Gothic Bold (1).otf') format('opentype');
            font-weight: bold;
            font-style: normal;
        }
        
        :root {
            --dark: #0A1A2E;
            --blue: #669FB7;
            --pink: #EB275C;
            --white: #FFFFFF;
            --pink-light: #F37999;
            --grey: #94a3b8;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'ITC Avant Garde Gothic', 'Segoe UI', sans-serif;
            background: var(--dark);
            color: var(--white);
            min-height: 100vh;
        }
        
        /* HEADER */
        .header {
            background: linear-gradient(135deg, var(--pink) 0%, #C21847 100%);
            padding: 1rem 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 2rem;
            flex-wrap: wrap;
        }
        
        .header-title {
            font-size: 1.8rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .teams-nav {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .team-logo-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--white);
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--dark);
            position: relative;
        }
        
        .team-logo-btn:hover {
            transform: scale(1.1);
            border-color: var(--pink-light);
            box-shadow: 0 5px 15px rgba(235, 39, 92, 0.5);
        }
        
        .team-logo-btn.active {
            border-color: var(--pink-light);
            box-shadow: 0 0 20px rgba(235, 39, 92, 0.8);
            transform: scale(1.15);
        }
        
        /* FLOATING MENU BUBBLES */
        .floating-menu {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 12px;
        }
        
        .bubble-main {
            width: 60px;
            height: 60px;
            background: var(--white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            user-select: none;
        }
        
        .bubble-main:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        }
        
        .floating-menu-bubbles {
            display: flex;
            flex-direction: column;
            gap: 12px;
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
            transition: all 0.3s ease;
        }
        
        .floating-menu-bubbles.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }
        
        .bubble-item {
            width: 50px;
            height: 50px;
            background: var(--white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.25);
            transition: all 0.3s ease;
            user-select: none;
        }
        
        .bubble-item:hover {
            transform: scale(1.15);
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.35);
        }
        
        #bubbleReset:hover {
            background: rgba(255, 59, 48, 0.1);
        }
        
        #bubbleImport:hover {
            background: rgba(52, 199, 89, 0.1);
        }
        
        /* INDIV - PLAYER CARDS */
        .position-group {
            margin-bottom: 2rem;
        }
        
        .position-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--pink);
            margin-bottom: 1rem;
            padding: 0.5rem 1rem;
            background: rgba(236, 72, 153, 0.1);
            border-left: 4px solid var(--pink);
        }
        
        .player-cards-row {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .player-card {
            width: 140px;
            background: var(--dark-light);
            border-radius: 12px;
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .player-card:hover {
            transform: translateY(-5px);
            border-color: var(--pink);
            box-shadow: 0 8px 16px rgba(236, 72, 153, 0.3);
        }
        
        .player-photo {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: contain;
            object-position: center top;
            margin-bottom: 0.5rem;
            display: block;
            background: var(--dark-light);
            border: 2px solid var(--pink);
        }
        
        .player-number {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--pink);
            text-align: center;
            margin-bottom: 0.25rem;
        }
        
        .player-name {
            font-size: 0.85rem;
            font-weight: bold;
            color: var(--white);
            text-align: center;
            margin-bottom: 0.5rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }
        
        .player-stats-quick {
            text-align: center;
            font-size: 0.9rem;
        }
        
        .player-shoot {
            color: var(--blue);
            font-weight: bold;
        }
        
        .player-position-badge {
            display: inline-block;
            background: rgba(102, 159, 183, 0.2);
            color: var(--blue);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-top: 0.5rem;
        }
        
        /* PLAYER DETAIL PANEL */
        .player-detail-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--dark);
            z-index: 2000;
            overflow-y: auto;
            padding: 2rem;
        }
        
        .player-detail-panel.hidden {
            display: none;
        }
        
        .detail-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
        }
        
        .btn-back, .btn-close {
            background: var(--dark-light);
            color: var(--white);
            border: 1px solid var(--grey);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .btn-back:hover, .btn-close:hover {
            background: var(--pink);
            border-color: var(--pink);
        }
        
        .detail-player-info {
            display: flex;
            align-items: center;
            gap: 2rem;
            margin-bottom: 2rem;
            padding: 2rem;
            background: var(--dark-light);
            border-radius: 12px;
        }
        
        .detail-player-photo {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: contain;
            object-position: center top;
            border: 4px solid var(--pink);
            background: var(--dark-light);
        }
        
        .detail-player-text h2 {
            color: var(--pink);
            margin: 0 0 0.5rem 0;
            font-size: 2rem;
        }
        
        .detail-player-text p {
            color: var(--grey);
            margin: 0.25rem 0;
        }
        
        .detail-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--grey);
        }
        
        .detail-tab {
            background: transparent;
            color: var(--grey);
            border: none;
            padding: 1rem 2rem;
            font-family: inherit;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        
        .detail-tab:hover {
            color: var(--white);
        }
        
        .detail-tab.active {
            color: var(--pink);
            border-bottom-color: var(--pink);
        }
        
        #detailTableContainer {
            margin-top: 2rem;
        }
        
        /* DROP ZONE */
        .drop-zone {
            max-width: 800px;
            margin: 3rem auto;
            padding: 4rem 2rem;
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            border: 3px dashed var(--pink-light);
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .drop-zone:hover {
            border-color: var(--pink);
            background: rgba(235, 39, 92, 0.1);
        }
        
        .drop-zone.drag-over {
            border-color: var(--pink);
            background: rgba(235, 39, 92, 0.2);
            transform: scale(1.02);
        }
        
        .drop-zone h2 {
            color: var(--pink);
            margin-bottom: 1rem;
            font-size: 2rem;
        }
        
        .drop-zone p {
            color: var(--grey);
            margin-bottom: 2rem;
            font-size: 1.1rem;
        }
        
        .drop-zone .icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        
        .btn-upload-main {
            background: var(--pink);
            color: var(--white);
            padding: 1.5rem 3rem;
            border: none;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            display: inline-block;
        }
        
        .btn-upload-main:hover {
            background: #C21847;
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(235, 39, 92, 0.4);
        }
        
        .upload-info {
            margin-top: 2rem;
            padding: 1rem;
            background: rgba(102, 159, 183, 0.1);
            border-radius: 10px;
            color: var(--blue);
        }
        
        /* LOADING */
        .loading {
            text-align: center;
            padding: 3rem;
            max-width: 600px;
            margin: 3rem auto;
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
        }
        
        .spinner {
            border: 4px solid var(--pink-light);
            border-top: 4px solid var(--pink);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #loadingDetails {
            color: var(--grey);
            margin-top: 1rem;
            font-size: 0.9rem;
        }
        
        /* TEAM PAGE */
        .team-page {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .team-header-page {
            background: linear-gradient(135deg, rgba(235, 39, 92, 0.2) 0%, rgba(194, 24, 71, 0.1) 100%);
            padding: 2rem;
            border-radius: 20px;
            margin-bottom: 2rem;
            border: 1px solid var(--pink-light);
        }
        
        .team-header-page h1 {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }
        
        .team-stats-summary {
            display: flex;
            gap: 2rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .stat-value {
            font-size: 1.5rem;
            color: var(--pink);
            font-weight: bold;
        }
        
        .stat-label {
            color: var(--grey);
        }
        
        /* MODE SWITCH */
        .mode-switch {
            display: flex;
            gap: 1rem;
            background: rgba(255,255,255,0.05);
            padding: 0.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            width: fit-content;
        }
        
        .mode-btn {
            padding: 1rem 3rem;
            border: none;
            background: transparent;
            color: var(--grey);
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-family: inherit;
        }
        
        .mode-btn.active {
            background: var(--pink);
            color: var(--white);
            box-shadow: 0 4px 15px rgba(235, 39, 92, 0.4);
        }
        
        /* FILTERS */
        .filters-section {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }
        
        .filter-group label {
            display: block;
            font-weight: bold;
            color: var(--pink);
            margin-bottom: 0.5rem;
        }
        
        .filter-group select {
            width: 100%;
            padding: 0.75rem;
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--pink-light);
            border-radius: 8px;
            color: var(--white);
            font-family: inherit;
        }
        
        .filter-group select option {
            background: var(--dark);
            color: var(--white);
        }
        
        /* TABLE */
        .table-card {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .table-card h3 {
            color: var(--pink);
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: rgba(235, 39, 92, 0.2);
        }
        
        th {
            padding: 1rem;
            text-align: left;
            font-weight: bold;
            color: var(--pink-light);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9rem;
        }
        
        td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        tbody tr:hover {
            background: rgba(235, 39, 92, 0.1);
        }
        
        .total-row {
            background: rgba(235, 39, 92, 0.3) !important;
            font-weight: bold;
            border-top: 2px solid var(--pink);
        }
        
        /* SORTABLE HEADERS */
        th.sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 25px;
        }
        
        th.sortable:hover {
            background: rgba(235, 39, 92, 0.2);
        }
        
        th.sortable::after {
            content: '‚áÖ';
            position: absolute;
            right: 8px;
            opacity: 0.3;
            font-size: 0.8em;
        }
        
        th.sortable.asc::after {
            content: '‚ñ≤';
            opacity: 1;
        }
        
        th.sortable.desc::after {
            content: '‚ñº';
            opacity: 1;
        }
        
        /* HIDDEN ZEROS */
        .zero-value {
            color: var(--grey);
            opacity: 0.3;
        }
        
        /* UTILITIES */
        .hidden {
            display: none !important;
        }
        
        .alert {
            max-width: 600px;
            margin: 2rem auto;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .alert-success {
            background: rgba(52, 199, 89, 0.2);
            color: #34c759;
            border: 1px solid #34c759;
        }
        
        .alert-error {
            background: rgba(255, 59, 48, 0.2);
            color: #ff3b30;
            border: 1px solid #ff3b30;
        }
        
        .alert-info {
            background: rgba(102, 159, 183, 0.2);
            color: var(--blue);
            border: 1px solid var(--blue);
        }

        .data-status {
            text-align: center;
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            color: #8899a6;
            background: rgba(102, 159, 183, 0.08);
            border-bottom: 1px solid rgba(102, 159, 183, 0.15);
        }

        .data-status.warning {
            color: var(--pink);
            background: rgba(235, 39, 92, 0.08);
            border-bottom: 1px solid rgba(235, 39, 92, 0.15);
        }


        /* FILTER PANEL */
        .filter-trigger {
            position: fixed;
            top: 120px;
            left: 20px;
            z-index: 999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .filter-btn, .reset-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .filter-btn {
            background: linear-gradient(135deg, var(--pink), var(--pink-light));
            color: white;
        }
        
        .filter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(235, 39, 92, 0.4);
        }
        
        .reset-btn {
            background: rgba(255,255,255,0.1);
            color: var(--white);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .reset-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }
        
        .filter-panel {
            position: fixed;
            top: 0;
            left: -400px;
            width: 400px;
            height: 100vh;
            background: linear-gradient(180deg, #0a1a2e 0%, #162841 100%);
            box-shadow: 5px 0 30px rgba(0,0,0,0.5);
            z-index: 1000;
            transition: left 0.3s ease;
            overflow-y: auto;
            padding: 2rem;
        }
        
        .filter-panel.open {
            left: 0;
        }
        
        .filter-panel h3 {
            color: var(--pink);
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid rgba(235, 39, 92, 0.3);
        }
        
        .filter-category {
            margin-bottom: 2rem;
        }
        
        .filter-category-title {
            color: var(--white);
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .filter-category-title::before {
            content: '';
            width: 4px;
            height: 16px;
            background: var(--pink);
            border-radius: 2px;
        }
        
        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .filter-tag {
            padding: 8px 16px;
            border-radius: 20px;
            border: 2px solid rgba(102, 159, 183, 0.3);
            background: rgba(255,255,255,0.05);
            color: var(--grey);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            position: relative;
        }
        
        .filter-tag:hover {
            border-color: var(--blue);
            background: rgba(102, 159, 183, 0.1);
            color: var(--white);
        }
        
        .filter-tag.active {
            border-color: var(--pink);
            background: var(--pink);
            color: white;
            box-shadow: 0 2px 10px rgba(235, 39, 92, 0.3);
        }
        
        .filter-tag.hidden {
            display: none;
        }
        
        .filter-match-list {
            max-height: 200px;
            overflow-y: auto;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 1rem;
        }
        
        .filter-match-item {
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--grey);
            font-size: 0.9rem;
            position: relative;
        }
        
        .filter-match-item:hover {
            background: rgba(255,255,255,0.1);
            color: var(--white);
        }
        
        .filter-match-item.active {
            background: rgba(235, 39, 92, 0.2);
            color: var(--pink);
            font-weight: bold;
        }
        
        .filter-match-item.hidden {
            display: none;
        }
        
        .filter-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .filter-overlay.visible {
            opacity: 1;
            pointer-events: all;
        }
        
        /* VIEW TABS */
        .view-tabs {
            display: flex;
            gap: 0.5rem;
            background: rgba(255,255,255,0.05);
            padding: 0.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            overflow-x: auto;
        }
        
        .tab-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            background: transparent;
            color: var(--grey);
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-family: inherit;
            white-space: nowrap;
        }
        
        .tab-btn:hover {
            background: rgba(255,255,255,0.1);
            color: var(--white);
        }
        
        .tab-btn.active {
            background: var(--pink);
            color: var(--white);
            box-shadow: 0 4px 15px rgba(235, 39, 92, 0.4);
        }
        
        /* VIEW CONTENT */
        .view-content {
            display: none;
        }
        
        .view-content.active {
            display: block;
        }
        
        /* ACCORDION */
        .table-accordion {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(255,255,255,0.1);
            overflow: hidden;
        }
        
        .accordion-header {
            padding: 1.5rem 2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s ease;
            background: rgba(235, 39, 92, 0.1);
        }
        
        .accordion-header:hover {
            background: rgba(235, 39, 92, 0.2);
        }
        
        .accordion-icon {
            color: var(--pink);
            font-size: 1rem;
            transition: transform 0.3s ease;
        }
        
        .accordion-header.open .accordion-icon {
            transform: rotate(90deg);
        }
        
        .accordion-title {
            color: var(--pink);
            font-size: 1.3rem;
            font-weight: bold;
            flex-grow: 1;
        }
        
        .accordion-stats {
            color: var(--grey);
            font-size: 0.9rem;
        }
        
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .accordion-content.open {
            max-height: 2000px;
            padding: 1.5rem 2rem 2rem;
        }

        /* ===== PHOTO MODAL ===== */
        .photo-modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.75);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }
        .photo-modal-overlay.hidden { display: none; }
        .photo-modal {
            background: #1e293b;
            border-radius: 16px;
            padding: 24px;
            max-width: 700px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            color: #e2e8f0;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .photo-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .photo-modal-header h2 {
            margin: 0;
            font-size: 1.3rem;
        }
        .photo-modal-close {
            background: none;
            border: none;
            color: #e2e8f0;
            font-size: 28px;
            cursor: pointer;
            padding: 4px 8px;
            line-height: 1;
        }
        .photo-upload-zone {
            border: 2px dashed #475569;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            margin-bottom: 16px;
            transition: border-color 0.3s, background 0.3s;
            cursor: pointer;
        }
        .photo-upload-zone.drag-over {
            border-color: #EB275C;
            background: rgba(235,39,92,0.1);
        }
        .photo-upload-zone .icon { font-size: 2rem; margin-bottom: 8px; }
        .photo-upload-zone p { margin: 4px 0; color: #94a3b8; }
        .photo-upload-zone .subtitle { font-size: 0.8rem; color: #64748b; }
        .btn-upload-photos {
            background: #EB275C;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            display: inline-block;
            margin-top: 8px;
            font-size: 0.9rem;
        }
        .photo-preview-grid, .current-photos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 8px;
            margin-bottom: 16px;
        }
        .photo-preview-item, .current-photo-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 1;
            background: #0f172a;
        }
        .photo-preview-item img, .current-photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .photo-delete-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(239,68,68,0.9);
            border: none;
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        .photo-name-label {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            background: rgba(0,0,0,0.75);
            padding: 2px 4px;
            font-size: 9px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #cbd5e1;
        }
        .btn-upload-confirm {
            width: 100%;
            padding: 12px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 16px;
        }
        .btn-upload-confirm.hidden { display: none; }
        .photo-upload-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: #0f172a;
            border-radius: 8px;
            margin-bottom: 16px;
            color: #94a3b8;
        }
        .photo-upload-status.hidden { display: none; }
        .photo-section-title {
            font-size: 1rem;
            font-weight: 600;
            margin: 16px 0 8px;
            color: #e2e8f0;
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <div class="header">
        <div class="header-content">
            <div class="header-title">üèê Handball Analytics</div>
            <div class="teams-nav" id="teamsNav"></div>
        </div>
    </div>
    
    <!-- FLOATING SETTINGS MENU -->
    <div class="floating-menu">
        <div class="floating-menu-bubbles" id="floatingBubbles">
            <div class="bubble-item" id="bubbleReload" title="Recharger Events.csv">
                üîÑ
            </div>
            <div class="bubble-item" id="bubbleImport" title="Importer un fichier">
                <label for="fileInput" style="cursor: pointer; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
                    üìÅ
                </label>
            </div>
            <div class="bubble-item" id="bubblePhotos" title="G√©rer les photos">
                üì∏
            </div>
            <div class="bubble-item" id="bubbleReset" title="Reset">
                üóëÔ∏è
            </div>
        </div>
        <div class="bubble-main" id="bubbleMain">
            ‚öôÔ∏è
        </div>
    </div>
    <input type="file" id="fileInput" accept=".csv,.xlsx,.xlsm,.xls" style="display: none;">

    <!-- PHOTO UPLOAD MODAL -->
    <div class="photo-modal-overlay hidden" id="photoModalOverlay">
        <div class="photo-modal">
            <div class="photo-modal-header">
                <h2>üì∏ Photos - <span id="photoModalTeam"></span></h2>
                <button class="photo-modal-close" onclick="closePhotoModal()">&times;</button>
            </div>

            <div class="photo-upload-zone" id="photoDropZone">
                <div class="icon">üì∑</div>
                <p>Glissez des photos ici</p>
                <p class="subtitle">.png, .jpg, .jpeg, .webp, .gif</p>
                <label for="photoFileInput">
                    <div class="btn-upload-photos">ou cliquez pour selectionner</div>
                </label>
                <input type="file" id="photoFileInput" accept=".png,.jpg,.jpeg,.webp,.gif" multiple style="display: none;">
            </div>

            <div id="photoUploadPreview" class="photo-preview-grid"></div>

            <button class="btn-upload-confirm hidden" id="btnConfirmUpload" onclick="confirmPhotoUpload()">
                ‚¨ÜÔ∏è Envoyer <span id="photoUploadCount">0</span> photo(s)
            </button>

            <div class="photo-upload-status hidden" id="photoUploadStatus">
                <span id="photoUploadStatusText"></span>
            </div>

            <div class="photo-section-title">Photos actuelles</div>
            <div id="currentPhotosGrid" class="current-photos-grid"></div>
        </div>
    </div>
    
    <!-- ALERTS -->
    <div id="alertContainer"></div>

    <!-- DATA STATUS BAR -->
    <div class="data-status hidden" id="dataStatus">
        <span id="dataStatusText"></span>
    </div>

    <!-- DROP ZONE (fallback si Events.csv absent) -->
    <div class="drop-zone" id="dropZone">
        <div class="icon">üìÇ</div>
        <h2>Glissez votre fichier ici</h2>
        <p>Events.csv ou fichier Excel (.xlsx, .xlsm)</p>
        <label for="fileInputMain">
            <div class="btn-upload-main">ou cliquez pour s√©lectionner</div>
        </label>
        <input type="file" id="fileInputMain" accept=".csv,.xlsx,.xlsm,.xls" style="display: none;">
        <div class="upload-info">
            ‚úÖ Events.csv est charg√© automatiquement via le serveur local<br>
            ‚úÖ Lancez start-server.bat pour le chargement automatique
        </div>
    </div>
    
    <!-- LOADING -->
    <div class="loading hidden" id="loadingIndicator">
        <div class="spinner"></div>
        <p>Traitement en cours...</p>
        <div id="loadingDetails"></div>
    </div>
    
    <!-- TEAM PAGE -->
    <div class="team-page hidden" id="teamPage">
        <div class="team-header-page">
            <h1 id="teamPageTitle">üìç S√©lectionnez une √©quipe</h1>
            <div class="team-stats-summary">
                <div class="stat-item">
                    <div class="stat-value" id="statTotalLines">-</div>
                    <div class="stat-label">lignes totales</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statMatches">-</div>
                    <div class="stat-label">matchs</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statFilteredLines">-</div>
                    <div class="stat-label">lignes filtr√©es</div>
                </div>
            </div>
        </div>
        
        <!-- MODE SWITCH -->
        <div class="mode-switch">
            <button class="mode-btn active" id="btnModeATT">‚ö° ATTAQUE</button>
            <button class="mode-btn" id="btnModeDEF">üõ°Ô∏è D√âFENSE</button>
        </div>
        
        <!-- FILTER TRIGGER BUTTONS -->
        <div class="filter-trigger">
            <button class="filter-btn" onclick="toggleFilterPanel()">
                üîç Filtres
            </button>
            <button class="reset-btn" onclick="resetFilters()">
                ‚Ü∫ Reset
            </button>
        </div>
        
        <!-- FILTER OVERLAY -->
        <div class="filter-overlay" id="filterOverlay" onclick="closeFilterPanel()"></div>
        
        <!-- FILTER PANEL -->
        <div class="filter-panel" id="filterPanel">
            <h3>üîç Filtres</h3>
            
            <!-- LIEU -->
            <div class="filter-category">
                <div class="filter-category-title">Lieu</div>
                <div class="filter-buttons">
                    <div class="filter-tag" data-filter="lieu" data-value="DOM">üè† Domicile</div>
                    <div class="filter-tag" data-filter="lieu" data-value="EXT">‚úàÔ∏è Ext√©rieur</div>
                </div>
            </div>
            
            <!-- R√âSULTAT -->
            <div class="filter-category">
                <div class="filter-category-title">R√©sultat</div>
                <div class="filter-buttons">
                    <div class="filter-tag" data-filter="resultat" data-value="V">‚úÖ Victoire</div>
                    <div class="filter-tag" data-filter="resultat" data-value="N">ü§ù Nul</div>
                    <div class="filter-tag" data-filter="resultat" data-value="D">‚ùå D√©faite</div>
                </div>
            </div>
            
            <!-- CHAMPIONNAT -->
            <div class="filter-category">
                <div class="filter-category-title">Championnat</div>
                <div class="filter-buttons">
                    <div class="filter-tag" data-filter="championnat" data-value="LNH">üèÜ LNH</div>
                    <div class="filter-tag" data-filter="championnat" data-value="EHF">üåç EHF</div>
                    <div class="filter-tag" data-filter="championnat" data-value="CdF">üèÖ Coupe</div>
                    <div class="filter-tag" data-filter="championnat" data-value="A">‚ö° Amical</div>
                </div>
            </div>
            
            <!-- MATCH -->
            <div class="filter-category">
                <div class="filter-category-title">Match</div>
                <div class="filter-match-list" id="filterMatchList">
                    <!-- Rempli dynamiquement -->
                </div>
            </div>
            
            <!-- MI-TEMPS -->
            <div class="filter-category">
                <div class="filter-category-title">Mi-temps</div>
                <div class="filter-buttons">
                    <div class="filter-tag active" data-filter="mt" data-value="ALL">Tout</div>
                    <div class="filter-tag" data-filter="mt" data-value="MT1">MT1</div>
                    <div class="filter-tag" data-filter="mt" data-value="MT2">MT2</div>
                </div>
            </div>
            
            <!-- PHASE NUM√âRIQUE -->
            <div class="filter-category">
                <div class="filter-category-title">Phase Num√©rique</div>
                <div class="filter-buttons">
                    <div class="filter-tag" data-filter="phNum" data-value="6c6">6c6</div>
                    <div class="filter-tag" data-filter="phNum" data-value="7c6">7c6</div>
                    <div class="filter-tag" data-filter="phNum" data-value="[+]">[+]</div>
                    <div class="filter-tag" data-filter="phNum" data-value="[-]">[-]</div>
                </div>
            </div>
            
            <!-- PHASE JEU ATTAQUE (visible only in ATT mode) -->
            <div class="filter-category" id="filterPhJeuATT">
                <div class="filter-category-title">Phase de Jeu</div>
                <div class="filter-buttons">
                    <div class="filter-tag active" data-filter="phJeuATT" data-value="ALL">Tout</div>
                    <div class="filter-tag" data-filter="phJeuATT" data-value="Att p">Att p</div>
                    <div class="filter-tag" data-filter="phJeuATT" data-value="MdB">MdB</div>
                    <div class="filter-tag" data-filter="phJeuATT" data-value="5-1 Att">5-1 Att</div>
                    <div class="filter-tag" data-filter="phJeuATT" data-value="0-6 Att">0-6 Att</div>
                    <div class="filter-tag" data-filter="phJeuATT" data-value="ATT">ATT</div>
                </div>
            </div>
            
            <!-- PHASE JEU D√âFENSE (visible only in DEF mode) -->
            <div class="filter-category hidden" id="filterPhJeuDEF">
                <div class="filter-category-title">Phase de Jeu</div>
                <div class="filter-buttons">
                    <div class="filter-tag active" data-filter="phJeuDEF" data-value="ALL">Tout</div>
                    <div class="filter-tag" data-filter="phJeuDEF" data-value="Def p">Def p</div>
                    <div class="filter-tag" data-filter="phJeuDEF" data-value="Rpl">Rpl</div>
                    <div class="filter-tag" data-filter="phJeuDEF" data-value="5-1 Def">5-1 Def</div>
                    <div class="filter-tag" data-filter="phJeuDEF" data-value="0-6 Def">0-6 Def</div>
                    <div class="filter-tag" data-filter="phJeuDEF" data-value="DEF">DEF</div>
                </div>
            </div>
            
            <!-- STATS -->
            <div class="filter-category">
                <div class="filter-category-title">Stats</div>
                <div class="filter-buttons">
                    <div class="filter-tag" data-filter="stats" data-value="But">üéØ But</div>
                    <div class="filter-tag" data-filter="stats" data-value="Tir">üéØ Tir</div>
                    <div class="filter-tag" data-filter="stats" data-value="Shoot">üéØ Shoot</div>
                    <div class="filter-tag" data-filter="stats" data-value="N">üõ°Ô∏è N</div>
                    <div class="filter-tag" data-filter="stats" data-value="Pdb">‚ùå Pdb</div>
                    <div class="filter-tag" data-filter="stats" data-value="Py obt">üü° Py obt</div>
                    <div class="filter-tag" data-filter="stats" data-value="2'">üü® 2'</div>
                </div>
            </div>
            
            <!-- POSTE -->
            <div class="filter-category">
                <div class="filter-category-title">Poste</div>
                <div class="filter-buttons">
                    <div class="filter-tag" data-filter="poste" data-value="ALG">ALG</div>
                    <div class="filter-tag" data-filter="poste" data-value="ARG">ARG</div>
                    <div class="filter-tag" data-filter="poste" data-value="DC">DC</div>
                    <div class="filter-tag" data-filter="poste" data-value="ARD">ARD</div>
                    <div class="filter-tag" data-filter="poste" data-value="ALD">ALD</div>
                    <div class="filter-tag" data-filter="poste" data-value="PIV">PIV</div>
                    <div class="filter-tag" data-filter="poste" data-value="DaD">DaD</div>
                    <div class="filter-tag" data-filter="poste" data-value="GB">GB</div>
                    <div class="filter-tag" data-filter="poste" data-value="PY">PY</div>
                </div>
            </div>
        </div>
        
        <!-- NAVIGATION TABS -->
        <div class="view-tabs">
            <button class="tab-btn active" data-view="equipe">üë• √âquipe</button>
            <button class="tab-btn" data-view="jeu">‚ö° Jeu</button>
            <button class="tab-btn" data-view="num">üî¢ Num</button>
            <button class="tab-btn" data-view="match">üìÖ Match</button>
            <button class="tab-btn" data-view="indiv">üë§ Indiv</button>
            <button class="tab-btn" data-view="vs">‚öîÔ∏è VS</button>
        </div>
        
        <!-- VIEW CONTAINER -->
        <div id="viewContainer">
            
            <!-- VIEW EQUIPE -->
            <div class="view-content active" data-view="equipe">
                
                <!-- TABLE ACCORDION 1: GLOBAL -->
                <div class="table-accordion">
                    <div class="accordion-header" onclick="toggleAccordion('global')">
                        <span class="accordion-icon">‚ñ∂</span>
                        <span class="accordion-title">üåê GLOBAL</span>
                        <span class="accordion-stats" id="globalStats">-</span>
                    </div>
                    <div class="accordion-content" id="accordion-global">
                        <table>
                            <thead>
                                <tr>
                                    <th>Joueur</th>
                                    <th data-column="1" data-sort-type="shooting">Shoot</th>
                                    <th data-column="2" data-sort-type="shooting">HPY</th>
                                    <th data-column="3" data-sort-type="shooting">Py</th>
                                    <th data-column="4" data-sort-type="simple">Py obt</th>
                                    <th data-column="5" data-sort-type="simple">2' obt</th>
                                    <th data-column="6" data-sort-type="simple">Pdb</th>
                                    <th data-column="7" data-sort-type="simple">N</th>
                                    <th data-column="8" data-sort-type="simple">Passe</th>
                                </tr>
                            </thead>
                            <tbody id="tableGlobal">
                                <tr>
                                    <td colspan="9" style="text-align: center; color: var(--grey);">
                                        Chargement...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- TABLE ACCORDION 2: HPY -->
                <div class="table-accordion">
                    <div class="accordion-header" onclick="toggleAccordion('hpy')">
                        <span class="accordion-icon">‚ñ∂</span>
                        <span class="accordion-title">üéØ HPY - Hors P√©nalit√©</span>
                        <span class="accordion-stats" id="hpyStats">-</span>
                    </div>
                    <div class="accordion-content" id="accordion-hpy">
                        <table>
                            <thead>
                                <tr>
                                    <th>Joueur</th>
                                    <th data-column="1" data-sort-type="shooting">Shoot HPY</th>
                                </tr>
                            </thead>
                            <tbody id="tableHPY">
                                <tr>
                                    <td colspan="2" style="text-align: center; color: var(--grey);">
                                        Chargement...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- TABLE ACCORDION 3: PY -->
                <div class="table-accordion">
                    <div class="accordion-header" onclick="toggleAccordion('py')">
                        <span class="accordion-icon">‚ñ∂</span>
                        <span class="accordion-title">üü° PY - P√©nalit√©s</span>
                        <span class="accordion-stats" id="pyStats">-</span>
                    </div>
                    <div class="accordion-content" id="accordion-py">
                        <table>
                            <thead>
                                <tr>
                                    <th>Joueur</th>
                                    <th data-column="1" data-sort-type="shooting">PY</th>
                                </tr>
                            </thead>
                            <tbody id="tablePY">
                                <tr>
                                    <td colspan="2" style="text-align: center; color: var(--grey);">
                                        Chargement...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- TABLE ACCORDION 4: SANCTION OBT -->
                <div class="table-accordion">
                    <div class="accordion-header" onclick="toggleAccordion('sanction')">
                        <span class="accordion-icon">‚ñ∂</span>
                        <span class="accordion-title">üü® SANCTION OBT</span>
                        <span class="accordion-stats" id="sanctionStats">-</span>
                    </div>
                    <div class="accordion-content" id="accordion-sanction">
                        <table>
                            <thead>
                                <tr>
                                    <th>Joueur</th>
                                    <th data-column="1" data-sort-type="simple">Py obt</th>
                                    <th data-column="2" data-sort-type="simple">2' obt</th>
                                    <th data-column="3" data-sort-type="simple">Total</th>
                                </tr>
                            </thead>
                            <tbody id="tableSanction">
                                <tr>
                                    <td colspan="4" style="text-align: center; color: var(--grey);">
                                        Chargement...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- TABLE ACCORDION 5: RELATION -->
                <div class="table-accordion">
                    <div class="accordion-header" onclick="toggleAccordion('relation')">
                        <span class="accordion-icon">‚ñ∂</span>
                        <span class="accordion-title">ü§ù RELATION - Passes</span>
                        <span class="accordion-stats" id="relationStats">-</span>
                    </div>
                    <div class="accordion-content" id="accordion-relation">
                        <table>
                            <thead>
                                <tr>
                                    <th>Joueur</th>
                                    <th data-column="1" data-sort-type="simple">PIV</th>
                                    <th data-column="2" data-sort-type="simple">ALG</th>
                                    <th data-column="3" data-sort-type="simple">ALD</th>
                                </tr>
                            </thead>
                            <tbody id="tableRelation">
                                <tr>
                                    <td colspan="4" style="text-align: center; color: var(--grey);">
                                        Chargement...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- TABLE ACCORDION 6: PDB -->
                <div class="table-accordion">
                    <div class="accordion-header" onclick="toggleAccordion('pdb')">
                        <span class="accordion-icon">‚ñ∂</span>
                        <span class="accordion-title">‚ùå PDB - Pertes de Balle</span>
                        <span class="accordion-stats" id="pdbStats">-</span>
                    </div>
                    <div class="accordion-content" id="accordion-pdb">
                        <table>
                            <thead>
                                <tr>
                                    <th>Joueur</th>
                                    <th data-column="1" data-sort-type="simple">Pdb</th>
                                </tr>
                            </thead>
                            <tbody id="tablePdb">
                                <tr>
                                    <td colspan="2" style="text-align: center; color: var(--grey);">
                                        Chargement...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- TABLE ACCORDION 7: NEUTRALIS√â -->
                <div class="table-accordion">
                    <div class="accordion-header" onclick="toggleAccordion('neutralise')">
                        <span class="accordion-icon">‚ñ∂</span>
                        <span class="accordion-title">üõ°Ô∏è NEUTRALIS√â</span>
                        <span class="accordion-stats" id="neutraliseStats">-</span>
                    </div>
                    <div class="accordion-content" id="accordion-neutralise">
                        <table>
                            <thead>
                                <tr>
                                    <th>Joueur</th>
                                    <th data-column="1" data-sort-type="simple">N</th>
                                </tr>
                            </thead>
                            <tbody id="tableNeutralise">
                                <tr>
                                    <td colspan="2" style="text-align: center; color: var(--grey);">
                                        Chargement...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
            </div>
            
            <!-- VIEW JEU -->
            <div class="view-content" data-view="jeu">
                
                <!-- TABLE ACCORDION 1: GLOBAL -->
                <div class="table-accordion">
                    <div class="accordion-header" onclick="toggleAccordion('jeu-global')">
                        <span class="accordion-icon">‚ñ∂</span>
                        <span class="accordion-title">üåê GLOBAL</span>
                        <span class="accordion-stats" id="jeuGlobalStats">-</span>
                    </div>
                    <div class="accordion-content" id="accordion-jeu-global">
                        <table>
                            <thead>
                                <tr>
                                    <th>Phase</th>
                                    <th data-column="1" data-sort-type="shooting">Shoot</th>
                                    <th data-column="2" data-sort-type="shooting">HPY</th>
                                    <th data-column="3" data-sort-type="shooting">Py</th>
                                    <th data-column="4" data-sort-type="simple">Py obt</th>
                                    <th data-column="5" data-sort-type="simple">2' obt</th>
                                    <th data-column="6" data-sort-type="simple">Pdb</th>
                                    <th data-column="7" data-sort-type="simple">N</th>
                                    <th data-column="8" data-sort-type="simple">Passe</th>
                                </tr>
                            </thead>
                            <tbody id="tableJeuGlobal">
                                <tr>
                                    <td colspan="9" style="text-align: center; color: var(--grey);">
                                        Chargement...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- TABLE ACCORDION 2: HPY -->
                <div class="table-accordion">
                    <div class="accordion-header" onclick="toggleAccordion('jeu-hpy')">
                        <span class="accordion-icon">‚ñ∂</span>
                        <span class="accordion-title">üéØ HPY - Hors P√©nalit√©</span>
                        <span class="accordion-stats" id="jeuHpyStats">-</span>
                    </div>
                    <div class="accordion-content" id="accordion-jeu-hpy">
                        <table>
                            <thead>
                                <tr>
                                    <th>Phase</th>
                                    <th data-column="1" data-sort-type="shooting">Shoot HPY</th>
                                </tr>
                            </thead>
                            <tbody id="tableJeuHPY">
                                <tr>
                                    <td colspan="2" style="text-align: center; color: var(--grey);">
                                        Chargement...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- TABLE ACCORDION 3: PY -->
                <div class="table-accordion">
                    <div class="accordion-header" onclick="toggleAccordion('jeu-py')">
                        <span class="accordion-icon">‚ñ∂</span>
                        <span class="accordion-title">üü° PY - P√©nalit√©s</span>
                        <span class="accordion-stats" id="jeuPyStats">-</span>
                    </div>
                    <div class="accordion-content" id="accordion-jeu-py">
                        <table>
                            <thead>
                                <tr>
                                    <th>Phase</th>
                                    <th data-column="1" data-sort-type="shooting">PY</th>
                                </tr>
                            </thead>
                            <tbody id="tableJeuPY">
                                <tr>
                                    <td colspan="2" style="text-align: center; color: var(--grey);">
                                        Chargement...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- TABLE ACCORDION 4: SANCTION OBT -->
                <div class="table-accordion">
                    <div class="accordion-header" onclick="toggleAccordion('jeu-sanction')">
                        <span class="accordion-icon">‚ñ∂</span>
                        <span class="accordion-title">üü® SANCTION OBT</span>
                        <span class="accordion-stats" id="jeuSanctionStats">-</span>
                    </div>
                    <div class="accordion-content" id="accordion-jeu-sanction">
                        <table>
                            <thead>
                                <tr>
                                    <th>Phase</th>
                                    <th data-column="1" data-sort-type="simple">Py obt</th>
                                    <th data-column="2" data-sort-type="simple">2' obt</th>
                                    <th data-column="3" data-sort-type="simple">Total</th>
                                </tr>
                            </thead>
                            <tbody id="tableJeuSanction">
                                <tr>
                                    <td colspan="4" style="text-align: center; color: var(--grey);">
                                        Chargement...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- TABLE ACCORDION 5: RELATION -->
                <div class="table-accordion">
                    <div class="accordion-header" onclick="toggleAccordion('jeu-relation')">
                        <span class="accordion-icon">‚ñ∂</span>
                        <span class="accordion-title">ü§ù RELATION - Passes</span>
                        <span class="accordion-stats" id="jeuRelationStats">-</span>
                    </div>
                    <div class="accordion-content" id="accordion-jeu-relation">
                        <table>
                            <thead>
                                <tr>
                                    <th>Phase</th>
                                    <th data-column="1" data-sort-type="simple">PIV</th>
                                    <th data-column="2" data-sort-type="simple">ALG</th>
                                    <th data-column="3" data-sort-type="simple">ALD</th>
                                </tr>
                            </thead>
                            <tbody id="tableJeuRelation">
                                <tr>
                                    <td colspan="4" style="text-align: center; color: var(--grey);">
                                        Chargement...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- TABLE ACCORDION 6: PDB -->
                <div class="table-accordion">
                    <div class="accordion-header" onclick="toggleAccordion('jeu-pdb')">
                        <span class="accordion-icon">‚ñ∂</span>
                        <span class="accordion-title">‚ùå PDB - Pertes de Balle</span>
                        <span class="accordion-stats" id="jeuPdbStats">-</span>
                    </div>
                    <div class="accordion-content" id="accordion-jeu-pdb">
                        <table>
                            <thead>
                                <tr>
                                    <th>Phase</th>
                                    <th data-column="1" data-sort-type="simple">Pdb</th>
                                </tr>
                            </thead>
                            <tbody id="tableJeuPdb">
                                <tr>
                                    <td colspan="2" style="text-align: center; color: var(--grey);">
                                        Chargement...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- TABLE ACCORDION 7: NEUTRALIS√â -->
                <div class="table-accordion">
                    <div class="accordion-header" onclick="toggleAccordion('jeu-neutralise')">
                        <span class="accordion-icon">‚ñ∂</span>
                        <span class="accordion-title">üõ°Ô∏è NEUTRALIS√â</span>
                        <span class="accordion-stats" id="jeuNeutraliseStats">-</span>
                    </div>
                    <div class="accordion-content" id="accordion-jeu-neutralise">
                        <table>
                            <thead>
                                <tr>
                                    <th>Phase</th>
                                    <th data-column="1" data-sort-type="simple">N</th>
                                </tr>
                            </thead>
                            <tbody id="tableJeuNeutralise">
                                <tr>
                                    <td colspan="2" style="text-align: center; color: var(--grey);">
                                        Chargement...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
            </div>
            
            <!-- VIEW NUM -->
            <div class="view-content" data-view="num">
                
                <!-- TABLE ACCORDION 1: GLOBAL -->
                <div class="table-accordion">
                    <div class="accordion-header" onclick="toggleAccordion('num-global')">
                        <span class="accordion-icon">‚ñ∂</span>
                        <span class="accordion-title">üåê GLOBAL</span>
                        <span class="accordion-stats" id="numGlobalStats">-</span>
                    </div>
                    <div class="accordion-content" id="accordion-num-global">
                        <table>
                            <thead>
                                <tr>
                                    <th>Phase Num</th>
                                    <th data-column="1" data-sort-type="shooting">Shoot</th>
                                    <th data-column="2" data-sort-type="shooting">HPY</th>
                                    <th data-column="3" data-sort-type="shooting">Py</th>
                                    <th data-column="4" data-sort-type="simple">Py obt</th>
                                    <th data-column="5" data-sort-type="simple">2' obt</th>
                                    <th data-column="6" data-sort-type="simple">Pdb</th>
                                    <th data-column="7" data-sort-type="simple">N</th>
                                    <th data-column="8" data-sort-type="simple">Passe</th>
                                </tr>
                            </thead>
                            <tbody id="tableNumGlobal">
                                <tr>
                                    <td colspan="9" style="text-align: center; color: var(--grey);">
                                        Chargement...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- TABLE ACCORDION 2: HPY -->
                <div class="table-accordion">
                    <div class="accordion-header" onclick="toggleAccordion('num-hpy')">
                        <span class="accordion-icon">‚ñ∂</span>
                        <span class="accordion-title">üéØ HPY - Hors P√©nalit√©</span>
                        <span class="accordion-stats" id="numHpyStats">-</span>
                    </div>
                    <div class="accordion-content" id="accordion-num-hpy">
                        <table>
                            <thead>
                                <tr>
                                    <th>Phase Num</th>
                                    <th data-column="1" data-sort-type="shooting">Shoot HPY</th>
                                </tr>
                            </thead>
                            <tbody id="tableNumHPY">
                                <tr>
                                    <td colspan="2" style="text-align: center; color: var(--grey);">
                                        Chargement...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- TABLE ACCORDION 3: PY -->
                <div class="table-accordion">
                    <div class="accordion-header" onclick="toggleAccordion('num-py')">
                        <span class="accordion-icon">‚ñ∂</span>
                        <span class="accordion-title">üü° PY - P√©nalit√©s</span>
                        <span class="accordion-stats" id="numPyStats">-</span>
                    </div>
                    <div class="accordion-content" id="accordion-num-py">
                        <table>
                            <thead>
                                <tr>
                                    <th>Phase Num</th>
                                    <th data-column="1" data-sort-type="shooting">PY</th>
                                </tr>
                            </thead>
                            <tbody id="tableNumPY">
                                <tr>
                                    <td colspan="2" style="text-align: center; color: var(--grey);">
                                        Chargement...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- TABLE ACCORDION 4: SANCTION OBT -->
                <div class="table-accordion">
                    <div class="accordion-header" onclick="toggleAccordion('num-sanction')">
                        <span class="accordion-icon">‚ñ∂</span>
                        <span class="accordion-title">üü® SANCTION OBT</span>
                        <span class="accordion-stats" id="numSanctionStats">-</span>
                    </div>
                    <div class="accordion-content" id="accordion-num-sanction">
                        <table>
                            <thead>
                                <tr>
                                    <th>Phase Num</th>
                                    <th data-column="1" data-sort-type="simple">Py obt</th>
                                    <th data-column="2" data-sort-type="simple">2' obt</th>
                                    <th data-column="3" data-sort-type="simple">Total</th>
                                </tr>
                            </thead>
                            <tbody id="tableNumSanction">
                                <tr>
                                    <td colspan="4" style="text-align: center; color: var(--grey);">
                                        Chargement...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- TABLE ACCORDION 5: RELATION -->
                <div class="table-accordion">
                    <div class="accordion-header" onclick="toggleAccordion('num-relation')">
                        <span class="accordion-icon">‚ñ∂</span>
                        <span class="accordion-title">ü§ù RELATION - Passes</span>
                        <span class="accordion-stats" id="numRelationStats">-</span>
                    </div>
                    <div class="accordion-content" id="accordion-num-relation">
                        <table>
                            <thead>
                                <tr>
                                    <th>Phase Num</th>
                                    <th data-column="1" data-sort-type="simple">PIV</th>
                                    <th data-column="2" data-sort-type="simple">ALG</th>
                                    <th data-column="3" data-sort-type="simple">ALD</th>
                                </tr>
                            </thead>
                            <tbody id="tableNumRelation">
                                <tr>
                                    <td colspan="4" style="text-align: center; color: var(--grey);">
                                        Chargement...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- TABLE ACCORDION 6: PDB -->
                <div class="table-accordion">
                    <div class="accordion-header" onclick="toggleAccordion('num-pdb')">
                        <span class="accordion-icon">‚ñ∂</span>
                        <span class="accordion-title">‚ùå PDB - Pertes de Balle</span>
                        <span class="accordion-stats" id="numPdbStats">-</span>
                    </div>
                    <div class="accordion-content" id="accordion-num-pdb">
                        <table>
                            <thead>
                                <tr>
                                    <th>Phase Num</th>
                                    <th data-column="1" data-sort-type="simple">Pdb</th>
                                </tr>
                            </thead>
                            <tbody id="tableNumPdb">
                                <tr>
                                    <td colspan="2" style="text-align: center; color: var(--grey);">
                                        Chargement...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- TABLE ACCORDION 7: NEUTRALIS√â -->
                <div class="table-accordion">
                    <div class="accordion-header" onclick="toggleAccordion('num-neutralise')">
                        <span class="accordion-icon">‚ñ∂</span>
                        <span class="accordion-title">üõ°Ô∏è NEUTRALIS√â</span>
                        <span class="accordion-stats" id="numNeutraliseStats">-</span>
                    </div>
                    <div class="accordion-content" id="accordion-num-neutralise">
                        <table>
                            <thead>
                                <tr>
                                    <th>Phase Num</th>
                                    <th data-column="1" data-sort-type="simple">N</th>
                                </tr>
                            </thead>
                            <tbody id="tableNumNeutralise">
                                <tr>
                                    <td colspan="2" style="text-align: center; color: var(--grey);">
                                        Chargement...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
            </div>
            
            <!-- VIEW MATCH -->
            <div class="view-content" data-view="match">
                
                <!-- TABLE ACCORDION 1: GLOBAL -->
                <div class="table-accordion">
                    <div class="accordion-header" onclick="toggleAccordion('match-global')">
                        <span class="accordion-icon">‚ñ∂</span>
                        <span class="accordion-title">üåê GLOBAL</span>
                        <span class="accordion-stats" id="matchGlobalStats">-</span>
                    </div>
                    <div class="accordion-content" id="accordion-match-global">
                        <table>
                            <thead>
                                <tr>
                                    <th>Match</th>
                                    <th data-column="1" data-sort-type="shooting">Shoot</th>
                                    <th data-column="2" data-sort-type="shooting">HPY</th>
                                    <th data-column="3" data-sort-type="shooting">Py</th>
                                    <th data-column="4" data-sort-type="simple">Py obt</th>
                                    <th data-column="5" data-sort-type="simple">2' obt</th>
                                    <th data-column="6" data-sort-type="simple">Pdb</th>
                                    <th data-column="7" data-sort-type="simple">N</th>
                                    <th data-column="8" data-sort-type="simple">Passe</th>
                                </tr>
                            </thead>
                            <tbody id="tableMatchGlobal">
                                <tr>
                                    <td colspan="9" style="text-align: center; color: var(--grey);">
                                        Chargement...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- TABLE ACCORDION 2: HPY -->
                <div class="table-accordion">
                    <div class="accordion-header" onclick="toggleAccordion('match-hpy')">
                        <span class="accordion-icon">‚ñ∂</span>
                        <span class="accordion-title">üéØ HPY - Hors P√©nalit√©</span>
                        <span class="accordion-stats" id="matchHpyStats">-</span>
                    </div>
                    <div class="accordion-content" id="accordion-match-hpy">
                        <table>
                            <thead>
                                <tr>
                                    <th>Match</th>
                                    <th data-column="1" data-sort-type="shooting">Shoot HPY</th>
                                </tr>
                            </thead>
                            <tbody id="tableMatchHPY">
                                <tr>
                                    <td colspan="2" style="text-align: center; color: var(--grey);">
                                        Chargement...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- TABLE ACCORDION 3: PY -->
                <div class="table-accordion">
                    <div class="accordion-header" onclick="toggleAccordion('match-py')">
                        <span class="accordion-icon">‚ñ∂</span>
                        <span class="accordion-title">üü° PY - P√©nalit√©s</span>
                        <span class="accordion-stats" id="matchPyStats">-</span>
                    </div>
                    <div class="accordion-content" id="accordion-match-py">
                        <table>
                            <thead>
                                <tr>
                                    <th>Match</th>
                                    <th data-column="1" data-sort-type="shooting">PY</th>
                                </tr>
                            </thead>
                            <tbody id="tableMatchPY">
                                <tr>
                                    <td colspan="2" style="text-align: center; color: var(--grey);">
                                        Chargement...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- TABLE ACCORDION 4: SANCTION OBT -->
                <div class="table-accordion">
                    <div class="accordion-header" onclick="toggleAccordion('match-sanction')">
                        <span class="accordion-icon">‚ñ∂</span>
                        <span class="accordion-title">üü® SANCTION OBT</span>
                        <span class="accordion-stats" id="matchSanctionStats">-</span>
                    </div>
                    <div class="accordion-content" id="accordion-match-sanction">
                        <table>
                            <thead>
                                <tr>
                                    <th>Match</th>
                                    <th data-column="1" data-sort-type="simple">Py obt</th>
                                    <th data-column="2" data-sort-type="simple">2' obt</th>
                                    <th data-column="3" data-sort-type="simple">Total</th>
                                </tr>
                            </thead>
                            <tbody id="tableMatchSanction">
                                <tr>
                                    <td colspan="4" style="text-align: center; color: var(--grey);">
                                        Chargement...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- TABLE ACCORDION 5: RELATION -->
                <div class="table-accordion">
                    <div class="accordion-header" onclick="toggleAccordion('match-relation')">
                        <span class="accordion-icon">‚ñ∂</span>
                        <span class="accordion-title">ü§ù RELATION - Passes</span>
                        <span class="accordion-stats" id="matchRelationStats">-</span>
                    </div>
                    <div class="accordion-content" id="accordion-match-relation">
                        <table>
                            <thead>
                                <tr>
                                    <th>Match</th>
                                    <th data-column="1" data-sort-type="simple">PIV</th>
                                    <th data-column="2" data-sort-type="simple">ALG</th>
                                    <th data-column="3" data-sort-type="simple">ALD</th>
                                </tr>
                            </thead>
                            <tbody id="tableMatchRelation">
                                <tr>
                                    <td colspan="4" style="text-align: center; color: var(--grey);">
                                        Chargement...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- TABLE ACCORDION 6: PDB -->
                <div class="table-accordion">
                    <div class="accordion-header" onclick="toggleAccordion('match-pdb')">
                        <span class="accordion-icon">‚ñ∂</span>
                        <span class="accordion-title">‚ùå PDB - Pertes de Balle</span>
                        <span class="accordion-stats" id="matchPdbStats">-</span>
                    </div>
                    <div class="accordion-content" id="accordion-match-pdb">
                        <table>
                            <thead>
                                <tr>
                                    <th>Match</th>
                                    <th data-column="1" data-sort-type="simple">Pdb</th>
                                </tr>
                            </thead>
                            <tbody id="tableMatchPdb">
                                <tr>
                                    <td colspan="2" style="text-align: center; color: var(--grey);">
                                        Chargement...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- TABLE ACCORDION 7: NEUTRALIS√â -->
                <div class="table-accordion">
                    <div class="accordion-header" onclick="toggleAccordion('match-neutralise')">
                        <span class="accordion-icon">‚ñ∂</span>
                        <span class="accordion-title">üõ°Ô∏è NEUTRALIS√â</span>
                        <span class="accordion-stats" id="matchNeutraliseStats">-</span>
                    </div>
                    <div class="accordion-content" id="accordion-match-neutralise">
                        <table>
                            <thead>
                                <tr>
                                    <th>Match</th>
                                    <th data-column="1" data-sort-type="simple">N</th>
                                </tr>
                            </thead>
                            <tbody id="tableMatchNeutralise">
                                <tr>
                                    <td colspan="2" style="text-align: center; color: var(--grey);">
                                        Chargement...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
            </div>
            
            <!-- VIEW INDIV -->
            <div class="view-content" data-view="indiv">
                
                <!-- Search bar -->
                <div style="padding: 1rem; display: flex; gap: 1rem; align-items: center;">
                    <input 
                        type="text" 
                        id="playerSearch" 
                        placeholder="üîç Rechercher un joueur..."
                        style="flex: 1; padding: 0.75rem 1rem; border: 1px solid var(--grey-light); border-radius: 8px; background: var(--dark-light); color: var(--white); font-family: inherit;"
                    >
                </div>
                
                <!-- Player cards grid by position -->
                <div id="playerCardsContainer" style="padding: 1rem;"></div>
                
                <!-- Player detail panel (hidden by default) -->
                <div id="playerDetailPanel" class="player-detail-panel hidden">
                    <div class="detail-header">
                        <button onclick="closePlayerDetail()" class="btn-back">‚Üê Retour</button>
                        <button onclick="closePlayerDetail()" class="btn-close">‚úï</button>
                    </div>
                    <div class="detail-player-info" id="detailPlayerInfo"></div>
                    <div class="detail-tabs">
                        <button class="detail-tab active" data-tab="match" onclick="switchPlayerTab('match')">MATCH</button>
                        <button class="detail-tab" data-tab="jeu" onclick="switchPlayerTab('jeu')">JEU</button>
                        <button class="detail-tab" data-tab="num" onclick="switchPlayerTab('num')">NUM</button>
                    </div>
                    <div id="detailTableContainer"></div>
                </div>
                
            </div>
            
            <!-- VIEW VS -->
            <div class="view-content" data-view="vs">
                <p style="color: var(--grey); text-align: center; padding: 3rem;">
                    üöß Vue "VS" en cours de d√©veloppement
                </p>
            </div>
            
        </div>
    </div>
    
    <script>
        // ============================================
        // INDEXEDDB NATIVE (sans Dexie)
        // ============================================
        let db;
        let dbReady = null; // Promise pour attendre l'ouverture
        
        function openDB() {
            if (dbReady) return dbReady; // √âviter double ouverture
            
            dbReady = new Promise((resolve, reject) => {
                const request = indexedDB.open('HandballAnalytics', 10);
                
                request.onerror = () => reject(request.error);
                
                request.onsuccess = () => {
                    db = request.result;
                    console.log('‚úÖ Database opened successfully');
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const database = event.target.result;
                    
                    // Supprimer anciennes stores si existent
                    if (database.objectStoreNames.contains('raw_data')) {
                        database.deleteObjectStore('raw_data');
                    }
                    if (database.objectStoreNames.contains('teams')) {
                        database.deleteObjectStore('teams');
                    }
                    
                    // Cr√©er nouvelles stores
                    const rawStore = database.createObjectStore('raw_data', { keyPath: 'id', autoIncrement: true });
                    rawStore.createIndex('hash', 'hash', { unique: false });
                    rawStore.createIndex('match', 'match', { unique: false });
                    rawStore.createIndex('team_att', 'team_att', { unique: false });
                    rawStore.createIndex('team_def', 'team_def', { unique: false });
                    
                    database.createObjectStore('teams', { keyPath: 'name' });
                    
                    console.log('‚úÖ Database structure created');
                };
            });
            
            return dbReady;
        }
        
        async function addRawData(data) {
            await dbReady; // Attendre que DB soit pr√™te
            if (!db) throw new Error('Database not opened');
            return new Promise((resolve, reject) => {
                const tx = db.transaction(['raw_data'], 'readwrite');
                const store = tx.objectStore('raw_data');
                const request = store.add(data);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        
        async function getRawDataByHash(hash) {
            await dbReady;
            if (!db) return null;
            return new Promise((resolve, reject) => {
                const tx = db.transaction(['raw_data'], 'readonly');
                const store = tx.objectStore('raw_data');
                const index = store.index('hash');
                const request = index.get(hash);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        
        async function getRawDataByTeam(teamName) {
            await dbReady;
            if (!db) return [];
            return new Promise((resolve, reject) => {
                const tx = db.transaction(['raw_data'], 'readonly');
                const store = tx.objectStore('raw_data');
                const results = [];
                const request = store.openCursor();
                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        const item = cursor.value;
                        if (item.team_att === teamName || item.team_def === teamName) {
                            results.push(item);
                        }
                        cursor.continue();
                    } else {
                        resolve(results);
                    }
                };
                request.onerror = () => reject(request.error);
            });
        }
        
        async function countRawData() {
            await dbReady;
            if (!db) return 0;
            return new Promise((resolve, reject) => {
                const tx = db.transaction(['raw_data'], 'readonly');
                const store = tx.objectStore('raw_data');
                const request = store.count();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        
        async function addTeam(team) {
            await dbReady;
            if (!db) throw new Error('Database not opened');
            return new Promise((resolve, reject) => {
                const tx = db.transaction(['teams'], 'readwrite');
                const store = tx.objectStore('teams');
                const request = store.put(team);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        
        async function getAllTeams() {
            await dbReady;
            if (!db) return [];
            return new Promise((resolve, reject) => {
                const tx = db.transaction(['teams'], 'readonly');
                const store = tx.objectStore('teams');
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        
        // ============================================
        // STATE
        // ============================================
        let currentTeam = null;
        let currentMode = 'ATT';
        let allTeams = [];
        let allTeamData = [];
        
        // FILTER STATE
        const filters = {
            matches: [], // Multi-select : liste des matchs s√©lectionn√©s (vide = tous)
            mt: 'ALL', // Single : MT1, MT2, ALL
            lieu: [], // Multi-select : DOM, EXT (vide = tous)
            resultat: [], // Multi-select : V, N, D (vide = tous)
            phNum: [], // Multi-select : 6c6, 7c6, [+], [-] (vide = tous)
            championnat: [], // Multi-select : LNH, EHF, CdF, A (vide = tous)
            stats: [], // Multi-select : But, Tir, Shoot, N, Pdb, Py obt, 2' (vide = tous)
            poste: [], // Multi-select : ALG, ARG, DC, ARD, ALD, PIV, DaD, GB, PY (vide = tous)
            phJeuATT: 'ALL', // Single (ATT only) : Att p, MdB, 5-1 Att, 0-6 Att, ATT, ALL
            phJeuDEF: 'ALL'  // Single (DEF only) : Def p, Rpl, 5-1 Def, 0-6 Def, DEF, ALL
        };
        
        // ============================================
        // FILTER LOGIC
        // ============================================
        
        // CALCULATE MATCH SCORES
        function calculateMatchScores(data) {
            const matchScores = {};
            
            data.forEach(row => {
                const match = row.raw['[M] rencontre'] || '';
                if (!match) return;
                
                if (!matchScores[match]) {
                    matchScores[match] = { teamA: 0, teamB: 0, teams: {} };
                    
                    // Parse "J14 Equipe A-Equipe B"
                    const parts = match.split(' ');
                    if (parts.length >= 2) {
                        const teams = parts.slice(1).join(' ').split('-');
                        matchScores[match].teams.A = teams[0]?.trim();
                        matchScores[match].teams.B = teams[1]?.trim();
                    }
                }
                
                // Compter TOUS les buts : HPY (|a00| but) + PY (|a01| but py)
                const teamAtt = row.raw['#01 Attaque'] || '';
                const colButHPY = row.raw['|a00| but'] || '';
                const colButPY = row.raw['|a01| but py'] || '';
                
                // But HPY
                if (colButHPY && colButHPY !== 'x' && teamAtt) {
                    if (teamAtt === matchScores[match].teams.A) {
                        matchScores[match].teamA++;
                    } else if (teamAtt === matchScores[match].teams.B) {
                        matchScores[match].teamB++;
                    }
                }
                
                // But PY
                if (colButPY && colButPY !== 'x' && teamAtt) {
                    if (teamAtt === matchScores[match].teams.A) {
                        matchScores[match].teamA++;
                    } else if (teamAtt === matchScores[match].teams.B) {
                        matchScores[match].teamB++;
                    }
                }
            });
            
            return matchScores;
        }
        
        function applyFilters(data) {
            return data.filter(row => {
                const phase = row.raw[`#03 Phase ${currentTeam}`] || '';
                const teamAtt = row.raw['#01 Attaque'] || '';
                const teamDef = row.raw['#02 D√©fense'] || '';
                const match = row.raw['[M] rencontre'] || '';
                const periode = row.raw['[P] p√©riode'] || '';
                const fEncl = row.raw['#09 F. Encl'] || '';
                const poste = row.raw['#15.1 poste'] || '';
                
                // 1. FILTRE MODE (ATT/DEF) - OBLIGATOIRE
                if (currentMode === 'ATT') {
                    if (teamAtt !== currentTeam) return false;
                    
                    // Mode Attaque : phase doit contenir...
                    const isAttackPhase = 
                        phase.includes('att al') || 
                        phase.includes('att √©tg') || 
                        (phase.includes('mdb') && !phase.includes('rpl')) ||
                        (phase.includes('er') && !phase.includes('rpl')) ||
                        (phase.includes('ca') && !phase.includes('rpl')) ||
                        (phase.includes('py') && !phase.includes('vs')) ||
                        (phase.includes('rebond') && !phase.includes('vs'));
                    
                    if (!isAttackPhase) return false;
                } else {
                    if (teamDef !== currentTeam) return false;
                    
                    // Mode D√©fense : phase doit contenir...
                    const isDefensePhase = 
                        phase.includes('def al') || 
                        phase.includes('def √©tg') || 
                        phase.includes('rpl mdb') ||
                        phase.includes('rpl er') ||
                        phase.includes('rpl ca') ||
                        phase.includes('py vs') ||
                        phase.includes('rebond vs');
                    
                    if (!isDefensePhase) return false;
                }
                
                // 2. FILTRE MATCH (multi-select)
                if (filters.matches.length > 0 && !filters.matches.includes(match)) {
                    return false;
                }
                
                // 3. FILTRE MT (single)
                if (filters.mt !== 'ALL') {
                    if (filters.mt === 'MT1' && !periode.includes('MT1')) return false;
                    if (filters.mt === 'MT2' && !periode.includes('MT2')) return false;
                }
                
                // 4. FILTRE LIEU (multi-select)
                if (filters.lieu.length > 0) {
                    // Parser match format "J14 Equipe A-Equipe B"
                    const parts = match.split(' ');
                    if (parts.length >= 2) {
                        const teams = parts.slice(1).join(' ').split('-');
                        const equipeA = teams[0]?.trim();
                        const equipeB = teams[1]?.trim();
                        
                        const isDom = equipeA === currentTeam;
                        const isExt = equipeB === currentTeam;
                        
                        const matchesFilter = filters.lieu.some(f => {
                            if (f === 'DOM' && isDom) return true;
                            if (f === 'EXT' && isExt) return true;
                            return false;
                        });
                        
                        if (!matchesFilter) return false;
                    }
                }
                
                // 5. FILTRE RESULTAT (multi-select)
                if (filters.resultat.length > 0 && match) {
                    // Calculate scores on-the-fly for this match
                    const matchScores = calculateMatchScores(allTeamData);
                    
                    if (matchScores[match]) {
                        const scores = matchScores[match];
                        const parts = match.split(' ');
                        if (parts.length >= 2) {
                            const teams = parts.slice(1).join(' ').split('-');
                            const equipeA = teams[0]?.trim();
                            const isTeamA = equipeA === currentTeam;
                            
                            const teamScore = isTeamA ? scores.teamA : scores.teamB;
                            const oppScore = isTeamA ? scores.teamB : scores.teamA;
                            
                            let result;
                            if (teamScore > oppScore) result = 'V';
                            else if (teamScore === oppScore) result = 'N';
                            else result = 'D';
                            
                            if (!filters.resultat.includes(result)) return false;
                        }
                    }
                }
                
                // 6. FILTRE PhNum (multi-select)
                if (filters.phNum.length > 0) {
                    const has6c6 = !phase.includes('[+]') && !phase.includes('[-]') && !fEncl.includes('7 c 6');
                    const has7c6 = fEncl.includes('7 c 6');
                    const hasPlus = phase.includes('[+]');
                    const hasMinus = phase.includes('[-]');
                    
                    const matchesFilter = filters.phNum.some(f => {
                        if (f === '6c6' && has6c6) return true;
                        if (f === '7c6' && has7c6) return true;
                        if (f === '[+]' && hasPlus) return true;
                        if (f === '[-]' && hasMinus) return true;
                        return false;
                    });
                    
                    if (!matchesFilter) return false;
                }
                
                // 7. FILTRE CHAMPIONNAT (multi-select)
                if (filters.championnat.length > 0) {
                    const firstChar = match.charAt(0);
                    const matchesFilter = filters.championnat.some(f => {
                        if (f === 'LNH' && firstChar === 'J') return true;
                        if (f === 'EHF' && firstChar === 'E') return true;
                        if (f === 'CdF' && firstChar === 'C') return true;
                        if (f === 'A' && firstChar === 'A') return true;
                        return false;
                    });
                    
                    if (!matchesFilter) return false;
                }
                
                // 8. FILTRE STATS (multi-select)
                if (filters.stats.length > 0) {
                    const colBut = row.raw['|a00| but'] || '';
                    const colTir = row.raw['|a00| tir'] || '';
                    const colNeutral = row.raw['|d09.1| neutralisation'] || '';
                    const colPdb = row.raw['|a18| pdb'] || '';
                    const colPy = row.raw['|a03| py obt'] || '';
                    const col2 = row.raw["|a04| 2' obt"] || '';
                    
                    const matchesFilter = filters.stats.some(f => {
                        if (f === 'But' && colBut) return true;
                        if (f === 'Tir' && colTir && colTir !== 'x' && !colBut) return true;
                        if (f === 'Shoot' && colTir && colTir !== 'x') return true;
                        if (f === 'N' && colNeutral) return true;
                        if (f === 'Pdb' && colPdb) return true;
                        if (f === 'Py obt' && colPy) return true;
                        if (f === "2'" && col2) return true;
                        return false;
                    });
                    
                    if (!matchesFilter) return false;
                }
                
                // 9. FILTRE POSTE (multi-select)
                if (filters.poste.length > 0) {
                    const matchesFilter = filters.poste.some(p => poste.includes(p));
                    if (!matchesFilter) return false;
                }
                
                // 10. FILTRE PhJeuATT (single, ATT only)
                if (currentMode === 'ATT' && filters.phJeuATT !== 'ALL') {
                    if (filters.phJeuATT === 'Att p') {
                        const isAttP = phase.includes('att al') || phase.includes('att √©tg') || (phase.includes('rebond') && !phase.includes('vs'));
                        if (!isAttP) return false;
                    }
                    if (filters.phJeuATT === 'MdB') {
                        const isMdb = (phase.includes('mdb') || phase.includes('er') || phase.includes('ca')) && !phase.includes('rpl') && !phase.includes('vs');
                        if (!isMdb) return false;
                    }
                    if (filters.phJeuATT === '5-1 Att' && !phase.includes('att √©tg')) return false;
                    if (filters.phJeuATT === '0-6 Att' && !phase.includes('att al')) return false;
                    // ATT = tout (d√©j√† filtr√© par le mode)
                }
                
                // 11. FILTRE PhJeuDEF (single, DEF only)
                if (currentMode === 'DEF' && filters.phJeuDEF !== 'ALL') {
                    if (filters.phJeuDEF === 'Def p') {
                        const isDefP = phase.includes('def al') || phase.includes('def √©tg') || phase.includes('rebond vs');
                        if (!isDefP) return false;
                    }
                    if (filters.phJeuDEF === 'Rpl') {
                        const isRpl = phase.includes('rpl mdb') || phase.includes('rpl er') || phase.includes('rpl ca');
                        if (!isRpl) return false;
                    }
                    if (filters.phJeuDEF === '5-1 Def' && !phase.includes('def √©tg')) return false;
                    if (filters.phJeuDEF === '0-6 Def' && !phase.includes('def al')) return false;
                    // DEF = tout (d√©j√† filtr√© par le mode)
                }
                
                return true;
            });
        }
        
        // ============================================================
        // CHARGEMENT AUTO Events.csv via fetch (http://localhost:8000)
        // ============================================================

        function csvHash(text) {
            return CryptoJS.MD5(text).toString();
        }

        function updateDataStatus(msg, isWarning) {
            const el = document.getElementById('dataStatus');
            document.getElementById('dataStatusText').textContent = msg;
            el.classList.remove('hidden');
            el.classList.toggle('warning', !!isWarning);
        }

        async function autoLoadCSV() {
            console.log('‚îÅ‚îÅ‚îÅ autoLoadCSV ‚îÅ‚îÅ‚îÅ');

            // =====================================================
            // ETAPE 1 : TOUJOURS tenter de charger data.js FRAIS
            //           depuis le serveur (bypass cache navigateur)
            // =====================================================
            let freshData = null;
            let fetchOK = false;

            try {
                showLoading('Chargement des donn√©es...');
                // cache-busting : ajoute un timestamp pour forcer le serveur
                const resp = await fetch('data.js?_t=' + Date.now(), { cache: 'no-cache' });
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                const jsText = await resp.text();

                // Extraire le JSON depuis "var HANDBALL_DATA = [...];"
                const match = jsText.match(/var\s+HANDBALL_DATA\s*=\s*(\[[\s\S]*\])\s*;/);
                if (match && match[1]) {
                    freshData = JSON.parse(match[1]);
                    fetchOK = true;
                    console.log('üåê data.js charg√© depuis serveur :', freshData.length, 'lignes');
                } else {
                    throw new Error('Format data.js invalide');
                }
            } catch (err) {
                console.warn('‚ö†Ô∏è Fetch data.js √©chou√© :', err.message);
                fetchOK = false;
            }

            // =====================================================
            // ETAPE 2 : Si fetch OK ‚Üí importer dans IndexedDB
            // =====================================================
            if (fetchOK && freshData && freshData.length > 0) {
                // Calculer un hash pour detecter si les donnees ont change
                const dataHash = CryptoJS.MD5(
                    String(freshData.length) + '|' +
                    JSON.stringify(freshData[0]) + '|' +
                    JSON.stringify(freshData[freshData.length - 1])
                ).toString();

                const storedHash = localStorage.getItem('csv_hash');
                const dbCount = await countRawData();

                console.log('üîë Hash serveur :', dataHash);
                console.log('üîë Hash local   :', storedHash || '(aucun)');
                console.log('üíæ DB lignes    :', dbCount);

                // Donnees identiques ET IndexedDB remplie ‚Üí skip l'import
                if (dataHash === storedHash && dbCount > 0) {
                    const dateStr = localStorage.getItem('csv_date') || '';
                    console.log('‚úÖ Donn√©es identiques ‚Äî skip import');
                    hideLoading();
                    updateDataStatus('üìä Donn√©es √† jour (' + dbCount + ' lignes) ‚Äî MAJ ' + dateStr);
                    return true;
                }

                // Donnees differentes OU DB vide ‚Üí importer
                const reason = !storedHash ? 'premier chargement'
                             : dataHash !== storedHash ? 'nouvelles donn√©es d√©tect√©es'
                             : 'cache local vide';
                console.log('üîÑ IMPORT ‚Äî raison :', reason);
                updateLoading('Import de ' + freshData.length + ' lignes...');

                const result = await parseAndStore(freshData);
                hideLoading();

                // Sauvegarder le hash
                const now = new Date();
                const dateStr = now.toLocaleDateString('fr-FR') + ' ' +
                    now.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
                localStorage.setItem('csv_hash', dataHash);
                localStorage.setItem('csv_date', dateStr);

                const totalInDB = await countRawData();
                console.log('‚úÖ TERMIN√â ‚Äî', result.added, 'nouvelles,', result.skipped, 'existantes, total DB :', totalInDB);

                if (result.added > 0) {
                    showAlert('success', '‚úÖ ' + result.added + ' nouvelles lignes ajout√©es');
                } else {
                    showAlert('info', '‚úÖ Donn√©es √† jour');
                }
                updateDataStatus('üìä ' + totalInDB + ' lignes ‚Äî MAJ ' + dateStr);
                return true;
            }

            // =====================================================
            // ETAPE 3 : HORS LIGNE ‚Äî fallback sur IndexedDB
            // =====================================================
            console.log('üì¥ Mode hors ligne ‚Äî utilisation du cache IndexedDB');
            hideLoading();

            const dbCount = await countRawData();
            if (dbCount > 0) {
                const dateStr = localStorage.getItem('csv_date') || '';
                console.log('‚úÖ Cache IndexedDB :', dbCount, 'lignes');
                updateDataStatus('üì¥ Hors ligne ‚Äî cache (' + dbCount + ' lignes) ‚Äî MAJ ' + dateStr, true);
                return true;
            }

            // Aucune donnee nulle part
            console.warn('‚ùå Aucune donn√©e : pas de r√©seau et pas de cache');
            updateDataStatus('‚ùå Aucune donn√©e ‚Äî connectez-vous √† Internet', true);
            return false;
        }

        // INIT
        window.addEventListener('DOMContentLoaded', async function() {
            try {
                showLoading('Initialisation...');
                await openDB();
                console.log('‚úÖ DB ouverte');

                // Charger automatiquement Events.csv
                const loaded = await autoLoadCSV();

                // Rafraichir l'index des photos depuis le serveur
                await refreshPhotosIndex();

                await loadTeamsFromDB();
                const count = await countRawData();

                if (count > 0) {
                    document.getElementById('dropZone').classList.add('hidden');
                    document.getElementById('teamPage').classList.remove('hidden');
                    renderTeamsNav();
                    if (!loaded) {
                        // fetch √©chou√© mais cache OK
                        const dateStr = localStorage.getItem('csv_date') || '';
                        updateDataStatus('üìä Donn√©es en cache (' + count + ' lignes) ‚Äî MAJ ' + dateStr);
                    }
                }

                setupDragDrop();
                hideLoading();
            } catch (error) {
                console.error('‚ùå Init error:', error);
                showAlert('error', 'Erreur d\'initialisation : ' + error.message);
                hideLoading();
            }
        });
        
        // DRAG & DROP
        function setupDragDrop() {
            const dropZone = document.getElementById('dropZone');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.classList.add('drag-over');
                });
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.classList.remove('drag-over');
                });
            });
            
            dropZone.addEventListener('drop', handleDrop);
        }
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }
        
        // FILE UPLOAD
        document.getElementById('fileInput').addEventListener('change', handleFileInput);
        document.getElementById('fileInputMain').addEventListener('change', handleFileInput);
        
        // FLOATING MENU
        const bubbleMain = document.getElementById('bubbleMain');
        const floatingBubbles = document.getElementById('floatingBubbles');
        const bubbleReset = document.getElementById('bubbleReset');
        
        bubbleMain.addEventListener('click', (e) => {
            e.stopPropagation();
            floatingBubbles.classList.toggle('active');
        });
        
        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.floating-menu')) {
                floatingBubbles.classList.remove('active');
            }
        });
        
        // RELOAD CSV BUTTON (force re-fetch Events.csv)
        document.getElementById('bubbleReload').addEventListener('click', async () => {
            floatingBubbles.classList.remove('active');
            localStorage.removeItem('csv_hash');
            try {
                const ok = await autoLoadCSV();
                if (ok) {
                    await loadTeamsFromDB();
                    renderTeamsNav();
                    if (currentTeam) await loadTeamData();
                    document.getElementById('dropZone').classList.add('hidden');
                    document.getElementById('teamPage').classList.remove('hidden');
                } else {
                    showAlert('error', '‚ùå Events.csv introuvable ‚Äî v√©rifiez que le serveur est lanc√©');
                }
            } catch (e) {
                showAlert('error', '‚ùå Erreur : ' + e.message);
            }
        });

        // RESET BUTTON
        bubbleReset.addEventListener('click', () => {
            if (confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir supprimer toutes les donn√©es ?\n\nCette action est irr√©versible.')) {
                // Nettoyer localStorage
                localStorage.removeItem('csv_hash');
                localStorage.removeItem('csv_date');
                // Delete the database
                const deleteRequest = indexedDB.deleteDatabase('HandballAnalytics');
                
                deleteRequest.onsuccess = () => {
                    console.log('Database deleted successfully');
                    // Reload the page to start fresh
                    window.location.reload();
                };
                
                deleteRequest.onerror = () => {
                    console.error('Error deleting database');
                    showAlert('error', '‚ùå Erreur lors de la suppression des donn√©es');
                };
                
                deleteRequest.onblocked = () => {
                    console.warn('Database deletion blocked');
                    showAlert('warning', '‚ö†Ô∏è Fermez tous les onglets de l\'application et r√©essayez');
                };
            }
        });

        // --- BOUTON PHOTOS ---
        document.getElementById('bubblePhotos').addEventListener('click', () => {
            floatingBubbles.classList.remove('active');
            openPhotoModal();
        });

        function handleFileInput(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
                // Reset input pour permettre re-import du m√™me fichier
                e.target.value = '';
            }
        }
        
        // ==========================================================
        // Publier les donnees vers GitHub via Netlify Function
        // ==========================================================
        async function publishToCloud(data) {
            try {
                updateLoading('Publication vers le cloud...');
                console.log('‚òÅÔ∏è Publication de', data.length, 'lignes vers GitHub...');

                const resp = await fetch('/.netlify/functions/upload-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: data })
                });

                const result = await resp.json();

                if (!resp.ok) {
                    throw new Error(result.error || 'Erreur serveur ' + resp.status);
                }

                console.log('‚úÖ Publication r√©ussie :', result.message);
                return result;

            } catch (err) {
                console.error('‚ùå Publication √©chou√©e :', err.message);
                throw err;
            }
        }

        async function handleFile(file) {
            showLoading('Lecture du fichier...');

            try {
                const ext = file.name.split('.').pop().toLowerCase();
                let data;

                if (ext === 'csv') {
                    data = await parseCSV(file);
                } else {
                    data = await parseExcel(file);
                }

                updateLoading(`Analyse de ${data.length} lignes...`);

                // 1) Stocker localement dans IndexedDB
                const result = await parseAndStore(data);

                if (result.added === 0 && result.skipped > 0) {
                    hideLoading();
                    showAlert('info', `‚ÑπÔ∏è Aucune nouvelle donn√©e : ${result.skipped} doublons d√©j√† pr√©sents`);
                } else {
                    // 2) Publier vers GitHub (Netlify Function)
                    try {
                        const cloudResult = await publishToCloud(data);
                        hideLoading();
                        showAlert('success',
                            `‚úÖ Import + Publication r√©ussis ! ${cloudResult.newCount} nouvelles lignes ‚Üí total ${cloudResult.totalCount}. Netlify red√©ploie dans ~30s.`
                        );
                    } catch (cloudErr) {
                        hideLoading();
                        showAlert('success',
                            `‚úÖ Import local OK (${result.added} lignes). ‚ö†Ô∏è Publication cloud √©chou√©e : ${cloudErr.message}`
                        );
                    }
                }

                await loadTeamsFromDB();
                renderTeamsNav();

                // Reload current team if on team page
                if (currentTeam) {
                    await loadTeamData();
                } else {
                    document.getElementById('dropZone').classList.add('hidden');
                    document.getElementById('teamPage').classList.remove('hidden');
                }

            } catch (error) {
                hideLoading();
                showAlert('error', `‚ùå Erreur : ${error.message}`);
                console.error(error);
            }
        }
        
        // PARSE CSV
        function parseCSV(file) {
            return new Promise((resolve, reject) => {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    encoding: 'UTF-8',
                    complete: (results) => {
                        if (results.errors.length > 0) {
                            console.warn('CSV parse warnings:', results.errors);
                        }
                        resolve(results.data);
                    },
                    error: (error) => {
                        reject(error);
                    }
                });
            });
        }
        
        // PARSE EXCEL
        async function parseExcel(file) {
            const data = await file.arrayBuffer();
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], {
                header: 1,
                defval: "",
                raw: false,
                blankrows: false
            });
            
            if (jsonData.length < 2) {
                throw new Error('Fichier vide');
            }
            
            const headers = jsonData[0];
            return jsonData.slice(1).map(row => {
                const obj = {};
                headers.forEach((h, i) => {
                    if (h) obj[h] = row[i] || "";
                });
                return obj;
            });
        }
        
        // PARSE AND STORE
        async function parseAndStore(data) {
            const teams = detectTeams(data);
            updateLoading(`√âquipes d√©tect√©es : ${teams.join(', ')}`);
            
            for (const team of teams) {
                await addTeam({ name: team });
            }
            
            let added = 0;
            let skipped = 0;
            
            for (let i = 0; i < data.length; i++) {
                if (i % 100 === 0) {
                    updateLoading(`Traitement ${i + 1}/${data.length}...`);
                    await new Promise(r => setTimeout(r, 0)); // Allow UI update
                }
                
                const row = data[i];
                
                // Skip lignes vides
                if (Object.values(row).every(v => !v || v.trim() === '')) continue;
                
                // Hash robuste
                const hashComponents = [
                    row['Position'] || '',
                    row['[M] rencontre'] || '',
                    row['#14 joueurs'] || '',
                    row['#15 gardiens'] || '',
                    row['#08 r√©sultat'] || '',
                    row['Nom'] || ''
                ].join('|');
                const hash = CryptoJS.MD5(hashComponents).toString();
                
                // Check doublon
                const existing = await getRawDataByHash(hash);
                if (existing) {
                    skipped++;
                    continue;
                }
                
                // Store
                await addRawData({
                    hash: hash,
                    match: row['[M] rencontre'] || '',
                    periode: row['[P] p√©riode'] || '',
                    team_att: row['#01 Attaque'] || '',
                    team_def: row['#02 D√©fense'] || '',
                    raw: row
                });
                
                added++;
            }
            
            return { added, skipped, total: data.length };
        }
        
        function detectTeams(allRows) {
            const teams = new Set();
            // Scanner TOUTES les lignes pour trouver toutes les colonnes #03 Phase XXX
            for (let i = 0; i < allRows.length; i++) {
                const keys = Object.keys(allRows[i]);
                for (let k = 0; k < keys.length; k++) {
                    if (keys[k].startsWith('#03 Phase ')) {
                        const team = keys[k].substring(11).trim();
                        if (team) teams.add(team);
                    }
                }
                // Filet de securite : aussi via #01 Attaque / #02 Defence
                const att = allRows[i]['#01 Attaque'];
                const def = allRows[i]['#02 D√©fense'];
                if (att && att.trim()) teams.add(att.trim());
                if (def && def.trim()) teams.add(def.trim());
            }
            return Array.from(teams);
        }
        
        // TEAMS NAV
        async function loadTeamsFromDB() {
            allTeams = await getAllTeams();
        }
        
        function renderTeamsNav() {
            const nav = document.getElementById('teamsNav');
            nav.innerHTML = '';
            
            allTeams.forEach(team => {
                const btn = document.createElement('div');
                btn.className = 'team-logo-btn';
                btn.innerHTML = team.name.substring(0, 3).toUpperCase();
                btn.onclick = () => selectTeam(team.name);
                nav.appendChild(btn);
            });
        }
        
        async function selectTeam(teamName) {
            currentTeam = teamName;
            
            document.querySelectorAll('.team-logo-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent === teamName.substring(0, 3).toUpperCase());
            });
            
            document.getElementById('teamPageTitle').textContent = `üìç ${teamName}`;
            
            await loadTeamData();
        }
        
        // LOAD TEAM DATA
        async function loadTeamData() {
            if (!currentTeam) return;
            
            showLoading('Chargement...');
            
            const data = await getRawDataByTeam(currentTeam);
            allTeamData = data; // Stocker pour les filtres
            
            hideLoading();
            
            const matches = new Set(data.map(d => d.match).filter(Boolean));
            document.getElementById('statTotalLines').textContent = data.length;
            document.getElementById('statMatches').textContent = matches.size;
            
            // Reset filters
            filters.matches = [];
            filters.mt = 'ALL';
            filters.lieu = [];
            filters.phNum = [];
            filters.championnat = [];
            filters.stats = [];
            filters.poste = [];
            filters.phJeuATT = 'ALL';
            filters.phJeuDEF = 'ALL';
            
            populateFilters(data);
            renderAllEquipeTables(data);
            renderAllJeuTables(data);
            renderAllNumTables(data);
            renderAllMatchTables(data);
            renderPlayerCards(data);
        }
        
        function populateFilters(data) {
            const matches = [...new Set(data.map(d => d.match).filter(Boolean))];
            const container = document.getElementById('filterMatchList');
            container.innerHTML = '';
            
            matches.forEach(m => {
                const div = document.createElement('div');
                div.className = 'filter-match-item';
                div.textContent = m;
                div.onclick = () => {
                    div.classList.toggle('active');
                    updateMatchFilter();
                };
                container.appendChild(div);
            });
            
            // Initial cascade update
            updateFilterAvailability();
        }
        
        // FILTER PANEL CONTROLS
        function toggleFilterPanel() {
            const panel = document.getElementById('filterPanel');
            const overlay = document.getElementById('filterOverlay');
            panel.classList.toggle('open');
            overlay.classList.toggle('visible');
        }
        
        function closeFilterPanel() {
            document.getElementById('filterPanel').classList.remove('open');
            document.getElementById('filterOverlay').classList.remove('visible');
        }
        
        // Close on mouse leave
        document.getElementById('filterPanel').addEventListener('mouseleave', closeFilterPanel);
        
        function resetFilters() {
            // Reset all filter states
            filters.matches = [];
            filters.mt = 'ALL';
            filters.lieu = [];
            filters.resultat = [];
            filters.phNum = [];
            filters.championnat = [];
            filters.stats = [];
            filters.poste = [];
            filters.phJeuATT = 'ALL';
            filters.phJeuDEF = 'ALL';
            
            // Reset UI
            document.querySelectorAll('.filter-tag').forEach(tag => {
                tag.classList.remove('active', 'hidden');
                if (tag.dataset.value === 'ALL') {
                    tag.classList.add('active');
                }
            });
            
            document.querySelectorAll('.filter-match-item').forEach(item => {
                item.classList.remove('active', 'hidden');
            });
            
            // Re-render with cascade update
            if (allTeamData.length > 0) {
                updateFilterAvailability();
                renderAllEquipeTables(allTeamData);
                renderAllJeuTables(allTeamData);
                renderAllNumTables(allTeamData);
                renderAllMatchTables(allTeamData);
                renderPlayerCards(allTeamData);
            }
        }
        
        // FILTER TAG CLICK HANDLERS
        document.addEventListener('click', (e) => {
            // Trouver le tag m√™me si on clique sur un enfant
            let tag = e.target;
            if (!tag.classList.contains('filter-tag')) {
                tag = tag.closest('.filter-tag');
            }
            
            if (tag && tag.classList.contains('filter-tag')) {
                const filterType = tag.dataset.filter;
                const value = tag.dataset.value;
                
                // Single-select filters (mt, phJeuATT, phJeuDEF)
                if (filterType === 'mt' || filterType === 'phJeuATT' || filterType === 'phJeuDEF') {
                    // Deselect siblings
                    tag.parentElement.querySelectorAll('.filter-tag').forEach(t => {
                        t.classList.remove('active');
                    });
                    tag.classList.add('active');
                    filters[filterType] = value;
                }
                // Multi-select filters
                else {
                    tag.classList.toggle('active');
                    if (tag.classList.contains('active')) {
                        if (!filters[filterType].includes(value)) {
                            filters[filterType].push(value);
                        }
                    } else {
                        filters[filterType] = filters[filterType].filter(v => v !== value);
                    }
                }
                
                // Re-render with cascade update
                if (allTeamData.length > 0) {
                    updateFilterAvailability();
                    renderAllEquipeTables(allTeamData);
                    renderAllJeuTables(allTeamData);
                    renderAllNumTables(allTeamData);
                renderAllMatchTables(allTeamData);
                renderPlayerCards(allTeamData);
                }
            }
        });
        
        function updateMatchFilter() {
            const selected = Array.from(document.querySelectorAll('.filter-match-item.active'))
                .map(el => el.textContent.trim());
            filters.matches = selected;
            
            if (allTeamData.length > 0) {
                updateFilterAvailability();
                renderAllEquipeTables(allTeamData);
                renderAllJeuTables(allTeamData);
                renderAllNumTables(allTeamData);
                renderAllMatchTables(allTeamData);
                renderPlayerCards(allTeamData);
            }
        }
        
        // UPDATE FILTER AVAILABILITY (CASCADE UNIQUEMENT SUR MATCH)
        function updateFilterAvailability() {
            // Appliquer TOUS les filtres SAUF Match pour voir quels matchs restent disponibles
            const tempFilters = { ...filters, matches: [] }; // Ignorer le filtre Match
            
            const filtered = allTeamData.filter(row => {
                const phase = row.raw[`#03 Phase ${currentTeam}`] || '';
                const teamAtt = row.raw['#01 Attaque'] || '';
                const teamDef = row.raw['#02 D√©fense'] || '';
                const match = row.raw['[M] rencontre'] || '';
                const periode = row.raw['[P] p√©riode'] || '';
                const fEncl = row.raw['#09 F. Encl'] || '';
                const poste = row.raw['#15.1 poste'] || '';
                
                // 1. FILTRE MODE (ATT/DEF)
                if (currentMode === 'ATT') {
                    if (teamAtt !== currentTeam) return false;
                    const isAttackPhase = 
                        phase.includes('att al') || phase.includes('att √©tg') || 
                        (phase.includes('mdb') && !phase.includes('rpl')) ||
                        (phase.includes('er') && !phase.includes('rpl')) ||
                        (phase.includes('ca') && !phase.includes('rpl')) ||
                        (phase.includes('py') && !phase.includes('vs')) ||
                        (phase.includes('rebond') && !phase.includes('vs'));
                    if (!isAttackPhase) return false;
                } else {
                    if (teamDef !== currentTeam) return false;
                    const isDefensePhase = 
                        phase.includes('def al') || phase.includes('def √©tg') || 
                        phase.includes('rpl mdb') || phase.includes('rpl er') ||
                        phase.includes('rpl ca') || phase.includes('py vs') ||
                        phase.includes('rebond vs');
                    if (!isDefensePhase) return false;
                }
                
                // 2. FILTRE MT
                if (tempFilters.mt !== 'ALL') {
                    if (tempFilters.mt === 'MT1' && !periode.includes('MT1')) return false;
                    if (tempFilters.mt === 'MT2' && !periode.includes('MT2')) return false;
                }
                
                // 3. FILTRE LIEU
                if (tempFilters.lieu.length > 0) {
                    const parts = match.split(' ');
                    if (parts.length >= 2) {
                        const teams = parts.slice(1).join(' ').split('-');
                        const equipeA = teams[0]?.trim();
                        const equipeB = teams[1]?.trim();
                        const isDom = equipeA === currentTeam;
                        const isExt = equipeB === currentTeam;
                        const matchesFilter = tempFilters.lieu.some(f => {
                            if (f === 'DOM' && isDom) return true;
                            if (f === 'EXT' && isExt) return true;
                            return false;
                        });
                        if (!matchesFilter) return false;
                    }
                }
                
                // 4. FILTRE RESULTAT
                if (tempFilters.resultat.length > 0 && match) {
                    const matchScores = calculateMatchScores(allTeamData);
                    if (matchScores[match]) {
                        const scores = matchScores[match];
                        const parts = match.split(' ');
                        if (parts.length >= 2) {
                            const teams = parts.slice(1).join(' ').split('-');
                            const equipeA = teams[0]?.trim();
                            const isTeamA = equipeA === currentTeam;
                            const teamScore = isTeamA ? scores.teamA : scores.teamB;
                            const oppScore = isTeamA ? scores.teamB : scores.teamA;
                            let result;
                            if (teamScore > oppScore) result = 'V';
                            else if (teamScore === oppScore) result = 'N';
                            else result = 'D';
                            if (!tempFilters.resultat.includes(result)) return false;
                        }
                    }
                }
                
                // 5. FILTRE PhNum
                if (tempFilters.phNum.length > 0) {
                    const has6c6 = !phase.includes('[+]') && !phase.includes('[-]') && !fEncl.includes('7 c 6');
                    const has7c6 = fEncl.includes('7 c 6');
                    const hasPlus = phase.includes('[+]');
                    const hasMinus = phase.includes('[-]');
                    const matchesFilter = tempFilters.phNum.some(f => {
                        if (f === '6c6' && has6c6) return true;
                        if (f === '7c6' && has7c6) return true;
                        if (f === '[+]' && hasPlus) return true;
                        if (f === '[-]' && hasMinus) return true;
                        return false;
                    });
                    if (!matchesFilter) return false;
                }
                
                // 6. FILTRE CHAMPIONNAT
                if (tempFilters.championnat.length > 0) {
                    const firstChar = match.charAt(0);
                    const matchesFilter = tempFilters.championnat.some(f => {
                        if (f === 'LNH' && firstChar === 'J') return true;
                        if (f === 'EHF' && firstChar === 'E') return true;
                        if (f === 'CdF' && firstChar === 'C') return true;
                        if (f === 'A' && firstChar === 'A') return true;
                        return false;
                    });
                    if (!matchesFilter) return false;
                }
                
                // 7. FILTRE STATS
                if (tempFilters.stats.length > 0) {
                    const colBut = row.raw['|a00| but'] || '';
                    const colTir = row.raw['|a00| tir'] || '';
                    const colNeutral = row.raw['|d09.1| neutralisation'] || '';
                    const colPdb = row.raw['|a18| pdb'] || '';
                    const colPy = row.raw['|a03| py obt'] || '';
                    const col2 = row.raw["|a04| 2' obt"] || '';
                    const matchesFilter = tempFilters.stats.some(f => {
                        if (f === 'But' && colBut) return true;
                        if (f === 'Tir' && colTir && colTir !== 'x' && !colBut) return true;
                        if (f === 'Shoot' && colTir && colTir !== 'x') return true;
                        if (f === 'N' && colNeutral) return true;
                        if (f === 'Pdb' && colPdb) return true;
                        if (f === 'Py obt' && colPy) return true;
                        if (f === "2'" && col2) return true;
                        return false;
                    });
                    if (!matchesFilter) return false;
                }
                
                // 8. FILTRE POSTE
                if (tempFilters.poste.length > 0) {
                    const matchesFilter = tempFilters.poste.some(p => poste.includes(p));
                    if (!matchesFilter) return false;
                }
                
                // 9. FILTRE PhJeuATT
                if (currentMode === 'ATT' && tempFilters.phJeuATT !== 'ALL') {
                    if (tempFilters.phJeuATT === 'Att p') {
                        const isAttP = phase.includes('att al') || phase.includes('att √©tg') || (phase.includes('rebond') && !phase.includes('vs'));
                        if (!isAttP) return false;
                    }
                    if (tempFilters.phJeuATT === 'MdB') {
                        const isMdb = (phase.includes('mdb') || phase.includes('er') || phase.includes('ca')) && !phase.includes('rpl') && !phase.includes('vs');
                        if (!isMdb) return false;
                    }
                    if (tempFilters.phJeuATT === '5-1 Att' && !phase.includes('att √©tg')) return false;
                    if (tempFilters.phJeuATT === '0-6 Att' && !phase.includes('att al')) return false;
                }
                
                // 10. FILTRE PhJeuDEF
                if (currentMode === 'DEF' && tempFilters.phJeuDEF !== 'ALL') {
                    if (tempFilters.phJeuDEF === 'Def p') {
                        const isDefP = phase.includes('def al') || phase.includes('def √©tg') || phase.includes('rebond vs');
                        if (!isDefP) return false;
                    }
                    if (tempFilters.phJeuDEF === 'Rpl') {
                        const isRpl = phase.includes('rpl mdb') || phase.includes('rpl er') || phase.includes('rpl ca');
                        if (!isRpl) return false;
                    }
                    if (tempFilters.phJeuDEF === '5-1 Def' && !phase.includes('def √©tg')) return false;
                    if (tempFilters.phJeuDEF === '0-6 Def' && !phase.includes('def al')) return false;
                }
                
                return true;
            });
            
            // Compter les matchs disponibles
            const availableMatches = new Set(filtered.map(row => row.raw['[M] rencontre'] || ''));
            
            // Mettre √† jour UNIQUEMENT la liste des matchs
            document.querySelectorAll('.filter-match-item').forEach(item => {
                const matchName = item.textContent.trim();
                
                // Masquer si le match n'est pas disponible ET pas actif
                if (!availableMatches.has(matchName) && !item.classList.contains('active')) {
                    item.classList.add('hidden');
                } else {
                    item.classList.remove('hidden');
                }
            });
            
            // TOUS LES AUTRES BOUTONS RESTENT TOUJOURS VISIBLES
            document.querySelectorAll('.filter-tag').forEach(tag => {
                tag.classList.remove('hidden');
            });
        }
        
        // RENDER TABLE HPY
// ============================================
// FONCTIONS DE RENDU DES 7 TABLEAUX EQUIPE
// √Ä INS√âRER APR√àS LA FONCTION renderTableHPY EXISTANTE
// ============================================

// REMPLACER TOUS LES APPELS renderTableHPY(allTeamData) PAR renderAllEquipeTables(allTeamData)
// REMPLACER TOUS LES APPELS renderTableHPY(data) PAR renderAllEquipeTables(data)

// RENDER ALL EQUIPE TABLES
        // ============================================
        // FORMAT & SORT UTILITIES
        // ============================================
        
        // Format values - hide zeros
        function formatValue(value, type = 'number') {
            if (type === 'number') {
                return value === 0 ? '-' : value;
            }
            if (type === 'ratio') {
                // Format: "3/6 (50%)" or "0/0 (0%)"
                const str = String(value);
                if (str.includes('0/0') || str.startsWith('0/')) return '-';
                return value;
            }
            if (type === 'ratio-paren') {
                // Format: "5 (3)"
                const str = String(value);
                if (str.startsWith('0 ')) return '-';
                return value;
            }
            return value;
        }
        
        // Sort state
        let sortState = {};
        
        // Sort table function
        function sortTable(tableId, colIndex, sortType) {
            const tbody = document.getElementById(tableId);
            if (!tbody) return;
            
            // Initialize state
            if (!sortState[tableId]) {
                sortState[tableId] = { col: null, cycle: 0 };
            }
            
            const state = sortState[tableId];
            
            // Update cycle
            if (state.col === colIndex) {
                state.cycle = (state.cycle + 1) % (sortType === 'shooting' ? 3 : 2);
            } else {
                state.col = colIndex;
                state.cycle = 0;
            }
            
            // Get rows (exclude Total and Moyenne)
            const rows = Array.from(tbody.querySelectorAll('tr')).filter(row => 
                !row.classList.contains('total-row') && 
                row.style.background !== 'rgba(102, 159, 183, 0.2)'
            );
            
            const totalRow = tbody.querySelector('.total-row');
            const avgRow = Array.from(tbody.querySelectorAll('tr')).find(row => 
                row.style.background === 'rgba(102, 159, 183, 0.2)'
            );
            
            // Sort logic
            rows.sort((a, b) => {
                const cellA = a.cells[colIndex];
                const cellB = b.cells[colIndex];
                if (!cellA || !cellB) return 0;
                
                const textA = cellA.textContent.trim();
                const textB = cellB.textContent.trim();
                
                if (sortType === 'shooting') {
                    // Parse "23/37 (62%)"
                    const matchA = textA.match(/^(\d+)\/(\d+)\s*\((\d+)%\)/);
                    const matchB = textB.match(/^(\d+)\/(\d+)\s*\((\d+)%\)/);
                    
                    const butsA = matchA ? parseInt(matchA[1]) : 0;
                    const butsB = matchB ? parseInt(matchB[1]) : 0;
                    const tirsA = matchA ? parseInt(matchA[2]) : 0;
                    const tirsB = matchB ? parseInt(matchB[2]) : 0;
                    const pctA = matchA ? parseInt(matchA[3]) : 0;
                    const pctB = matchB ? parseInt(matchB[3]) : 0;
                    
                    if (state.cycle === 0) return butsB - butsA; // By buts desc
                    if (state.cycle === 1) return tirsB - tirsA; // By tirs desc
                    return pctB !== pctA ? pctB - pctA : tirsB - tirsA; // By % desc with volume
                } else {
                    // Simple number sort
                    const valA = textA === '-' ? 0 : parseFloat(textA.replace(/[^\d.]/g, ''));
                    const valB = textB === '-' ? 0 : parseFloat(textB.replace(/[^\d.]/g, ''));
                    return state.cycle === 0 ? valB - valA : valA - valB;
                }
            });
            
            // Re-append
            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
            if (totalRow) tbody.appendChild(totalRow);
            if (avgRow) tbody.appendChild(avgRow);
            
            // Update header visual
            const table = tbody.closest('table');
            table.querySelectorAll('th').forEach(th => {
                th.classList.remove('asc', 'desc');
                // Remove any previous sort indicator
                const sortIndicator = th.querySelector('.sort-indicator');
                if (sortIndicator) sortIndicator.remove();
            });
            
            const header = table.querySelector(`th[data-column="${colIndex}"]`);
            if (header) {
                if (sortType === 'shooting') {
                    // Add shooting sort indicator
                    const indicator = document.createElement('span');
                    indicator.className = 'sort-indicator';
                    indicator.style.cssText = 'margin-left: 8px; font-size: 0.85em; color: var(--pink); font-weight: bold;';
                    
                    if (state.cycle === 0) {
                        indicator.textContent = '(Buts ‚ñº)';
                    } else if (state.cycle === 1) {
                        indicator.textContent = '(Tirs ‚ñº)';
                    } else {
                        indicator.textContent = '(% ‚ñº)';
                    }
                    
                    header.appendChild(indicator);
                } else {
                    // Simple sort
                    header.classList.add(state.cycle === 0 ? 'desc' : 'asc');
                }
            }
        }
        
        // Add sort handlers to table
        function enableSorting(tableId, columns) {
            const tbody = document.getElementById(tableId);
            if (!tbody) return;
            
            const table = tbody.closest('table');
            columns.forEach(col => {
                const th = table.querySelector(`th[data-column="${col.index}"]`);
                if (th) {
                    th.classList.add('sortable');
                    th.onclick = () => sortTable(tableId, parseInt(col.index), col.type);
                }
            });
        }
        
// ============================================
// ============================================
// Helper function to toggle sub-phases visibility
function toggleSubPhases(row) {
    const icon = row.querySelector('.expand-icon');
    if (!icon) return;
    
    let nextRow = row.nextElementSibling;
    const isExpanded = icon.textContent === '‚ñº';
    
    icon.textContent = isExpanded ? '‚ñ∂' : '‚ñº';
    
    while (nextRow && nextRow.classList.contains('sub-phase-row')) {
        if (isExpanded) {
            nextRow.classList.add('hidden');
        } else {
            nextRow.classList.remove('hidden');
        }
        nextRow = nextRow.nextElementSibling;
    }
}

// Helper function to calculate stats for a phase (JEU/NUM)
// Uses same logic as EQUIPE but without player grouping
function calculatePhaseStats(data) {
    const stats = {
        shootBut: 0, shootTir: 0,
        butHPY: 0, tirHPY: 0,
        butPY: 0, tirPY: 0,
        pyObt: 0, min2Obt: 0, pdb: 0, neutralise: 0, passe: 0
    };
    
    data.forEach(row => {
        const colButHPY = (row.raw['|a00| but'] || '').trim();
        const colTirHPY = (row.raw['|a00| tir'] || '').trim();
        const colButPY = (row.raw['|a01| but py'] || '').trim();
        const colTirPY = (row.raw['|a01| tir py'] || '').trim();
        const colPyObt = (row.raw['|a03| py obt'] || '').trim();
        const colMin2Obt = (row.raw["|a04| 2' obt"] || '').trim();
        const colPdb = (row.raw['|a18| pdb'] || '').trim();
        const colNeutralise = (row.raw['|a19| neutralis√©'] || '').trim();
        const colPPiv = (row.raw['|a06| p. piv'] || '').trim();
        const colPAilG = (row.raw['|a07| p. ail G'] || '').trim();
        const colPAilD = (row.raw['|a08| p. ail D'] || '').trim();
        
        // But HPY: column contains a player name (not empty, not 'x')
        if (colButHPY && colButHPY !== 'x') stats.butHPY++;
        
        // Tir HPY: column contains a player name AND is not 'x'
        if (colTirHPY && colTirHPY !== 'x') stats.tirHPY++;
        
        // But PY: column contains a player name (not empty, not 'x')
        if (colButPY && colButPY !== 'x') stats.butPY++;
        
        // Tir PY: column contains a player name
        if (colTirPY && colTirPY !== 'x') stats.tirPY++;
        
        // Other stats: column contains a player name
        if (colPyObt && colPyObt !== 'x') stats.pyObt++;
        if (colMin2Obt && colMin2Obt !== 'x') stats.min2Obt++;
        if (colPdb && colPdb !== 'x') stats.pdb++;
        if (colNeutralise) stats.neutralise++; // Can include 'x'
        
        // Passes: count if column contains a player name
        if (colPPiv && colPPiv !== 'x') stats.passe++;
        if (colPAilG && colPAilG !== 'x') stats.passe++;
        if (colPAilD && colPAilD !== 'x') stats.passe++;
    });
    
    // Calculate combined shoot stats
    stats.shootBut = stats.butHPY + stats.butPY;
    stats.shootTir = stats.tirHPY + stats.tirPY;
    
    // Calculate percentages
    stats.shootPct = stats.shootTir > 0 ? ((stats.shootBut / stats.shootTir) * 100).toFixed(0) : 0;
    stats.hpyPct = stats.tirHPY > 0 ? ((stats.butHPY / stats.tirHPY) * 100).toFixed(0) : 0;
    stats.pyPct = stats.tirPY > 0 ? ((stats.butPY / stats.tirPY) * 100).toFixed(0) : 0;
    
    return stats;
}

// ============================================
// ONGLET NUM - TOUTES LES FONCTIONS CORRIG√âES
// ============================================

function renderAllNumTables(data) {
    const filtered = applyFilters(data);
    
    // Group data by numerical phase
    const phases = groupByNumPhase(filtered);
    
    // Count unique matches for average calculation
    const matchCount = new Set(filtered.map(row => row.raw['[M] rencontre'])).size;
    
    // Render each table
    renderTableNumGlobal(phases, matchCount);
    renderTableNumHPY(phases, matchCount);
    renderTableNumPY(phases, matchCount);
    renderTableNumSanction(phases, matchCount);
    renderTableNumRelation(phases, matchCount);
    renderTableNumPdb(phases, matchCount);
    renderTableNumNeutralise(phases, matchCount);
}

function groupByNumPhase(data) {
    if (!currentTeam) {
        console.warn('No team selected');
        return { 
            '6c6': { data: [], subPhases: {} },
            '7c6': { data: [], subPhases: {} },
            '[+]': { data: [], subPhases: {} },
            '[-]': { data: [], subPhases: {} }
        };
    }
    
    const phaseCol = `#03 Phase ${currentTeam}`;
    const enclCol = '#09 F. Encl';
    
    const phases = {
        '6c6': { data: [], subPhases: {} },
        '7c6': { data: [], subPhases: {} },
        '[+]': { data: [], subPhases: {} },
        '[-]': { data: [], subPhases: {} }
    };
    
    console.log(`Grouping by numerical phase for team: ${currentTeam}`);
    console.log(`Total filtered rows: ${data.length}`);
    
    let sixSixData = [];
    let infData = [];
    
    data.forEach(row => {
        const phaseValue = (row.raw[phaseCol] || '').toLowerCase();
        const enclValue = (row.raw[enclCol] || '').toLowerCase();
        
        // 7c6: #09 F. Encl contains "7 c 6"
        if (enclValue.includes('7 c 6')) {
            phases['7c6'].data.push(row);
        }
        // [+]: #03 Phase contains "[+]"
        else if (phaseValue.includes('[+]')) {
            phases['[+]'].data.push(row);
        }
        // [-]: #03 Phase contains "[-]"
        else if (phaseValue.includes('[-]')) {
            phases['[-]'].data.push(row);
            infData.push(row); // Keep for sub-category
        }
        // 6c6: doesn't contain "[+]" or "[-]" and #09 F. Encl doesn't contain "7 c 6"
        else if (!phaseValue.includes('[+]') && !phaseValue.includes('[-]') && !enclValue.includes('7 c 6')) {
            phases['6c6'].data.push(row);
            sixSixData.push(row); // Keep for sub-category
        }
    });
    
    // Create sub-category 6c6 + [-] by combining 6c6 and [-]
    if (sixSixData.length > 0 || infData.length > 0) {
        phases['6c6'].subPhases['6c6 + [-]'] = [...sixSixData, ...infData];
    }
    
    console.log('Numerical phase grouping results:');
    Object.entries(phases).forEach(([name, phaseData]) => {
        console.log(`  ${name}: ${phaseData.data.length} rows`);
        if (Object.keys(phaseData.subPhases).length > 0) {
            Object.entries(phaseData.subPhases).forEach(([subName, subData]) => {
                console.log(`    ${subName}: ${subData.length} rows`);
            });
        }
    });
    
    return phases;
}

// GLOBAL TABLE
function renderTableNumGlobal(phases, matchCount) {
    const tbody = document.getElementById('tableNumGlobal');
    tbody.innerHTML = '';
    
    const formatRow = (name, stats, icon, isSub = false) => {
        const shootVal = `${stats.shootBut}/${stats.shootTir} (${stats.shootPct}%)`;
        const hpyVal = `${stats.butHPY}/${stats.tirHPY} (${stats.hpyPct}%)`;
        const pyVal = `${stats.butPY}/${stats.tirPY} (${stats.pyPct}%)`;
        const indent = isSub ? 'padding-left: 2rem;' : '';
        
        return `
            <td style="${indent}">${icon}${name}</td>
            <td>${formatValue(shootVal, 'ratio')}</td>
            <td>${formatValue(hpyVal, 'ratio')}</td>
            <td>${formatValue(pyVal, 'ratio')}</td>
            <td>${formatValue(stats.pyObt, 'number')}</td>
            <td>${formatValue(stats.min2Obt, 'number')}</td>
            <td>${formatValue(stats.pdb, 'number')}</td>
            <td>${formatValue(stats.neutralise, 'number')}</td>
            <td>${formatValue(stats.passe, 'number')}</td>
        `;
    };
    
    const totals = renderPhaseRows(tbody, phases, 9, formatRow);
    
    if (!totals) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: var(--grey);">Aucune donn√©e</td></tr>';
        return;
    }
    
    // Recalculate percentages for totals
    const totalShootPct = totals.shootTir > 0 ? ((totals.shootBut / totals.shootTir) * 100).toFixed(0) : 0;
    const totalHpyPct = totals.tirHPY > 0 ? ((totals.butHPY / totals.tirHPY) * 100).toFixed(0) : 0;
    const totalPyPct = totals.tirPY > 0 ? ((totals.butPY / totals.tirPY) * 100).toFixed(0) : 0;
    
    // Total row
    const trTotal = document.createElement('tr');
    trTotal.className = 'total-row';
    trTotal.innerHTML = `
        <td>Total</td>
        <td>${totals.shootBut}/${totals.shootTir} (${totalShootPct}%)</td>
        <td>${totals.butHPY}/${totals.tirHPY} (${totalHpyPct}%)</td>
        <td>${totals.butPY}/${totals.tirPY} (${totalPyPct}%)</td>
        <td>${totals.pyObt}</td>
        <td>${totals.min2Obt}</td>
        <td>${totals.pdb}</td>
        <td>${totals.neutralise}</td>
        <td>${totals.passe}</td>
    `;
    tbody.appendChild(trTotal);
    
    // Average row
    if (matchCount > 0) {
        const trAvg = document.createElement('tr');
        trAvg.style.background = 'rgba(102, 159, 183, 0.2)';
        trAvg.innerHTML = `
            <td>Moyenne</td>
            <td>${(totals.shootBut / matchCount).toFixed(1)}/${(totals.shootTir / matchCount).toFixed(1)}</td>
            <td>${(totals.butHPY / matchCount).toFixed(1)}/${(totals.tirHPY / matchCount).toFixed(1)}</td>
            <td>${(totals.butPY / matchCount).toFixed(1)}/${(totals.tirPY / matchCount).toFixed(1)}</td>
            <td>${(totals.pyObt / matchCount).toFixed(1)}</td>
            <td>${(totals.min2Obt / matchCount).toFixed(1)}</td>
            <td>${(totals.pdb / matchCount).toFixed(1)}</td>
            <td>${(totals.neutralise / matchCount).toFixed(1)}</td>
            <td>${(totals.passe / matchCount).toFixed(1)}</td>
        `;
        tbody.appendChild(trAvg);
    }
    
    document.getElementById('numGlobalStats').textContent = `${totals.shootBut}/${totals.shootTir} (${totalShootPct}%)`;
    
    enableSorting('tableNumGlobal', [
        { index: '1', type: 'shooting' },
        { index: '2', type: 'shooting' },
        { index: '3', type: 'shooting' },
        { index: '4', type: 'simple' },
        { index: '5', type: 'simple' },
        { index: '6', type: 'simple' },
        { index: '7', type: 'simple' },
        { index: '8', type: 'simple' }
    ]);
}

// HPY TABLE
function renderTableNumHPY(phases, matchCount) {
    const tbody = document.getElementById('tableNumHPY');
    tbody.innerHTML = '';
    
    const formatRow = (name, stats, icon, isSub = false) => {
        const hpyVal = `${stats.butHPY}/${stats.tirHPY} (${stats.hpyPct}%)`;
        const indent = isSub ? 'padding-left: 2rem;' : '';
        return `
            <td style="${indent}">${icon}${name}</td>
            <td>${formatValue(hpyVal, 'ratio')}</td>
        `;
    };
    
    const totals = renderPhaseRows(tbody, phases, 2, formatRow);
    
    if (!totals) {
        tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; color: var(--grey);">Aucune donn√©e</td></tr>';
        return;
    }
    
    const totalPct = totals.tirHPY > 0 ? ((totals.butHPY / totals.tirHPY) * 100).toFixed(0) : 0;
    
    const trTotal = document.createElement('tr');
    trTotal.className = 'total-row';
    trTotal.innerHTML = `
        <td>Total</td>
        <td>${totals.butHPY}/${totals.tirHPY} (${totalPct}%)</td>
    `;
    tbody.appendChild(trTotal);
    
    if (matchCount > 0) {
        const trAvg = document.createElement('tr');
        trAvg.style.background = 'rgba(102, 159, 183, 0.2)';
        trAvg.innerHTML = `
            <td>Moyenne</td>
            <td>${(totals.butHPY / matchCount).toFixed(1)}/${(totals.tirHPY / matchCount).toFixed(1)}</td>
        `;
        tbody.appendChild(trAvg);
    }
    
    document.getElementById('numHpyStats').textContent = `${totals.butHPY}/${totals.tirHPY} (${totalPct}%)`;
    
    enableSorting('tableNumHPY', [{ index: '1', type: 'shooting' }]);
}

// PY TABLE
function renderTableNumPY(phases, matchCount) {
    const tbody = document.getElementById('tableNumPY');
    tbody.innerHTML = '';
    
    const formatRow = (name, stats, icon, isSub = false) => {
        const pyVal = `${stats.butPY}/${stats.tirPY} (${stats.pyPct}%)`;
        const indent = isSub ? 'padding-left: 2rem;' : '';
        return `
            <td style="${indent}">${icon}${name}</td>
            <td>${formatValue(pyVal, 'ratio')}</td>
        `;
    };
    
    const totals = renderPhaseRows(tbody, phases, 2, formatRow);
    
    if (!totals) {
        tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; color: var(--grey);">Aucune donn√©e</td></tr>';
        return;
    }
    
    const totalPct = totals.tirPY > 0 ? ((totals.butPY / totals.tirPY) * 100).toFixed(0) : 0;
    
    const trTotal = document.createElement('tr');
    trTotal.className = 'total-row';
    trTotal.innerHTML = `
        <td>Total</td>
        <td>${totals.butPY}/${totals.tirPY} (${totalPct}%)</td>
    `;
    tbody.appendChild(trTotal);
    
    if (matchCount > 0) {
        const trAvg = document.createElement('tr');
        trAvg.style.background = 'rgba(102, 159, 183, 0.2)';
        trAvg.innerHTML = `
            <td>Moyenne</td>
            <td>${(totals.butPY / matchCount).toFixed(1)}/${(totals.tirPY / matchCount).toFixed(1)}</td>
        `;
        tbody.appendChild(trAvg);
    }
    
    document.getElementById('numPyStats').textContent = `${totals.butPY}/${totals.tirPY} (${totalPct}%)`;
    
    enableSorting('tableNumPY', [{ index: '1', type: 'shooting' }]);
}

// SANCTION TABLE - AVEC CALCUL DES 2' UNIQUE
function renderTableNumSanction(phases, matchCount) {
    const tbody = document.getElementById('tableNumSanction');
    tbody.innerHTML = '';
    
    let grandTotals = { pyObt: 0, min2Obt: 0, min2Unique: 0, total: 0 };
    
    Object.entries(phases).forEach(([phaseName, phaseData]) => {
        if (phaseData.data.length === 0) return;
        
        // Calculate unique 2' for this phase
        let pyObt = 0, min2Obt = 0, min2Unique = 0;
        phaseData.data.forEach(row => {
            const hasPy = row.raw['|a03| py obt'] && row.raw['|a03| py obt'].trim();
            const hasMin2 = row.raw['|a04| 2\' obt'] && row.raw['|a04| 2\' obt'].trim();
            
            if (hasPy) pyObt++;
            if (hasMin2) {
                min2Obt++;
                if (!hasPy) min2Unique++;
            }
        });
        
        const total = pyObt + min2Obt;
        const hasSubPhases = Object.keys(phaseData.subPhases).length > 0;
        
        // Main row
        const tr = document.createElement('tr');
        const expandIcon = hasSubPhases ? '<span class="expand-icon" style="cursor: pointer; margin-right: 8px;">‚ñ∂</span>' : '';
        const min2Val = `${min2Obt} (${min2Unique})`;
        
        tr.innerHTML = `
            <td>${expandIcon}${phaseName}</td>
            <td>${formatValue(pyObt, 'number')}</td>
            <td>${formatValue(min2Val, 'ratio-paren')}</td>
            <td>${formatValue(total, 'number')}</td>
        `;
        
        if (hasSubPhases) {
            tr.style.cursor = 'pointer';
            tr.onclick = () => toggleSubPhases(tr);
        }
        
        tbody.appendChild(tr);
        
        grandTotals.pyObt += pyObt;
        grandTotals.min2Obt += min2Obt;
        grandTotals.min2Unique += min2Unique;
        grandTotals.total += total;
        
        // Sub-phases
        if (hasSubPhases) {
            Object.entries(phaseData.subPhases).forEach(([subName, subData]) => {
                if (subData.length === 0) return;
                
                let subPyObt = 0, subMin2Obt = 0, subMin2Unique = 0;
                subData.forEach(row => {
                    const hasPy = row.raw['|a03| py obt'] && row.raw['|a03| py obt'].trim();
                    const hasMin2 = row.raw['|a04| 2\' obt'] && row.raw['|a04| 2\' obt'].trim();
                    
                    if (hasPy) subPyObt++;
                    if (hasMin2) {
                        subMin2Obt++;
                        if (!hasPy) subMin2Unique++;
                    }
                });
                
                const subTotal = subPyObt + subMin2Obt;
                const subMin2Val = `${subMin2Obt} (${subMin2Unique})`;
                
                const trSub = document.createElement('tr');
                trSub.className = 'sub-phase-row hidden';
                trSub.style.cssText = 'background: rgba(102, 159, 183, 0.1);';
                trSub.innerHTML = `
                    <td style="padding-left: 2rem;">‚Ü≥ ${subName}</td>
                    <td>${formatValue(subPyObt, 'number')}</td>
                    <td>${formatValue(subMin2Val, 'ratio-paren')}</td>
                    <td>${formatValue(subTotal, 'number')}</td>
                `;
                
                tbody.appendChild(trSub);
            });
        }
    });
    
    const trTotal = document.createElement('tr');
    trTotal.className = 'total-row';
    trTotal.innerHTML = `
        <td>Total</td>
        <td>${grandTotals.pyObt}</td>
        <td>${grandTotals.min2Obt} (${grandTotals.min2Unique})</td>
        <td>${grandTotals.total}</td>
    `;
    tbody.appendChild(trTotal);
    
    if (matchCount > 0) {
        const trAvg = document.createElement('tr');
        trAvg.style.background = 'rgba(102, 159, 183, 0.2)';
        trAvg.innerHTML = `
            <td>Moyenne</td>
            <td>${(grandTotals.pyObt / matchCount).toFixed(1)}</td>
            <td>${(grandTotals.min2Obt / matchCount).toFixed(1)} (${(grandTotals.min2Unique / matchCount).toFixed(1)})</td>
            <td>${(grandTotals.total / matchCount).toFixed(1)}</td>
        `;
        tbody.appendChild(trAvg);
    }
    
    document.getElementById('numSanctionStats').textContent = `${grandTotals.total}`;
    
    enableSorting('tableNumSanction', [
        { index: '1', type: 'simple' },
        { index: '2', type: 'simple' },
        { index: '3', type: 'simple' }
    ]);
}

// RELATION TABLE
function renderTableNumRelation(phases, matchCount) {
    const tbody = document.getElementById('tableNumRelation');
    tbody.innerHTML = '';
    
    let grandTotals = { piv: 0, ailG: 0, ailD: 0 };
    
    Object.entries(phases).forEach(([phaseName, phaseData]) => {
        if (phaseData.data.length === 0) return;
        
        let stats = { piv: 0, ailG: 0, ailD: 0 };
        phaseData.data.forEach(row => {
            if (row.raw['|a06| p. piv'] && row.raw['|a06| p. piv'].trim() && row.raw['|a06| p. piv'].trim() !== 'x') stats.piv++;
            if (row.raw['|a07| p. ail G'] && row.raw['|a07| p. ail G'].trim() && row.raw['|a07| p. ail G'].trim() !== 'x') stats.ailG++;
            if (row.raw['|a08| p. ail D'] && row.raw['|a08| p. ail D'].trim() && row.raw['|a08| p. ail D'].trim() !== 'x') stats.ailD++;
        });
        
        const hasSubPhases = Object.keys(phaseData.subPhases).length > 0;
        const tr = document.createElement('tr');
        const expandIcon = hasSubPhases ? '<span class="expand-icon" style="cursor: pointer; margin-right: 8px;">‚ñ∂</span>' : '';
        
        tr.innerHTML = `
            <td>${expandIcon}${phaseName}</td>
            <td>${formatValue(stats.piv, 'number')}</td>
            <td>${formatValue(stats.ailG, 'number')}</td>
            <td>${formatValue(stats.ailD, 'number')}</td>
        `;
        
        if (hasSubPhases) {
            tr.style.cursor = 'pointer';
            tr.onclick = () => toggleSubPhases(tr);
        }
        
        tbody.appendChild(tr);
        
        grandTotals.piv += stats.piv;
        grandTotals.ailG += stats.ailG;
        grandTotals.ailD += stats.ailD;
        
        // Sub-phases
        if (hasSubPhases) {
            Object.entries(phaseData.subPhases).forEach(([subName, subData]) => {
                if (subData.length === 0) return;
                
                let subStats = { piv: 0, ailG: 0, ailD: 0 };
                subData.forEach(row => {
                    if (row.raw['|a06| p. piv'] && row.raw['|a06| p. piv'].trim() && row.raw['|a06| p. piv'].trim() !== 'x') subStats.piv++;
                    if (row.raw['|a07| p. ail G'] && row.raw['|a07| p. ail G'].trim() && row.raw['|a07| p. ail G'].trim() !== 'x') subStats.ailG++;
                    if (row.raw['|a08| p. ail D'] && row.raw['|a08| p. ail D'].trim() && row.raw['|a08| p. ail D'].trim() !== 'x') subStats.ailD++;
                });
                
                const trSub = document.createElement('tr');
                trSub.className = 'sub-phase-row hidden';
                trSub.style.cssText = 'background: rgba(102, 159, 183, 0.1);';
                trSub.innerHTML = `
                    <td style="padding-left: 2rem;">‚Ü≥ ${subName}</td>
                    <td>${formatValue(subStats.piv, 'number')}</td>
                    <td>${formatValue(subStats.ailG, 'number')}</td>
                    <td>${formatValue(subStats.ailD, 'number')}</td>
                `;
                
                tbody.appendChild(trSub);
            });
        }
    });
    
    const trTotal = document.createElement('tr');
    trTotal.className = 'total-row';
    trTotal.innerHTML = `
        <td>Total</td>
        <td>${grandTotals.piv}</td>
        <td>${grandTotals.ailG}</td>
        <td>${grandTotals.ailD}</td>
    `;
    tbody.appendChild(trTotal);
    
    if (matchCount > 0) {
        const trAvg = document.createElement('tr');
        trAvg.style.background = 'rgba(102, 159, 183, 0.2)';
        trAvg.innerHTML = `
            <td>Moyenne</td>
            <td>${(grandTotals.piv / matchCount).toFixed(1)}</td>
            <td>${(grandTotals.ailG / matchCount).toFixed(1)}</td>
            <td>${(grandTotals.ailD / matchCount).toFixed(1)}</td>
        `;
        tbody.appendChild(trAvg);
    }
    
    const totalPasses = grandTotals.piv + grandTotals.ailG + grandTotals.ailD;
    document.getElementById('numRelationStats').textContent = `${totalPasses}`;
    
    enableSorting('tableNumRelation', [
        { index: '1', type: 'simple' },
        { index: '2', type: 'simple' },
        { index: '3', type: 'simple' }
    ]);
}

// PDB TABLE
function renderTableNumPdb(phases, matchCount) {
    const tbody = document.getElementById('tableNumPdb');
    tbody.innerHTML = '';
    
    const formatRow = (name, stats, icon, isSub = false) => {
        const indent = isSub ? 'padding-left: 2rem;' : '';
        return `
            <td style="${indent}">${icon}${name}</td>
            <td>${formatValue(stats.pdb, 'number')}</td>
        `;
    };
    
    const totals = renderPhaseRows(tbody, phases, 2, formatRow);
    
    if (!totals) {
        tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; color: var(--grey);">Aucune donn√©e</td></tr>';
        return;
    }
    
    const trTotal = document.createElement('tr');
    trTotal.className = 'total-row';
    trTotal.innerHTML = `
        <td>Total</td>
        <td>${totals.pdb}</td>
    `;
    tbody.appendChild(trTotal);
    
    if (matchCount > 0) {
        const trAvg = document.createElement('tr');
        trAvg.style.background = 'rgba(102, 159, 183, 0.2)';
        trAvg.innerHTML = `
            <td>Moyenne</td>
            <td>${(totals.pdb / matchCount).toFixed(1)}</td>
        `;
        tbody.appendChild(trAvg);
    }
    
    document.getElementById('numPdbStats').textContent = `${totals.pdb}`;
    
    enableSorting('tableNumPdb', [{ index: '1', type: 'simple' }]);
}

// NEUTRALISE TABLE
function renderTableNumNeutralise(phases, matchCount) {
    const tbody = document.getElementById('tableNumNeutralise');
    tbody.innerHTML = '';
    
    const formatRow = (name, stats, icon, isSub = false) => {
        const indent = isSub ? 'padding-left: 2rem;' : '';
        return `
            <td style="${indent}">${icon}${name}</td>
            <td>${formatValue(stats.neutralise, 'number')}</td>
        `;
    };
    
    const totals = renderPhaseRows(tbody, phases, 2, formatRow);
    
    if (!totals) {
        tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; color: var(--grey);">Aucune donn√©e</td></tr>';
        return;
    }
    
    const trTotal = document.createElement('tr');
    trTotal.className = 'total-row';
    trTotal.innerHTML = `
        <td>Total</td>
        <td>${totals.neutralise}</td>
    `;
    tbody.appendChild(trTotal);
    
    if (matchCount > 0) {
        const trAvg = document.createElement('tr');
        trAvg.style.background = 'rgba(102, 159, 183, 0.2)';
        trAvg.innerHTML = `
            <td>Moyenne</td>
            <td>${(totals.neutralise / matchCount).toFixed(1)}</td>
        `;
        tbody.appendChild(trAvg);
    }
    
    document.getElementById('numNeutraliseStats').textContent = `${totals.neutralise}`;
    
    enableSorting('tableNumNeutralise', [{ index: '1', type: 'simple' }]);
}

// ============================================
// ONGLET INDIV - PLAYER CARDS & DETAIL
// ============================================

let currentPlayerData = null;
let currentPlayerTab = 'match';

// Cache des photos charg√©es depuis les index
let photosCache = {};

// Charger l'index des photos pour une √©quipe
// Utilise PHOTOS_INDEX (photos-index.js) en priorit√©, fetch en fallback
async function loadPhotoIndexForTeam(teamName) {
    if (photosCache[teamName]) {
        return photosCache[teamName];
    }

    // 1) Variable globale generee par generer-index.py (fonctionne en file://)
    if (typeof PHOTOS_INDEX !== 'undefined' && PHOTOS_INDEX[teamName]) {
        photosCache[teamName] = PHOTOS_INDEX[teamName];
        console.log(`‚úÖ ${photosCache[teamName].length} photos pour ${teamName} (photos-index.js)`);
        return photosCache[teamName];
    }

    // 2) Fallback fetch (serveur HTTP uniquement)
    try {
        const response = await fetch(`Effectifs/${teamName}/index.json`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const indexData = await response.json();
        photosCache[teamName] = indexData.photos || [];
        console.log(`‚úÖ ${photosCache[teamName].length} photos pour ${teamName} (fetch)`);
        return photosCache[teamName];
    } catch (error) {
        console.warn(`‚ö†Ô∏è Pas d'index pour ${teamName}:`, error.message);
        console.log(`üí° Ex√©cutez generer-index.bat pour cr√©er les index`);
        photosCache[teamName] = [];
        return [];
    }
}

// ============================================
// GESTION DES PHOTOS (upload/suppression)
// ============================================
let pendingPhotos = []; // [{file, name, preview, base64}]
let photoDropZoneSetup = false;

function openPhotoModal() {
    if (!currentTeam) {
        showAlert('warning', 'Selectionnez une equipe d\'abord');
        return;
    }
    document.getElementById('photoModalTeam').textContent = currentTeam;
    document.getElementById('photoModalOverlay').classList.remove('hidden');
    pendingPhotos = [];
    renderPendingPhotos();
    renderCurrentPhotos();
    if (!photoDropZoneSetup) {
        setupPhotoDragDrop();
        photoDropZoneSetup = true;
    }
}

function closePhotoModal() {
    document.getElementById('photoModalOverlay').classList.add('hidden');
    pendingPhotos = [];
    renderPendingPhotos();
}

function setupPhotoDragDrop() {
    const zone = document.getElementById('photoDropZone');
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(ev => {
        zone.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); });
    });
    zone.addEventListener('dragenter', () => zone.classList.add('drag-over'));
    zone.addEventListener('dragover', () => zone.classList.add('drag-over'));
    zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
    zone.addEventListener('drop', (e) => {
        zone.classList.remove('drag-over');
        handlePhotoFiles(e.dataTransfer.files);
    });
    document.getElementById('photoFileInput').addEventListener('change', (e) => {
        handlePhotoFiles(e.target.files);
        e.target.value = '';
    });
}

function handlePhotoFiles(fileList) {
    const VALID_EXTS = ['png', 'jpg', 'jpeg', 'webp', 'gif'];
    for (const file of fileList) {
        const ext = file.name.split('.').pop().toLowerCase();
        if (!VALID_EXTS.includes(ext)) {
            showAlert('warning', `${file.name} : format non supporte`);
            continue;
        }
        if (file.size > 5 * 1024 * 1024) {
            showAlert('warning', `${file.name} : trop lourd (max 5 Mo)`);
            continue;
        }
        const reader = new FileReader();
        reader.onload = (e) => {
            pendingPhotos.push({
                file: file,
                name: file.name,
                preview: e.target.result,
                base64: e.target.result.split(',')[1]
            });
            renderPendingPhotos();
        };
        reader.readAsDataURL(file);
    }
}

function renderPendingPhotos() {
    const container = document.getElementById('photoUploadPreview');
    const btn = document.getElementById('btnConfirmUpload');
    const countSpan = document.getElementById('photoUploadCount');

    container.innerHTML = '';
    if (pendingPhotos.length === 0) {
        btn.classList.add('hidden');
        return;
    }

    btn.classList.remove('hidden');
    countSpan.textContent = pendingPhotos.length;

    pendingPhotos.forEach((photo, idx) => {
        const div = document.createElement('div');
        div.className = 'photo-preview-item';

        const img = document.createElement('img');
        img.src = photo.preview;

        const delBtn = document.createElement('button');
        delBtn.className = 'photo-delete-btn';
        delBtn.textContent = '\u00d7';
        delBtn.onclick = () => {
            pendingPhotos.splice(idx, 1);
            renderPendingPhotos();
        };

        const nameLabel = document.createElement('div');
        nameLabel.className = 'photo-name-label';
        nameLabel.textContent = photo.name;

        div.appendChild(img);
        div.appendChild(delBtn);
        div.appendChild(nameLabel);
        container.appendChild(div);
    });
}

async function renderCurrentPhotos() {
    const container = document.getElementById('currentPhotosGrid');
    container.innerHTML = '';

    const photos = await loadPhotoIndexForTeam(currentTeam);
    if (photos.length === 0) {
        container.innerHTML = '<p style="color:#94a3b8; grid-column: 1/-1;">Aucune photo pour cette equipe</p>';
        return;
    }

    photos.forEach(filename => {
        const div = document.createElement('div');
        div.className = 'current-photo-item';

        const img = document.createElement('img');
        img.src = `Effectifs/${currentTeam}/${filename}`;
        img.onerror = function() {
            this.style.display = 'none';
        };

        const delBtn = document.createElement('button');
        delBtn.className = 'photo-delete-btn';
        delBtn.textContent = '\u00d7';
        delBtn.onclick = () => deleteExistingPhoto(filename);

        const nameLabel = document.createElement('div');
        nameLabel.className = 'photo-name-label';
        nameLabel.textContent = filename;

        div.appendChild(img);
        div.appendChild(delBtn);
        div.appendChild(nameLabel);
        container.appendChild(div);
    });
}

async function confirmPhotoUpload() {
    if (pendingPhotos.length === 0) return;

    const statusEl = document.getElementById('photoUploadStatus');
    const statusText = document.getElementById('photoUploadStatusText');
    const confirmBtn = document.getElementById('btnConfirmUpload');
    statusEl.classList.remove('hidden');
    confirmBtn.classList.add('hidden');

    try {
        const BATCH_SIZE = 3;
        for (let i = 0; i < pendingPhotos.length; i += BATCH_SIZE) {
            const batch = pendingPhotos.slice(i, i + BATCH_SIZE);
            const batchEnd = Math.min(i + BATCH_SIZE, pendingPhotos.length);
            statusText.textContent = `Envoi ${i + 1}-${batchEnd} / ${pendingPhotos.length}...`;

            const resp = await fetch('/.netlify/functions/upload-photos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    teamName: currentTeam,
                    photos: batch.map(p => ({
                        filename: p.name,
                        base64data: p.base64
                    })),
                    deletions: []
                })
            });

            const result = await resp.json();
            if (!resp.ok) throw new Error(result.error || 'Erreur serveur ' + resp.status);

            // Mettre a jour le cache local immediatement
            if (result.photosIndex) {
                if (typeof PHOTOS_INDEX !== 'undefined') {
                    for (const key of Object.keys(result.photosIndex)) {
                        PHOTOS_INDEX[key] = result.photosIndex[key];
                    }
                } else {
                    window.PHOTOS_INDEX = result.photosIndex;
                }
                delete photosCache[currentTeam];
                if (result.photosIndex[currentTeam]) {
                    photosCache[currentTeam] = result.photosIndex[currentTeam];
                }
            }
        }

        showAlert('success', `${pendingPhotos.length} photo(s) uploadee(s) pour ${currentTeam}. Netlify redeploit dans ~30s.`);
        pendingPhotos = [];
        renderPendingPhotos();
        renderCurrentPhotos();

    } catch (err) {
        showAlert('error', `Upload echoue : ${err.message}`);
    } finally {
        statusEl.classList.add('hidden');
    }
}

async function deleteExistingPhoto(filename) {
    if (!confirm(`Supprimer ${filename} ?`)) return;

    const statusEl = document.getElementById('photoUploadStatus');
    const statusText = document.getElementById('photoUploadStatusText');
    statusEl.classList.remove('hidden');
    statusText.textContent = 'Suppression en cours...';

    try {
        const resp = await fetch('/.netlify/functions/upload-photos', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                teamName: currentTeam,
                photos: [],
                deletions: [filename]
            })
        });

        const result = await resp.json();
        if (!resp.ok) throw new Error(result.error || 'Erreur serveur');

        if (result.photosIndex) {
            if (typeof PHOTOS_INDEX !== 'undefined') {
                for (const key of Object.keys(result.photosIndex)) {
                    PHOTOS_INDEX[key] = result.photosIndex[key];
                }
            } else {
                window.PHOTOS_INDEX = result.photosIndex;
            }
            delete photosCache[currentTeam];
            if (result.photosIndex[currentTeam]) {
                photosCache[currentTeam] = result.photosIndex[currentTeam];
            }
        }

        showAlert('success', `Photo supprimee`);
        renderCurrentPhotos();

    } catch (err) {
        showAlert('error', `Suppression echouee : ${err.message}`);
    } finally {
        statusEl.classList.add('hidden');
    }
}

// Rafraichir photos-index.js depuis le serveur (cache-busting)
async function refreshPhotosIndex() {
    try {
        const resp = await fetch('photos-index.js?_t=' + Date.now(), { cache: 'no-cache' });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const jsText = await resp.text();

        const match = jsText.match(/var\s+PHOTOS_INDEX\s*=\s*(\{[\s\S]*\})\s*;/);
        if (match && match[1]) {
            const freshIndex = JSON.parse(match[1]);
            if (typeof PHOTOS_INDEX !== 'undefined') {
                for (const key of Object.keys(freshIndex)) {
                    PHOTOS_INDEX[key] = freshIndex[key];
                }
            } else {
                window.PHOTOS_INDEX = freshIndex;
            }
            photosCache = {};
            console.log('‚úÖ photos-index.js rafraichi depuis le serveur (' + Object.keys(freshIndex).length + ' equipes)');
        }
    } catch (err) {
        console.warn('‚ö†Ô∏è Refresh photos-index.js echoue:', err.message);
    }
}


async function renderPlayerCards(data) {
    const filtered = applyFilters(data);
    const container = document.getElementById('playerCardsContainer');
    container.innerHTML = '';
    
    // Group players by position
    const playersByPosition = groupPlayersByPosition(filtered);
    
    // Position order and labels
    const positions = [
        { key: 'ALG', label: 'ALG - Ailier Gauche' },
        { key: 'ALD', label: 'ALD - Ailier Droit' },
        { key: 'ARG', label: 'ARG - Arri√®re Gauche' },
        { key: 'DC', label: 'DC - Demi-Centre' },
        { key: 'ARD', label: 'ARD - Arri√®re Droit' },
        { key: 'PIV', label: 'PIV - Pivot' },
        { key: 'GB', label: 'GB - Gardien' }
    ];
    
    for (const pos of positions) {
        const players = playersByPosition[pos.key] || [];
        if (players.length === 0) continue;
        
        const group = document.createElement('div');
        group.className = 'position-group';
        
        const title = document.createElement('div');
        title.className = 'position-title';
        title.textContent = pos.label;
        group.appendChild(title);
        
        const row = document.createElement('div');
        row.className = 'player-cards-row';
        
        for (const player of players) {
            const card = await createPlayerCard(player, pos.key);
            row.appendChild(card);
        }
        
        group.appendChild(row);
        container.appendChild(group);
    }
}

function groupPlayersByPosition(data) {
    const positions = {};
    const playerStats = {};
    const playerPositions = {}; // Track position frequency for each player
    
    // Calculate stats for each player
    data.forEach(row => {
        const joueur = row.raw['#14 joueurs'];
        const poste = row.raw['#15.1 poste'];
        
        if (!joueur || joueur === 'x' || !joueur.trim()) return;
        
        // Initialize player
        if (!playerStats[joueur]) {
            playerStats[joueur] = {
                name: joueur,
                position: '', // Will be set to most frequent position
                butHPY: 0,
                tirHPY: 0,
                butPY: 0,
                tirPY: 0,
                passes: 0
            };
            playerPositions[joueur] = {}; // Track position counts
        }
        
        // Count position occurrences (for determining most frequent position)
        if (poste && poste !== 'x' && poste.trim()) {
            const normalizedPoste = poste.toUpperCase().trim();
            playerPositions[joueur][normalizedPoste] = (playerPositions[joueur][normalizedPoste] || 0) + 1;
        }
        
        // Accumulate stats
        const colButHPY = (row.raw['|a00| but'] || '').trim();
        const colTirHPY = (row.raw['|a00| tir'] || '').trim();
        const colButPY = (row.raw['|a01| but py'] || '').trim();
        const colTirPY = (row.raw['|a01| tir py'] || '').trim();
        
        if (colButHPY === joueur) playerStats[joueur].butHPY++;
        if (colTirHPY === joueur && colTirHPY !== 'x') playerStats[joueur].tirHPY++;
        if (colButPY === joueur) playerStats[joueur].butPY++;
        if (colTirPY === joueur) playerStats[joueur].tirPY++;
        
        // Passes (count from passer columns)
        const colPPiv = (row.raw['|a06| p. piv'] || '').trim();
        const colPAilG = (row.raw['|a07| p. ail G'] || '').trim();
        const colPAilD = (row.raw['|a08| p. ail D'] || '').trim();
        
        if (colPPiv === joueur) playerStats[joueur].passes++;
        if (colPAilG === joueur) playerStats[joueur].passes++;
        if (colPAilD === joueur) playerStats[joueur].passes++;
    });
    
    // Set most frequent position for each player
    Object.keys(playerStats).forEach(joueur => {
        const posteFreqs = playerPositions[joueur];
        let maxCount = 0;
        let mostFrequentPoste = 'UNKNOWN';
        
        for (const [poste, count] of Object.entries(posteFreqs)) {
            if (count > maxCount) {
                maxCount = count;
                mostFrequentPoste = poste;
            }
        }
        
        playerStats[joueur].position = mostFrequentPoste;
        console.log(`${joueur}: ${mostFrequentPoste} (${maxCount} occurrences)`);
    });
    
    // Group by position
    Object.values(playerStats).forEach(player => {
        const pos = player.position;
        if (!positions[pos]) positions[pos] = [];
        positions[pos].push(player);
    });
    
    console.log('Players grouped by position (most frequent):', positions);
    
    // Sort by number within each position
    Object.keys(positions).forEach(pos => {
        positions[pos].sort((a, b) => {
            const numA = parseInt(a.name.match(/\d+/)?.[0] || '999');
            const numB = parseInt(b.name.match(/\d+/)?.[0] || '999');
            return numA - numB;
        });
    });
    
    return positions;
}

async function createPlayerCard(player, position) {
    const card = document.createElement('div');
    card.className = 'player-card';
    card.onclick = () => openPlayerDetail(player);
    
    // Extract number from name (e.g., "19 Nemanja" -> 19)
    const number = player.name.match(/(\d+)\s+(.+)/);
    const playerNumber = number ? number[1] : '';
    const playerName = number ? number[2] : player.name;
    
    // Calculate shooting stats
    const totalButs = player.butHPY + player.butPY;
    const totalTirs = player.tirHPY + player.tirPY;
    const shootPct = totalTirs > 0 ? ((totalButs / totalTirs) * 100).toFixed(0) : 0;
    
    // Try to find photo (use full name with number for mapping)
    const photoPath = await findPlayerPhoto(player.name, playerNumber);
    
    // Create elements manually to avoid HTML encoding issues
    const img = document.createElement('img');
    img.className = 'player-photo';
    img.src = photoPath;
    img.onerror = function() {
        // Fallback to SVG placeholder
        this.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="140" height="140"%3E%3Crect fill="%23334155" width="140" height="140"/%3E%3Ctext x="50%25" y="50%25" dominant-baseline="middle" text-anchor="middle" font-size="48" fill="%23fff"%3E' + playerNumber + '%3C/text%3E%3C/svg%3E';
    };
    
    const numDiv = document.createElement('div');
    numDiv.className = 'player-number';
    numDiv.textContent = '#' + playerNumber;
    
    const nameDiv = document.createElement('div');
    nameDiv.className = 'player-name';
    nameDiv.textContent = playerName;
    
    const shootDiv = document.createElement('div');
    shootDiv.className = 'player-shoot';
    shootDiv.textContent = `${totalButs}/${totalTirs} (${shootPct}%)`;
    
    const badgeDiv = document.createElement('div');
    badgeDiv.className = 'player-position-badge';
    badgeDiv.textContent = position;
    
    card.appendChild(img);
    card.appendChild(numDiv);
    card.appendChild(nameDiv);
    card.appendChild(shootDiv);
    card.appendChild(badgeDiv);
    
    return card;
}

async function findPlayerPhoto(name, number) {
    const teamName = currentTeam || 'Fenix';
    
    console.log('üîç Recherche automatique pour:', { name, number, teamName });
    
    // Charger l'index des photos pour cette √©quipe
    const photoFiles = await loadPhotoIndexForTeam(teamName);
    
    if (photoFiles.length === 0) {
        console.warn('‚ö†Ô∏è Aucune photo disponible pour l\'√©quipe:', teamName);
        return generatePlaceholder(number);
    }
    
    // Extract name parts (remove number)
    // "19 Nemanja" ‚Üí ["Nemanja"]
    const nameParts = name.split(/\s+/).filter(part => isNaN(part));
    
    // Normalize for matching (lowercase, no accents, no special chars)
    const normalizedParts = nameParts.map(part => 
        part.toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "") // Remove accents
            .replace(/[^a-z]/g, '') // Keep only letters
    ).filter(part => part.length > 0); // Remove empty strings
    
    console.log('  Termes de recherche normalis√©s:', normalizedParts);
    
    // Find best match
    for (const filename of photoFiles) {
        const normalizedFilename = filename.toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "");
        
        // Check if all name parts appear in filename
        const allPartsMatch = normalizedParts.every(part => 
            normalizedFilename.includes(part)
        );
        
        if (allPartsMatch) {
            const path = `Effectifs/${teamName}/${filename}`;
            console.log('‚úÖ Photo trouv√©e:', path);
            return path;
        }
    }
    
    // If no exact match, try partial match (at least one name part)
    console.log('  Tentative de match partiel...');
    for (const filename of photoFiles) {
        const normalizedFilename = filename.toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "");
        
        // Check if at least one name part appears
        const hasPartialMatch = normalizedParts.some(part => 
            normalizedFilename.includes(part)
        );
        
        if (hasPartialMatch) {
            const path = `Effectifs/${teamName}/${filename}`;
            console.log('‚ö†Ô∏è Match partiel trouv√©:', path);
            return path;
        }
    }
    
    console.warn('‚ùå Aucune photo trouv√©e pour:', name);
    return generatePlaceholder(number);
}

function generatePlaceholder(number) {
    return `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='140' height='140'%3E%3Crect fill='%23334155' width='140' height='140'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='48' fill='%23fff'%3E${number}%3C/text%3E%3C/svg%3E`;
}

// Helper function to construct LNH player URL (for future use)
function getLNHPlayerURL(firstName, lastName) {
    const normalizedFirst = firstName.toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/\s+/g, '-');
    const normalizedLast = lastName.toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/\s+/g, '-');
    
    return `https://www.lnh.fr/liquimoly-starligue/joueurs/${normalizedFirst}-${normalizedLast}`;
}

async function openPlayerDetail(player) {
    currentPlayerData = player;
    currentPlayerTab = 'match';

    const panel = document.getElementById('playerDetailPanel');
    panel.classList.remove('hidden');

    // Render player info
    await renderPlayerInfo(player);
    
    // Render initial tab (MATCH)
    renderPlayerDetailTab('match', player);
    
    // Update active tab
    document.querySelectorAll('.detail-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.tab === 'match') tab.classList.add('active');
    });
}

function closePlayerDetail() {
    document.getElementById('playerDetailPanel').classList.add('hidden');
    currentPlayerData = null;
}

async function renderPlayerInfo(player) {
    const number = player.name.match(/(\d+)\s+(.+)/);
    const playerNumber = number ? number[1] : '';
    const playerName = number ? number[2] : player.name;

    const totalButs = player.butHPY + player.butPY;
    const totalTirs = player.tirHPY + player.tirPY;
    const shootPct = totalTirs > 0 ? ((totalButs / totalTirs) * 100).toFixed(0) : 0;

    const photoPath = await findPlayerPhoto(player.name, playerNumber);
    
    const container = document.getElementById('detailPlayerInfo');
    container.innerHTML = `
        <img src="${photoPath}" class="detail-player-photo" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22150%22 height=%22150%22><rect fill=%22%23334155%22 width=%22150%22 height=%22150%22/><text x=%2250%%22 y=%2250%%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-size=%2260%22 fill=%22%23fff%22>${playerNumber}</text></svg>'">
        <div class="detail-player-text">
            <h2>${playerNumber} ${playerName}</h2>
            <p style="font-size: 1.2rem; color: var(--blue);">${player.position} ‚Ä¢ #${playerNumber}</p>
            <p style="font-size: 1.1rem; color: var(--white); margin-top: 1rem;">
                <strong>${totalButs}/${totalTirs} (${shootPct}%)</strong> ‚Ä¢ ${player.passes} passes
            </p>
        </div>
    `;
}

function switchPlayerTab(tab) {
    currentPlayerTab = tab;
    
    // Update active tab
    document.querySelectorAll('.detail-tab').forEach(t => {
        t.classList.remove('active');
        if (t.dataset.tab === tab) t.classList.add('active');
    });
    
    // Render tab content
    renderPlayerDetailTab(tab, currentPlayerData);
}

function renderPlayerDetailTab(tab, player) {
    const container = document.getElementById('detailTableContainer');
    
    // Filter data for this player only
    const filtered = applyFilters(allTeamData);
    const playerData = filtered.filter(row => {
        const joueur = row.raw['#14 joueurs'];
        return joueur === player.name;
    });
    
    if (playerData.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--grey); padding: 2rem;">Aucune donn√©e pour ce joueur</p>';
        return;
    }
    
    // Create table based on tab
    if (tab === 'match') {
        renderPlayerMatchTable(playerData, container);
    } else if (tab === 'jeu') {
        renderPlayerJeuTable(playerData, container);
    } else if (tab === 'num') {
        renderPlayerNumTable(playerData, container);
    }
}

function renderPlayerMatchTable(data, container) {
    // Group by match
    const matches = {};
    data.forEach(row => {
        const match = row.raw['[M] rencontre'];
        if (!match) return;
        if (!matches[match]) matches[match] = [];
        matches[match].push(row);
    });
    
    // Build table
    let html = `
        <table>
            <thead>
                <tr>
                    <th>Match</th>
                    <th>Shoot</th>
                    <th>HPY</th>
                    <th>PY</th>
                    <th>Py obt</th>
                    <th>2' obt</th>
                    <th>Pdb</th>
                    <th>N</th>
                    <th>Passe</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    let totals = { butHPY: 0, tirHPY: 0, butPY: 0, tirPY: 0, pyObt: 0, min2Obt: 0, pdb: 0, neutralise: 0, passe: 0 };
    
    Object.entries(matches).forEach(([matchName, matchData]) => {
        const stats = calculatePlayerStats(matchData, currentPlayerData.name);
        
        totals.butHPY += stats.butHPY;
        totals.tirHPY += stats.tirHPY;
        totals.butPY += stats.butPY;
        totals.tirPY += stats.tirPY;
        totals.pyObt += stats.pyObt;
        totals.min2Obt += stats.min2Obt;
        totals.pdb += stats.pdb;
        totals.neutralise += stats.neutralise;
        totals.passe += stats.passe;
        
        const shootVal = `${stats.butHPY + stats.butPY}/${stats.tirHPY + stats.tirPY} (${stats.shootTir > 0 ? ((stats.shootBut / stats.shootTir) * 100).toFixed(0) : 0}%)`;
        const hpyVal = `${stats.butHPY}/${stats.tirHPY} (${stats.tirHPY > 0 ? ((stats.butHPY / stats.tirHPY) * 100).toFixed(0) : 0}%)`;
        const pyVal = `${stats.butPY}/${stats.tirPY} (${stats.tirPY > 0 ? ((stats.butPY / stats.tirPY) * 100).toFixed(0) : 0}%)`;
        
        html += `
            <tr>
                <td>${matchName}</td>
                <td>${formatValue(shootVal, 'ratio')}</td>
                <td>${formatValue(hpyVal, 'ratio')}</td>
                <td>${formatValue(pyVal, 'ratio')}</td>
                <td>${formatValue(stats.pyObt, 'number')}</td>
                <td>${formatValue(stats.min2Obt, 'number')}</td>
                <td>${formatValue(stats.pdb, 'number')}</td>
                <td>${formatValue(stats.neutralise, 'number')}</td>
                <td>${formatValue(stats.passe, 'number')}</td>
            </tr>
        `;
    });
    
    // Total row
    const totalShootPct = (totals.tirHPY + totals.tirPY) > 0 ? (((totals.butHPY + totals.butPY) / (totals.tirHPY + totals.tirPY)) * 100).toFixed(0) : 0;
    const totalHpyPct = totals.tirHPY > 0 ? ((totals.butHPY / totals.tirHPY) * 100).toFixed(0) : 0;
    const totalPyPct = totals.tirPY > 0 ? ((totals.butPY / totals.tirPY) * 100).toFixed(0) : 0;
    
    html += `
            <tr class="total-row">
                <td>Total</td>
                <td>${totals.butHPY + totals.butPY}/${totals.tirHPY + totals.tirPY} (${totalShootPct}%)</td>
                <td>${totals.butHPY}/${totals.tirHPY} (${totalHpyPct}%)</td>
                <td>${totals.butPY}/${totals.tirPY} (${totalPyPct}%)</td>
                <td>${totals.pyObt}</td>
                <td>${totals.min2Obt}</td>
                <td>${totals.pdb}</td>
                <td>${totals.neutralise}</td>
                <td>${totals.passe}</td>
            </tr>
        </tbody>
    </table>
    `;
    
    container.innerHTML = html;
}

function renderPlayerJeuTable(data, container) {
    // Similar to match but grouped by phase
    container.innerHTML = '<p style="text-align: center; color: var(--grey); padding: 2rem;">Vue JEU en cours de d√©veloppement</p>';
}

function renderPlayerNumTable(data, container) {
    // Similar to match but grouped by num phase
    container.innerHTML = '<p style="text-align: center; color: var(--grey); padding: 2rem;">Vue NUM en cours de d√©veloppement</p>';
}

function calculatePlayerStats(data, playerName) {
    const stats = {
        butHPY: 0, tirHPY: 0, butPY: 0, tirPY: 0,
        shootBut: 0, shootTir: 0,
        pyObt: 0, min2Obt: 0, pdb: 0, neutralise: 0, passe: 0
    };
    
    data.forEach(row => {
        const colButHPY = (row.raw['|a00| but'] || '').trim();
        const colTirHPY = (row.raw['|a00| tir'] || '').trim();
        const colButPY = (row.raw['|a01| but py'] || '').trim();
        const colTirPY = (row.raw['|a01| tir py'] || '').trim();
        const colPyObt = (row.raw['|a03| py obt'] || '').trim();
        const colMin2Obt = (row.raw["|a04| 2' obt"] || '').trim();
        const colPdb = (row.raw['|a18| pdb'] || '').trim();
        const colNeutralise = (row.raw['|a19| neutralis√©'] || '').trim();
        const colPPiv = (row.raw['|a06| p. piv'] || '').trim();
        const colPAilG = (row.raw['|a07| p. ail G'] || '').trim();
        const colPAilD = (row.raw['|a08| p. ail D'] || '').trim();
        
        if (colButHPY === playerName) stats.butHPY++;
        if (colTirHPY === playerName && colTirHPY !== 'x') stats.tirHPY++;
        if (colButPY === playerName) stats.butPY++;
        if (colTirPY === playerName) stats.tirPY++;
        if (colPyObt === playerName) stats.pyObt++;
        if (colMin2Obt === playerName) stats.min2Obt++;
        if (colPdb === playerName) stats.pdb++;
        if (colNeutralise === playerName) stats.neutralise++;
        if (colPPiv === playerName) stats.passe++;
        if (colPAilG === playerName) stats.passe++;
        if (colPAilD === playerName) stats.passe++;
    });
    
    stats.shootBut = stats.butHPY + stats.butPY;
    stats.shootTir = stats.tirHPY + stats.tirPY;
    
    return stats;
}

// Search functionality
document.getElementById('playerSearch')?.addEventListener('input', (e) => {
    const search = e.target.value.toLowerCase();
    document.querySelectorAll('.player-card').forEach(card => {
        const name = card.querySelector('.player-name').textContent.toLowerCase();
        const number = card.querySelector('.player-number').textContent.toLowerCase();
        if (name.includes(search) || number.includes(search)) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
});


// ============================================
// ONGLET MATCH - TOUTES LES FONCTIONS
// ============================================

function renderAllMatchTables(data) {
    const filtered = applyFilters(data);
    
    // Group data by match
    const matches = groupByMatch(filtered);
    
    // For match, each match is its own "average" (1 match)
    const matchCount = 1;
    
    // Render each table
    renderTableMatchGlobal(matches, matchCount);
    renderTableMatchHPY(matches, matchCount);
    renderTableMatchPY(matches, matchCount);
    renderTableMatchSanction(matches, matchCount);
    renderTableMatchRelation(matches, matchCount);
    renderTableMatchPdb(matches, matchCount);
    renderTableMatchNeutralise(matches, matchCount);
}

function groupByMatch(data) {
    const matches = {};
    
    console.log(`Grouping by match`);
    console.log(`Total filtered rows: ${data.length}`);
    
    data.forEach(row => {
        const matchName = row.raw['[M] rencontre'];
        if (!matchName || !matchName.trim()) return;
        
        if (!matches[matchName]) {
            matches[matchName] = { data: [], subPhases: {} };
        }
        
        matches[matchName].data.push(row);
    });
    
    console.log('Match grouping results:');
    Object.entries(matches).forEach(([name, matchData]) => {
        console.log(`  ${name}: ${matchData.data.length} rows`);
    });
    
    return matches;
}

// GLOBAL TABLE
function renderTableMatchGlobal(matches, matchCount) {
    const tbody = document.getElementById('tableMatchGlobal');
    tbody.innerHTML = '';
    
    const formatRow = (name, stats, icon, isSub = false) => {
        const shootVal = `${stats.shootBut}/${stats.shootTir} (${stats.shootPct}%)`;
        const hpyVal = `${stats.butHPY}/${stats.tirHPY} (${stats.hpyPct}%)`;
        const pyVal = `${stats.butPY}/${stats.tirPY} (${stats.pyPct}%)`;
        const indent = isSub ? 'padding-left: 2rem;' : '';
        
        return `
            <td style="${indent}">${icon}${name}</td>
            <td>${formatValue(shootVal, 'ratio')}</td>
            <td>${formatValue(hpyVal, 'ratio')}</td>
            <td>${formatValue(pyVal, 'ratio')}</td>
            <td>${formatValue(stats.pyObt, 'number')}</td>
            <td>${formatValue(stats.min2Obt, 'number')}</td>
            <td>${formatValue(stats.pdb, 'number')}</td>
            <td>${formatValue(stats.neutralise, 'number')}</td>
            <td>${formatValue(stats.passe, 'number')}</td>
        `;
    };
    
    const totals = renderPhaseRows(tbody, matches, 9, formatRow);
    
    if (!totals) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: var(--grey);">Aucune donn√©e</td></tr>';
        return;
    }
    
    // Recalculate percentages for totals
    const totalShootPct = totals.shootTir > 0 ? ((totals.shootBut / totals.shootTir) * 100).toFixed(0) : 0;
    const totalHpyPct = totals.tirHPY > 0 ? ((totals.butHPY / totals.tirHPY) * 100).toFixed(0) : 0;
    const totalPyPct = totals.tirPY > 0 ? ((totals.butPY / totals.tirPY) * 100).toFixed(0) : 0;
    
    // Total row
    const trTotal = document.createElement('tr');
    trTotal.className = 'total-row';
    trTotal.innerHTML = `
        <td>Total</td>
        <td>${totals.shootBut}/${totals.shootTir} (${totalShootPct}%)</td>
        <td>${totals.butHPY}/${totals.tirHPY} (${totalHpyPct}%)</td>
        <td>${totals.butPY}/${totals.tirPY} (${totalPyPct}%)</td>
        <td>${totals.pyObt}</td>
        <td>${totals.min2Obt}</td>
        <td>${totals.pdb}</td>
        <td>${totals.neutralise}</td>
        <td>${totals.passe}</td>
    `;
    tbody.appendChild(trTotal);
    
    // Average row (divide by number of matches)
    const numMatches = Object.keys(matches).length;
    if (numMatches > 0) {
        const trAvg = document.createElement('tr');
        trAvg.style.background = 'rgba(102, 159, 183, 0.2)';
        trAvg.innerHTML = `
            <td>Moyenne</td>
            <td>${(totals.shootBut / numMatches).toFixed(1)}/${(totals.shootTir / numMatches).toFixed(1)}</td>
            <td>${(totals.butHPY / numMatches).toFixed(1)}/${(totals.tirHPY / numMatches).toFixed(1)}</td>
            <td>${(totals.butPY / numMatches).toFixed(1)}/${(totals.tirPY / numMatches).toFixed(1)}</td>
            <td>${(totals.pyObt / numMatches).toFixed(1)}</td>
            <td>${(totals.min2Obt / numMatches).toFixed(1)}</td>
            <td>${(totals.pdb / numMatches).toFixed(1)}</td>
            <td>${(totals.neutralise / numMatches).toFixed(1)}</td>
            <td>${(totals.passe / numMatches).toFixed(1)}</td>
        `;
        tbody.appendChild(trAvg);
    }
    
    document.getElementById('matchGlobalStats').textContent = `${totals.shootBut}/${totals.shootTir} (${totalShootPct}%)`;
    
    enableSorting('tableMatchGlobal', [
        { index: '1', type: 'shooting' },
        { index: '2', type: 'shooting' },
        { index: '3', type: 'shooting' },
        { index: '4', type: 'simple' },
        { index: '5', type: 'simple' },
        { index: '6', type: 'simple' },
        { index: '7', type: 'simple' },
        { index: '8', type: 'simple' }
    ]);
}

// HPY TABLE
function renderTableMatchHPY(matches, matchCount) {
    const tbody = document.getElementById('tableMatchHPY');
    tbody.innerHTML = '';
    
    const formatRow = (name, stats, icon, isSub = false) => {
        const hpyVal = `${stats.butHPY}/${stats.tirHPY} (${stats.hpyPct}%)`;
        const indent = isSub ? 'padding-left: 2rem;' : '';
        return `
            <td style="${indent}">${icon}${name}</td>
            <td>${formatValue(hpyVal, 'ratio')}</td>
        `;
    };
    
    const totals = renderPhaseRows(tbody, matches, 2, formatRow);
    
    if (!totals) {
        tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; color: var(--grey);">Aucune donn√©e</td></tr>';
        return;
    }
    
    const totalPct = totals.tirHPY > 0 ? ((totals.butHPY / totals.tirHPY) * 100).toFixed(0) : 0;
    
    const trTotal = document.createElement('tr');
    trTotal.className = 'total-row';
    trTotal.innerHTML = `
        <td>Total</td>
        <td>${totals.butHPY}/${totals.tirHPY} (${totalPct}%)</td>
    `;
    tbody.appendChild(trTotal);
    
    const numMatches = Object.keys(matches).length;
    if (numMatches > 0) {
        const trAvg = document.createElement('tr');
        trAvg.style.background = 'rgba(102, 159, 183, 0.2)';
        trAvg.innerHTML = `
            <td>Moyenne</td>
            <td>${(totals.butHPY / numMatches).toFixed(1)}/${(totals.tirHPY / numMatches).toFixed(1)}</td>
        `;
        tbody.appendChild(trAvg);
    }
    
    document.getElementById('matchHpyStats').textContent = `${totals.butHPY}/${totals.tirHPY} (${totalPct}%)`;
    
    enableSorting('tableMatchHPY', [{ index: '1', type: 'shooting' }]);
}

// PY TABLE
function renderTableMatchPY(matches, matchCount) {
    const tbody = document.getElementById('tableMatchPY');
    tbody.innerHTML = '';
    
    const formatRow = (name, stats, icon, isSub = false) => {
        const pyVal = `${stats.butPY}/${stats.tirPY} (${stats.pyPct}%)`;
        const indent = isSub ? 'padding-left: 2rem;' : '';
        return `
            <td style="${indent}">${icon}${name}</td>
            <td>${formatValue(pyVal, 'ratio')}</td>
        `;
    };
    
    const totals = renderPhaseRows(tbody, matches, 2, formatRow);
    
    if (!totals) {
        tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; color: var(--grey);">Aucune donn√©e</td></tr>';
        return;
    }
    
    const totalPct = totals.tirPY > 0 ? ((totals.butPY / totals.tirPY) * 100).toFixed(0) : 0;
    
    const trTotal = document.createElement('tr');
    trTotal.className = 'total-row';
    trTotal.innerHTML = `
        <td>Total</td>
        <td>${totals.butPY}/${totals.tirPY} (${totalPct}%)</td>
    `;
    tbody.appendChild(trTotal);
    
    const numMatches = Object.keys(matches).length;
    if (numMatches > 0) {
        const trAvg = document.createElement('tr');
        trAvg.style.background = 'rgba(102, 159, 183, 0.2)';
        trAvg.innerHTML = `
            <td>Moyenne</td>
            <td>${(totals.butPY / numMatches).toFixed(1)}/${(totals.tirPY / numMatches).toFixed(1)}</td>
        `;
        tbody.appendChild(trAvg);
    }
    
    document.getElementById('matchPyStats').textContent = `${totals.butPY}/${totals.tirPY} (${totalPct}%)`;
    
    enableSorting('tableMatchPY', [{ index: '1', type: 'shooting' }]);
}

// SANCTION TABLE
function renderTableMatchSanction(matches, matchCount) {
    const tbody = document.getElementById('tableMatchSanction');
    tbody.innerHTML = '';
    
    let grandTotals = { pyObt: 0, min2Obt: 0, min2Unique: 0, total: 0 };
    
    Object.entries(matches).forEach(([matchName, matchData]) => {
        if (matchData.data.length === 0) return;
        
        // Calculate unique 2' for this match
        let pyObt = 0, min2Obt = 0, min2Unique = 0;
        matchData.data.forEach(row => {
            const hasPy = row.raw['|a03| py obt'] && row.raw['|a03| py obt'].trim();
            const hasMin2 = row.raw['|a04| 2\' obt'] && row.raw['|a04| 2\' obt'].trim();
            
            if (hasPy) pyObt++;
            if (hasMin2) {
                min2Obt++;
                if (!hasPy) min2Unique++;
            }
        });
        
        const total = pyObt + min2Obt;
        const min2Val = `${min2Obt} (${min2Unique})`;
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${matchName}</td>
            <td>${formatValue(pyObt, 'number')}</td>
            <td>${formatValue(min2Val, 'ratio-paren')}</td>
            <td>${formatValue(total, 'number')}</td>
        `;
        
        tbody.appendChild(tr);
        
        grandTotals.pyObt += pyObt;
        grandTotals.min2Obt += min2Obt;
        grandTotals.min2Unique += min2Unique;
        grandTotals.total += total;
    });
    
    const trTotal = document.createElement('tr');
    trTotal.className = 'total-row';
    trTotal.innerHTML = `
        <td>Total</td>
        <td>${grandTotals.pyObt}</td>
        <td>${grandTotals.min2Obt} (${grandTotals.min2Unique})</td>
        <td>${grandTotals.total}</td>
    `;
    tbody.appendChild(trTotal);
    
    const numMatches = Object.keys(matches).length;
    if (numMatches > 0) {
        const trAvg = document.createElement('tr');
        trAvg.style.background = 'rgba(102, 159, 183, 0.2)';
        trAvg.innerHTML = `
            <td>Moyenne</td>
            <td>${(grandTotals.pyObt / numMatches).toFixed(1)}</td>
            <td>${(grandTotals.min2Obt / numMatches).toFixed(1)} (${(grandTotals.min2Unique / numMatches).toFixed(1)})</td>
            <td>${(grandTotals.total / numMatches).toFixed(1)}</td>
        `;
        tbody.appendChild(trAvg);
    }
    
    document.getElementById('matchSanctionStats').textContent = `${grandTotals.total}`;
    
    enableSorting('tableMatchSanction', [
        { index: '1', type: 'simple' },
        { index: '2', type: 'simple' },
        { index: '3', type: 'simple' }
    ]);
}

// RELATION TABLE
function renderTableMatchRelation(matches, matchCount) {
    const tbody = document.getElementById('tableMatchRelation');
    tbody.innerHTML = '';
    
    let grandTotals = { piv: 0, ailG: 0, ailD: 0 };
    
    Object.entries(matches).forEach(([matchName, matchData]) => {
        if (matchData.data.length === 0) return;
        
        let stats = { piv: 0, ailG: 0, ailD: 0 };
        matchData.data.forEach(row => {
            if (row.raw['|a06| p. piv'] && row.raw['|a06| p. piv'].trim() && row.raw['|a06| p. piv'].trim() !== 'x') stats.piv++;
            if (row.raw['|a07| p. ail G'] && row.raw['|a07| p. ail G'].trim() && row.raw['|a07| p. ail G'].trim() !== 'x') stats.ailG++;
            if (row.raw['|a08| p. ail D'] && row.raw['|a08| p. ail D'].trim() && row.raw['|a08| p. ail D'].trim() !== 'x') stats.ailD++;
        });
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${matchName}</td>
            <td>${formatValue(stats.piv, 'number')}</td>
            <td>${formatValue(stats.ailG, 'number')}</td>
            <td>${formatValue(stats.ailD, 'number')}</td>
        `;
        
        tbody.appendChild(tr);
        
        grandTotals.piv += stats.piv;
        grandTotals.ailG += stats.ailG;
        grandTotals.ailD += stats.ailD;
    });
    
    const trTotal = document.createElement('tr');
    trTotal.className = 'total-row';
    trTotal.innerHTML = `
        <td>Total</td>
        <td>${grandTotals.piv}</td>
        <td>${grandTotals.ailG}</td>
        <td>${grandTotals.ailD}</td>
    `;
    tbody.appendChild(trTotal);
    
    const numMatches = Object.keys(matches).length;
    if (numMatches > 0) {
        const trAvg = document.createElement('tr');
        trAvg.style.background = 'rgba(102, 159, 183, 0.2)';
        trAvg.innerHTML = `
            <td>Moyenne</td>
            <td>${(grandTotals.piv / numMatches).toFixed(1)}</td>
            <td>${(grandTotals.ailG / numMatches).toFixed(1)}</td>
            <td>${(grandTotals.ailD / numMatches).toFixed(1)}</td>
        `;
        tbody.appendChild(trAvg);
    }
    
    const totalPasses = grandTotals.piv + grandTotals.ailG + grandTotals.ailD;
    document.getElementById('matchRelationStats').textContent = `${totalPasses}`;
    
    enableSorting('tableMatchRelation', [
        { index: '1', type: 'simple' },
        { index: '2', type: 'simple' },
        { index: '3', type: 'simple' }
    ]);
}

// PDB TABLE
function renderTableMatchPdb(matches, matchCount) {
    const tbody = document.getElementById('tableMatchPdb');
    tbody.innerHTML = '';
    
    const formatRow = (name, stats, icon, isSub = false) => {
        const indent = isSub ? 'padding-left: 2rem;' : '';
        return `
            <td style="${indent}">${icon}${name}</td>
            <td>${formatValue(stats.pdb, 'number')}</td>
        `;
    };
    
    const totals = renderPhaseRows(tbody, matches, 2, formatRow);
    
    if (!totals) {
        tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; color: var(--grey);">Aucune donn√©e</td></tr>';
        return;
    }
    
    const trTotal = document.createElement('tr');
    trTotal.className = 'total-row';
    trTotal.innerHTML = `
        <td>Total</td>
        <td>${totals.pdb}</td>
    `;
    tbody.appendChild(trTotal);
    
    const numMatches = Object.keys(matches).length;
    if (numMatches > 0) {
        const trAvg = document.createElement('tr');
        trAvg.style.background = 'rgba(102, 159, 183, 0.2)';
        trAvg.innerHTML = `
            <td>Moyenne</td>
            <td>${(totals.pdb / numMatches).toFixed(1)}</td>
        `;
        tbody.appendChild(trAvg);
    }
    
    document.getElementById('matchPdbStats').textContent = `${totals.pdb}`;
    
    enableSorting('tableMatchPdb', [{ index: '1', type: 'simple' }]);
}

// NEUTRALISE TABLE
function renderTableMatchNeutralise(matches, matchCount) {
    const tbody = document.getElementById('tableMatchNeutralise');
    tbody.innerHTML = '';
    
    const formatRow = (name, stats, icon, isSub = false) => {
        const indent = isSub ? 'padding-left: 2rem;' : '';
        return `
            <td style="${indent}">${icon}${name}</td>
            <td>${formatValue(stats.neutralise, 'number')}</td>
        `;
    };
    
    const totals = renderPhaseRows(tbody, matches, 2, formatRow);
    
    if (!totals) {
        tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; color: var(--grey);">Aucune donn√©e</td></tr>';
        return;
    }
    
    const trTotal = document.createElement('tr');
    trTotal.className = 'total-row';
    trTotal.innerHTML = `
        <td>Total</td>
        <td>${totals.neutralise}</td>
    `;
    tbody.appendChild(trTotal);
    
    const numMatches = Object.keys(matches).length;
    if (numMatches > 0) {
        const trAvg = document.createElement('tr');
        trAvg.style.background = 'rgba(102, 159, 183, 0.2)';
        trAvg.innerHTML = `
            <td>Moyenne</td>
            <td>${(totals.neutralise / numMatches).toFixed(1)}</td>
        `;
        tbody.appendChild(trAvg);
    }
    
    document.getElementById('matchNeutraliseStats').textContent = `${totals.neutralise}`;
    
    enableSorting('tableMatchNeutralise', [{ index: '1', type: 'simple' }]);
}


// ============================================
// ONGLET JEU - TOUTES LES FONCTIONS CORRIG√âES
// ============================================

function renderAllJeuTables(data) {
    const filtered = applyFilters(data);
    
    // Group data by game phase
    const phases = groupByGamePhase(filtered);
    
    // Count unique matches for average calculation
    const matchCount = new Set(filtered.map(row => row.raw['[M] rencontre'])).size;
    
    // Render each table
    renderTableJeuGlobal(phases, matchCount);
    renderTableJeuHPY(phases, matchCount);
    renderTableJeuPY(phases, matchCount);
    renderTableJeuSanction(phases, matchCount);
    renderTableJeuRelation(phases, matchCount);
    renderTableJeuPdb(phases, matchCount);
    renderTableJeuNeutralise(phases, matchCount);
}

function groupByGamePhase(data) {
    // Use global currentTeam variable
    if (!currentTeam) {
        console.warn('No team selected');
        return { 
            'Att p': { data: [], subPhases: {} }, 
            'MdB': { data: [], subPhases: {} }, 
            'Py': { data: [], subPhases: {} } 
        };
    }
    
    const phaseCol = `#03 Phase ${currentTeam}`;
    
    const phases = {
        'Att p': { data: [], subPhases: {} },
        'MdB': { data: [], subPhases: {} },
        'Py': { data: [], subPhases: {} }
    };
    
    console.log(`Grouping by phase for team: ${currentTeam}, using column: ${phaseCol}`);
    console.log(`Total filtered rows: ${data.length}`);
    
    data.forEach(row => {
        const phaseValue = (row.raw[phaseCol] || '').toLowerCase();
        
        if (!phaseValue) return;
        
        // Att p: contains "att al" OR "att √©tg" OR "rebond" (without "vs")
        if ((phaseValue.includes('att al') || phaseValue.includes('att √©tg') || phaseValue.includes('rebond')) && !phaseValue.includes('vs')) {
            phases['Att p'].data.push(row);
            
            // Sub-categories
            if (phaseValue.includes('att al')) {
                if (!phases['Att p'].subPhases['Att 0-6']) phases['Att p'].subPhases['Att 0-6'] = [];
                phases['Att p'].subPhases['Att 0-6'].push(row);
            }
            if (phaseValue.includes('att √©tg')) {
                if (!phases['Att p'].subPhases['Att 5-1']) phases['Att p'].subPhases['Att 5-1'] = [];
                phases['Att p'].subPhases['Att 5-1'].push(row);
            }
        }
        
        // MdB: contains "mdb" OR "er" OR "ca" (without "rpl" or "vs")
        if ((phaseValue.includes('mdb') || phaseValue.includes('er') || phaseValue.includes('ca')) && !phaseValue.includes('rpl') && !phaseValue.includes('vs')) {
            phases['MdB'].data.push(row);
        }
        
        // Py: contains "py" (without "vs")
        if (phaseValue.includes('py') && !phaseValue.includes('vs')) {
            phases['Py'].data.push(row);
        }
    });
    
    console.log('Phase grouping results:');
    Object.entries(phases).forEach(([name, phaseData]) => {
        console.log(`  ${name}: ${phaseData.data.length} rows`);
        if (Object.keys(phaseData.subPhases).length > 0) {
            Object.entries(phaseData.subPhases).forEach(([subName, subData]) => {
                console.log(`    ${subName}: ${subData.length} rows`);
            });
        }
    });
    
    return phases;
}

// Generic function to render phase rows with sub-phases
function renderPhaseRows(tbody, phases, columns, formatFunction) {
    let grandTotals = null;
    
    Object.entries(phases).forEach(([phaseName, phaseData]) => {
        if (phaseData.data.length === 0) return;
        
        const stats = calculatePhaseStats(phaseData.data);
        const hasSubPhases = Object.keys(phaseData.subPhases).length > 0;
        
        // Main phase row
        const tr = document.createElement('tr');
        tr.className = 'phase-row';
        
        const expandIcon = hasSubPhases ? '<span class="expand-icon" style="cursor: pointer; margin-right: 8px;">‚ñ∂</span>' : '';
        
        const cells = formatFunction(phaseName, stats, expandIcon);
        tr.innerHTML = cells;
        
        if (hasSubPhases) {
            tr.style.cursor = 'pointer';
            tr.onclick = () => toggleSubPhases(tr);
        }
        
        tbody.appendChild(tr);
        
        // Accumulate totals
        if (!grandTotals) {
            grandTotals = { ...stats };
        } else {
            for (const key in stats) {
                if (typeof stats[key] === 'number') {
                    grandTotals[key] += stats[key];
                }
            }
        }
        
        // Sub-phases
        if (hasSubPhases) {
            Object.entries(phaseData.subPhases).forEach(([subName, subData]) => {
                if (subData.length === 0) return;
                
                const subStats = calculatePhaseStats(subData);
                const trSub = document.createElement('tr');
                trSub.className = 'sub-phase-row hidden';
                trSub.style.cssText = 'background: rgba(102, 159, 183, 0.1);';
                
                const subCells = formatFunction(`‚Ü≥ ${subName}`, subStats, '', true);
                trSub.innerHTML = subCells;
                
                tbody.appendChild(trSub);
            });
        }
    });
    
    return grandTotals;
}

// GLOBAL TABLE
function renderTableJeuGlobal(phases, matchCount) {
    const tbody = document.getElementById('tableJeuGlobal');
    tbody.innerHTML = '';
    
    const formatRow = (name, stats, icon, isSub = false) => {
        const shootVal = `${stats.shootBut}/${stats.shootTir} (${stats.shootPct}%)`;
        const hpyVal = `${stats.butHPY}/${stats.tirHPY} (${stats.hpyPct}%)`;
        const pyVal = `${stats.butPY}/${stats.tirPY} (${stats.pyPct}%)`;
        const indent = isSub ? 'padding-left: 2rem;' : '';
        
        return `
            <td style="${indent}">${icon}${name}</td>
            <td>${formatValue(shootVal, 'ratio')}</td>
            <td>${formatValue(hpyVal, 'ratio')}</td>
            <td>${formatValue(pyVal, 'ratio')}</td>
            <td>${formatValue(stats.pyObt, 'number')}</td>
            <td>${formatValue(stats.min2Obt, 'number')}</td>
            <td>${formatValue(stats.pdb, 'number')}</td>
            <td>${formatValue(stats.neutralise, 'number')}</td>
            <td>${formatValue(stats.passe, 'number')}</td>
        `;
    };
    
    const totals = renderPhaseRows(tbody, phases, 9, formatRow);
    
    if (!totals) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: var(--grey);">Aucune donn√©e</td></tr>';
        return;
    }
    
    // Recalculate percentages for totals
    const totalShootPct = totals.shootTir > 0 ? ((totals.shootBut / totals.shootTir) * 100).toFixed(0) : 0;
    const totalHpyPct = totals.tirHPY > 0 ? ((totals.butHPY / totals.tirHPY) * 100).toFixed(0) : 0;
    const totalPyPct = totals.tirPY > 0 ? ((totals.butPY / totals.tirPY) * 100).toFixed(0) : 0;
    
    // Total row
    const trTotal = document.createElement('tr');
    trTotal.className = 'total-row';
    trTotal.innerHTML = `
        <td>Total</td>
        <td>${totals.shootBut}/${totals.shootTir} (${totalShootPct}%)</td>
        <td>${totals.butHPY}/${totals.tirHPY} (${totalHpyPct}%)</td>
        <td>${totals.butPY}/${totals.tirPY} (${totalPyPct}%)</td>
        <td>${totals.pyObt}</td>
        <td>${totals.min2Obt}</td>
        <td>${totals.pdb}</td>
        <td>${totals.neutralise}</td>
        <td>${totals.passe}</td>
    `;
    tbody.appendChild(trTotal);
    
    // Average row
    if (matchCount > 0) {
        const trAvg = document.createElement('tr');
        trAvg.style.background = 'rgba(102, 159, 183, 0.2)';
        trAvg.innerHTML = `
            <td>Moyenne</td>
            <td>${(totals.shootBut / matchCount).toFixed(1)}/${(totals.shootTir / matchCount).toFixed(1)}</td>
            <td>${(totals.butHPY / matchCount).toFixed(1)}/${(totals.tirHPY / matchCount).toFixed(1)}</td>
            <td>${(totals.butPY / matchCount).toFixed(1)}/${(totals.tirPY / matchCount).toFixed(1)}</td>
            <td>${(totals.pyObt / matchCount).toFixed(1)}</td>
            <td>${(totals.min2Obt / matchCount).toFixed(1)}</td>
            <td>${(totals.pdb / matchCount).toFixed(1)}</td>
            <td>${(totals.neutralise / matchCount).toFixed(1)}</td>
            <td>${(totals.passe / matchCount).toFixed(1)}</td>
        `;
        tbody.appendChild(trAvg);
    }
    
    document.getElementById('jeuGlobalStats').textContent = `${totals.shootBut}/${totals.shootTir} (${totalShootPct}%)`;
    
    enableSorting('tableJeuGlobal', [
        { index: '1', type: 'shooting' },
        { index: '2', type: 'shooting' },
        { index: '3', type: 'shooting' },
        { index: '4', type: 'simple' },
        { index: '5', type: 'simple' },
        { index: '6', type: 'simple' },
        { index: '7', type: 'simple' },
        { index: '8', type: 'simple' }
    ]);
}

// HPY TABLE
function renderTableJeuHPY(phases, matchCount) {
    const tbody = document.getElementById('tableJeuHPY');
    tbody.innerHTML = '';
    
    const formatRow = (name, stats, icon, isSub = false) => {
        const hpyVal = `${stats.butHPY}/${stats.tirHPY} (${stats.hpyPct}%)`;
        const indent = isSub ? 'padding-left: 2rem;' : '';
        return `
            <td style="${indent}">${icon}${name}</td>
            <td>${formatValue(hpyVal, 'ratio')}</td>
        `;
    };
    
    const totals = renderPhaseRows(tbody, phases, 2, formatRow);
    
    if (!totals) {
        tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; color: var(--grey);">Aucune donn√©e</td></tr>';
        return;
    }
    
    const totalPct = totals.tirHPY > 0 ? ((totals.butHPY / totals.tirHPY) * 100).toFixed(0) : 0;
    
    const trTotal = document.createElement('tr');
    trTotal.className = 'total-row';
    trTotal.innerHTML = `
        <td>Total</td>
        <td>${totals.butHPY}/${totals.tirHPY} (${totalPct}%)</td>
    `;
    tbody.appendChild(trTotal);
    
    if (matchCount > 0) {
        const trAvg = document.createElement('tr');
        trAvg.style.background = 'rgba(102, 159, 183, 0.2)';
        trAvg.innerHTML = `
            <td>Moyenne</td>
            <td>${(totals.butHPY / matchCount).toFixed(1)}/${(totals.tirHPY / matchCount).toFixed(1)}</td>
        `;
        tbody.appendChild(trAvg);
    }
    
    document.getElementById('jeuHpyStats').textContent = `${totals.butHPY}/${totals.tirHPY} (${totalPct}%)`;
    
    enableSorting('tableJeuHPY', [{ index: '1', type: 'shooting' }]);
}

// PY TABLE
function renderTableJeuPY(phases, matchCount) {
    const tbody = document.getElementById('tableJeuPY');
    tbody.innerHTML = '';
    
    const formatRow = (name, stats, icon, isSub = false) => {
        const pyVal = `${stats.butPY}/${stats.tirPY} (${stats.pyPct}%)`;
        const indent = isSub ? 'padding-left: 2rem;' : '';
        return `
            <td style="${indent}">${icon}${name}</td>
            <td>${formatValue(pyVal, 'ratio')}</td>
        `;
    };
    
    const totals = renderPhaseRows(tbody, phases, 2, formatRow);
    
    if (!totals) {
        tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; color: var(--grey);">Aucune donn√©e</td></tr>';
        return;
    }
    
    const totalPct = totals.tirPY > 0 ? ((totals.butPY / totals.tirPY) * 100).toFixed(0) : 0;
    
    const trTotal = document.createElement('tr');
    trTotal.className = 'total-row';
    trTotal.innerHTML = `
        <td>Total</td>
        <td>${totals.butPY}/${totals.tirPY} (${totalPct}%)</td>
    `;
    tbody.appendChild(trTotal);
    
    if (matchCount > 0) {
        const trAvg = document.createElement('tr');
        trAvg.style.background = 'rgba(102, 159, 183, 0.2)';
        trAvg.innerHTML = `
            <td>Moyenne</td>
            <td>${(totals.butPY / matchCount).toFixed(1)}/${(totals.tirPY / matchCount).toFixed(1)}</td>
        `;
        tbody.appendChild(trAvg);
    }
    
    document.getElementById('jeuPyStats').textContent = `${totals.butPY}/${totals.tirPY} (${totalPct}%)`;
    
    enableSorting('tableJeuPY', [{ index: '1', type: 'shooting' }]);
}

// SANCTION TABLE - AVEC CALCUL DES 2' UNIQUE
function renderTableJeuSanction(phases, matchCount) {
    const tbody = document.getElementById('tableJeuSanction');
    tbody.innerHTML = '';
    
    let grandTotals = { pyObt: 0, min2Obt: 0, min2Unique: 0, total: 0 };
    
    Object.entries(phases).forEach(([phaseName, phaseData]) => {
        if (phaseData.data.length === 0) return;
        
        // Calculate unique 2' for this phase
        let pyObt = 0, min2Obt = 0, min2Unique = 0;
        phaseData.data.forEach(row => {
            const hasPy = row.raw['|a03| py obt'] && row.raw['|a03| py obt'].trim();
            const hasMin2 = row.raw['|a04| 2\' obt'] && row.raw['|a04| 2\' obt'].trim();
            
            if (hasPy) pyObt++;
            if (hasMin2) {
                min2Obt++;
                if (!hasPy) min2Unique++;
            }
        });
        
        const total = pyObt + min2Obt;
        const hasSubPhases = Object.keys(phaseData.subPhases).length > 0;
        
        // Main row
        const tr = document.createElement('tr');
        const expandIcon = hasSubPhases ? '<span class="expand-icon" style="cursor: pointer; margin-right: 8px;">‚ñ∂</span>' : '';
        const min2Val = `${min2Obt} (${min2Unique})`;
        
        tr.innerHTML = `
            <td>${expandIcon}${phaseName}</td>
            <td>${formatValue(pyObt, 'number')}</td>
            <td>${formatValue(min2Val, 'ratio-paren')}</td>
            <td>${formatValue(total, 'number')}</td>
        `;
        
        if (hasSubPhases) {
            tr.style.cursor = 'pointer';
            tr.onclick = () => toggleSubPhases(tr);
        }
        
        tbody.appendChild(tr);
        
        grandTotals.pyObt += pyObt;
        grandTotals.min2Obt += min2Obt;
        grandTotals.min2Unique += min2Unique;
        grandTotals.total += total;
        
        // Sub-phases
        if (hasSubPhases) {
            Object.entries(phaseData.subPhases).forEach(([subName, subData]) => {
                if (subData.length === 0) return;
                
                let subPyObt = 0, subMin2Obt = 0, subMin2Unique = 0;
                subData.forEach(row => {
                    const hasPy = row.raw['|a03| py obt'] && row.raw['|a03| py obt'].trim();
                    const hasMin2 = row.raw['|a04| 2\' obt'] && row.raw['|a04| 2\' obt'].trim();
                    
                    if (hasPy) subPyObt++;
                    if (hasMin2) {
                        subMin2Obt++;
                        if (!hasPy) subMin2Unique++;
                    }
                });
                
                const subTotal = subPyObt + subMin2Obt;
                const subMin2Val = `${subMin2Obt} (${subMin2Unique})`;
                
                const trSub = document.createElement('tr');
                trSub.className = 'sub-phase-row hidden';
                trSub.style.cssText = 'background: rgba(102, 159, 183, 0.1);';
                trSub.innerHTML = `
                    <td style="padding-left: 2rem;">‚Ü≥ ${subName}</td>
                    <td>${formatValue(subPyObt, 'number')}</td>
                    <td>${formatValue(subMin2Val, 'ratio-paren')}</td>
                    <td>${formatValue(subTotal, 'number')}</td>
                `;
                
                tbody.appendChild(trSub);
            });
        }
    });
    
    const trTotal = document.createElement('tr');
    trTotal.className = 'total-row';
    trTotal.innerHTML = `
        <td>Total</td>
        <td>${grandTotals.pyObt}</td>
        <td>${grandTotals.min2Obt} (${grandTotals.min2Unique})</td>
        <td>${grandTotals.total}</td>
    `;
    tbody.appendChild(trTotal);
    
    if (matchCount > 0) {
        const trAvg = document.createElement('tr');
        trAvg.style.background = 'rgba(102, 159, 183, 0.2)';
        trAvg.innerHTML = `
            <td>Moyenne</td>
            <td>${(grandTotals.pyObt / matchCount).toFixed(1)}</td>
            <td>${(grandTotals.min2Obt / matchCount).toFixed(1)} (${(grandTotals.min2Unique / matchCount).toFixed(1)})</td>
            <td>${(grandTotals.total / matchCount).toFixed(1)}</td>
        `;
        tbody.appendChild(trAvg);
    }
    
    document.getElementById('jeuSanctionStats').textContent = `${grandTotals.total}`;
    
    enableSorting('tableJeuSanction', [
        { index: '1', type: 'simple' },
        { index: '2', type: 'simple' },
        { index: '3', type: 'simple' }
    ]);
}

// RELATION TABLE
function renderTableJeuRelation(phases, matchCount) {
    const tbody = document.getElementById('tableJeuRelation');
    tbody.innerHTML = '';
    
    const formatRow = (name, stats, icon, isSub = false) => {
        // Calculate passes manually from data
        let piv = 0, ailG = 0, ailD = 0;
        const indent = isSub ? 'padding-left: 2rem;' : '';
        
        // We need access to the actual data, so this won't work with the generic function
        // We'll render manually
        return null;
    };
    
    let grandTotals = { piv: 0, ailG: 0, ailD: 0 };
    
    Object.entries(phases).forEach(([phaseName, phaseData]) => {
        if (phaseData.data.length === 0) return;
        
        let stats = { piv: 0, ailG: 0, ailD: 0 };
        phaseData.data.forEach(row => {
            if (row.raw['|a06| p. piv'] && row.raw['|a06| p. piv'].trim() && row.raw['|a06| p. piv'].trim() !== 'x') stats.piv++;
            if (row.raw['|a07| p. ail G'] && row.raw['|a07| p. ail G'].trim() && row.raw['|a07| p. ail G'].trim() !== 'x') stats.ailG++;
            if (row.raw['|a08| p. ail D'] && row.raw['|a08| p. ail D'].trim() && row.raw['|a08| p. ail D'].trim() !== 'x') stats.ailD++;
        });
        
        const hasSubPhases = Object.keys(phaseData.subPhases).length > 0;
        const tr = document.createElement('tr');
        const expandIcon = hasSubPhases ? '<span class="expand-icon" style="cursor: pointer; margin-right: 8px;">‚ñ∂</span>' : '';
        
        tr.innerHTML = `
            <td>${expandIcon}${phaseName}</td>
            <td>${formatValue(stats.piv, 'number')}</td>
            <td>${formatValue(stats.ailG, 'number')}</td>
            <td>${formatValue(stats.ailD, 'number')}</td>
        `;
        
        if (hasSubPhases) {
            tr.style.cursor = 'pointer';
            tr.onclick = () => toggleSubPhases(tr);
        }
        
        tbody.appendChild(tr);
        
        grandTotals.piv += stats.piv;
        grandTotals.ailG += stats.ailG;
        grandTotals.ailD += stats.ailD;
        
        // Sub-phases
        if (hasSubPhases) {
            Object.entries(phaseData.subPhases).forEach(([subName, subData]) => {
                if (subData.length === 0) return;
                
                let subStats = { piv: 0, ailG: 0, ailD: 0 };
                subData.forEach(row => {
                    if (row.raw['|a06| p. piv'] && row.raw['|a06| p. piv'].trim() && row.raw['|a06| p. piv'].trim() !== 'x') subStats.piv++;
                    if (row.raw['|a07| p. ail G'] && row.raw['|a07| p. ail G'].trim() && row.raw['|a07| p. ail G'].trim() !== 'x') subStats.ailG++;
                    if (row.raw['|a08| p. ail D'] && row.raw['|a08| p. ail D'].trim() && row.raw['|a08| p. ail D'].trim() !== 'x') subStats.ailD++;
                });
                
                const trSub = document.createElement('tr');
                trSub.className = 'sub-phase-row hidden';
                trSub.style.cssText = 'background: rgba(102, 159, 183, 0.1);';
                trSub.innerHTML = `
                    <td style="padding-left: 2rem;">‚Ü≥ ${subName}</td>
                    <td>${formatValue(subStats.piv, 'number')}</td>
                    <td>${formatValue(subStats.ailG, 'number')}</td>
                    <td>${formatValue(subStats.ailD, 'number')}</td>
                `;
                
                tbody.appendChild(trSub);
            });
        }
    });
    
    const trTotal = document.createElement('tr');
    trTotal.className = 'total-row';
    trTotal.innerHTML = `
        <td>Total</td>
        <td>${grandTotals.piv}</td>
        <td>${grandTotals.ailG}</td>
        <td>${grandTotals.ailD}</td>
    `;
    tbody.appendChild(trTotal);
    
    if (matchCount > 0) {
        const trAvg = document.createElement('tr');
        trAvg.style.background = 'rgba(102, 159, 183, 0.2)';
        trAvg.innerHTML = `
            <td>Moyenne</td>
            <td>${(grandTotals.piv / matchCount).toFixed(1)}</td>
            <td>${(grandTotals.ailG / matchCount).toFixed(1)}</td>
            <td>${(grandTotals.ailD / matchCount).toFixed(1)}</td>
        `;
        tbody.appendChild(trAvg);
    }
    
    const totalPasses = grandTotals.piv + grandTotals.ailG + grandTotals.ailD;
    document.getElementById('jeuRelationStats').textContent = `${totalPasses}`;
    
    enableSorting('tableJeuRelation', [
        { index: '1', type: 'simple' },
        { index: '2', type: 'simple' },
        { index: '3', type: 'simple' }
    ]);
}

// PDB TABLE
function renderTableJeuPdb(phases, matchCount) {
    const tbody = document.getElementById('tableJeuPdb');
    tbody.innerHTML = '';
    
    const formatRow = (name, stats, icon, isSub = false) => {
        const indent = isSub ? 'padding-left: 2rem;' : '';
        return `
            <td style="${indent}">${icon}${name}</td>
            <td>${formatValue(stats.pdb, 'number')}</td>
        `;
    };
    
    const totals = renderPhaseRows(tbody, phases, 2, formatRow);
    
    if (!totals) {
        tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; color: var(--grey);">Aucune donn√©e</td></tr>';
        return;
    }
    
    const trTotal = document.createElement('tr');
    trTotal.className = 'total-row';
    trTotal.innerHTML = `
        <td>Total</td>
        <td>${totals.pdb}</td>
    `;
    tbody.appendChild(trTotal);
    
    if (matchCount > 0) {
        const trAvg = document.createElement('tr');
        trAvg.style.background = 'rgba(102, 159, 183, 0.2)';
        trAvg.innerHTML = `
            <td>Moyenne</td>
            <td>${(totals.pdb / matchCount).toFixed(1)}</td>
        `;
        tbody.appendChild(trAvg);
    }
    
    document.getElementById('jeuPdbStats').textContent = `${totals.pdb}`;
    
    enableSorting('tableJeuPdb', [{ index: '1', type: 'simple' }]);
}

// NEUTRALISE TABLE
function renderTableJeuNeutralise(phases, matchCount) {
    const tbody = document.getElementById('tableJeuNeutralise');
    tbody.innerHTML = '';
    
    const formatRow = (name, stats, icon, isSub = false) => {
        const indent = isSub ? 'padding-left: 2rem;' : '';
        return `
            <td style="${indent}">${icon}${name}</td>
            <td>${formatValue(stats.neutralise, 'number')}</td>
        `;
    };
    
    const totals = renderPhaseRows(tbody, phases, 2, formatRow);
    
    if (!totals) {
        tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; color: var(--grey);">Aucune donn√©e</td></tr>';
        return;
    }
    
    const trTotal = document.createElement('tr');
    trTotal.className = 'total-row';
    trTotal.innerHTML = `
        <td>Total</td>
        <td>${totals.neutralise}</td>
    `;
    tbody.appendChild(trTotal);
    
    if (matchCount > 0) {
        const trAvg = document.createElement('tr');
        trAvg.style.background = 'rgba(102, 159, 183, 0.2)';
        trAvg.innerHTML = `
            <td>Moyenne</td>
            <td>${(totals.neutralise / matchCount).toFixed(1)}</td>
        `;
        tbody.appendChild(trAvg);
    }
    
    document.getElementById('jeuNeutraliseStats').textContent = `${totals.neutralise}`;
    
    enableSorting('tableJeuNeutralise', [{ index: '1', type: 'simple' }]);
}

function renderAllEquipeTables(data) {
    const filtered = applyFilters(data);
    
    // Update filtered lines count
    document.getElementById('statFilteredLines').textContent = filtered.length;
    
    // Get unique matches count for averaging
    const uniqueMatches = new Set(filtered.map(row => row.raw['[M] rencontre'])).size;
    
    renderTableGlobal(filtered, uniqueMatches);
    renderTableHPYv2(filtered, uniqueMatches);
    renderTablePY(filtered, uniqueMatches);
    renderTableSanction(filtered, uniqueMatches);
    renderTableRelation(filtered, uniqueMatches);
    renderTablePdb(filtered, uniqueMatches);
    renderTableNeutralise(filtered, uniqueMatches);
}

// TABLE 1: GLOBAL
function renderTableGlobal(filtered, matchCount) {
    const stats = {};
    
    filtered.forEach(row => {
        const joueur = row.raw['#14 joueurs'];
        if (!joueur || joueur === 'x' || !joueur.trim()) return;
        
        if (!stats[joueur]) {
            stats[joueur] = { butHPY: 0, tirHPY: 0, butPY: 0, tirPY: 0, pyObt: 0, min2Obt: 0, pdb: 0, neutralise: 0, passe: 0 };
        }
        
        const colButHPY = (row.raw['|a00| but'] || '').trim();
        const colTirHPY = (row.raw['|a00| tir'] || '').trim();
        const colButPY = (row.raw['|a01| but py'] || '').trim();
        const colTirPY = (row.raw['|a01| tir py'] || '').trim();
        const colPyObt = (row.raw['|a03| py obt'] || '').trim();
        const colMin2Obt = (row.raw["|a04| 2' obt"] || '').trim();
        const colPdb = (row.raw['|a18| pdb'] || '').trim();
        const colNeutralise = (row.raw['|a19| neutralis√©'] || '').trim();
        const colPPiv = (row.raw['|a06| p. piv'] || '').trim();
        const colPAilG = (row.raw['|a07| p. ail G'] || '').trim();
        const colPAilD = (row.raw['|a08| p. ail D'] || '').trim();
        
        if (colButHPY === joueur) stats[joueur].butHPY++;
        if (colTirHPY === joueur && colTirHPY !== 'x') stats[joueur].tirHPY++;
        if (colButPY === joueur) stats[joueur].butPY++;
        if (colTirPY === joueur) stats[joueur].tirPY++;
        if (colPyObt === joueur) stats[joueur].pyObt++;
        if (colMin2Obt === joueur) stats[joueur].min2Obt++;
        if (colPdb === joueur) stats[joueur].pdb++;
        if (colNeutralise === joueur) stats[joueur].neutralise++;
        
        // PASSES: Count for the player who made the pass (not the player with the ball)
        // Create entry for passer if doesn't exist
        if (colPPiv && colPPiv !== 'x') {
            if (!stats[colPPiv]) {
                stats[colPPiv] = { butHPY: 0, tirHPY: 0, butPY: 0, tirPY: 0, pyObt: 0, min2Obt: 0, pdb: 0, neutralise: 0, passe: 0 };
            }
            stats[colPPiv].passe++;
        }
        if (colPAilG && colPAilG !== 'x') {
            if (!stats[colPAilG]) {
                stats[colPAilG] = { butHPY: 0, tirHPY: 0, butPY: 0, tirPY: 0, pyObt: 0, min2Obt: 0, pdb: 0, neutralise: 0, passe: 0 };
            }
            stats[colPAilG].passe++;
        }
        if (colPAilD && colPAilD !== 'x') {
            if (!stats[colPAilD]) {
                stats[colPAilD] = { butHPY: 0, tirHPY: 0, butPY: 0, tirPY: 0, pyObt: 0, min2Obt: 0, pdb: 0, neutralise: 0, passe: 0 };
            }
            stats[colPAilD].passe++;
        }
    });
    
    const arr = Object.entries(stats).map(([name, s]) => ({
        name,
        ...s,
        shootBut: s.butHPY + s.butPY,
        shootTir: s.tirHPY + s.tirPY,
        shootPct: (s.tirHPY + s.tirPY) > 0 ? (s.butHPY + s.butPY) / (s.tirHPY + s.tirPY) : 0,
        hpyPct: s.tirHPY > 0 ? s.butHPY / s.tirHPY : 0,
        pyPct: s.tirPY > 0 ? s.butPY / s.tirPY : 0
    })).sort((a, b) => b.shootTir - a.shootTir || b.shootBut - a.shootBut);
    
    const totals = arr.reduce((acc, p) => ({
        shootBut: acc.shootBut + p.shootBut,
        shootTir: acc.shootTir + p.shootTir,
        butHPY: acc.butHPY + p.butHPY,
        tirHPY: acc.tirHPY + p.tirHPY,
        butPY: acc.butPY + p.butPY,
        tirPY: acc.tirPY + p.tirPY,
        pyObt: acc.pyObt + p.pyObt,
        min2Obt: acc.min2Obt + p.min2Obt,
        pdb: acc.pdb + p.pdb,
        neutralise: acc.neutralise + p.neutralise,
        passe: acc.passe + p.passe
    }), { shootBut: 0, shootTir: 0, butHPY: 0, tirHPY: 0, butPY: 0, tirPY: 0, pyObt: 0, min2Obt: 0, pdb: 0, neutralise: 0, passe: 0 });
    
    const shootPct = totals.shootTir > 0 ? (totals.shootBut / totals.shootTir * 100).toFixed(0) : 0;
    document.getElementById('globalStats').textContent = `${totals.shootBut}/${totals.shootTir} (${shootPct}%)`;
    
    const tbody = document.getElementById('tableGlobal');
    tbody.innerHTML = '';
    
    if (arr.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: var(--grey);">Aucune donn√©e</td></tr>';
        return;
    }
    
    arr.forEach(p => {
        const tr = document.createElement('tr');
        const shootVal = `${p.shootBut}/${p.shootTir} (${(p.shootPct * 100).toFixed(0)}%)`;
        const hpyVal = `${p.butHPY}/${p.tirHPY} (${(p.hpyPct * 100).toFixed(0)}%)`;
        const pyVal = `${p.butPY}/${p.tirPY} (${(p.pyPct * 100).toFixed(0)}%)`;
        
        tr.innerHTML = `
            <td>${p.name}</td>
            <td>${formatValue(shootVal, 'ratio')}</td>
            <td>${formatValue(hpyVal, 'ratio')}</td>
            <td>${formatValue(pyVal, 'ratio')}</td>
            <td>${formatValue(p.pyObt, 'number')}</td>
            <td>${formatValue(p.min2Obt, 'number')}</td>
            <td>${formatValue(p.pdb, 'number')}</td>
            <td>${formatValue(p.neutralise, 'number')}</td>
            <td>${formatValue(p.passe, 'number')}</td>
        `;
        tbody.appendChild(tr);
    });
    
    // Total row
    const trTotal = document.createElement('tr');
    trTotal.className = 'total-row';
    trTotal.innerHTML = `
        <td>Total</td>
        <td>${totals.shootBut}/${totals.shootTir} (${shootPct}%)</td>
        <td>${totals.butHPY}/${totals.tirHPY} (${totals.tirHPY > 0 ? (totals.butHPY / totals.tirHPY * 100).toFixed(0) : 0}%)</td>
        <td>${totals.butPY}/${totals.tirPY} (${totals.tirPY > 0 ? (totals.butPY / totals.tirPY * 100).toFixed(0) : 0}%)</td>
        <td>${totals.pyObt}</td>
        <td>${totals.min2Obt}</td>
        <td>${totals.pdb}</td>
        <td>${totals.neutralise}</td>
        <td>${totals.passe}</td>
    `;
    tbody.appendChild(trTotal);
    
    // Average row
    if (matchCount > 0) {
        const trAvg = document.createElement('tr');
        trAvg.style.background = 'rgba(102, 159, 183, 0.2)';
        trAvg.innerHTML = `
            <td>Moyenne</td>
            <td>${(totals.shootBut / matchCount).toFixed(1)}/${(totals.shootTir / matchCount).toFixed(1)}</td>
            <td>${(totals.butHPY / matchCount).toFixed(1)}/${(totals.tirHPY / matchCount).toFixed(1)}</td>
            <td>${(totals.butPY / matchCount).toFixed(1)}/${(totals.tirPY / matchCount).toFixed(1)}</td>
            <td>${(totals.pyObt / matchCount).toFixed(1)}</td>
            <td>${(totals.min2Obt / matchCount).toFixed(1)}</td>
            <td>${(totals.pdb / matchCount).toFixed(1)}</td>
            <td>${(totals.neutralise / matchCount).toFixed(1)}</td>
            <td>${(totals.passe / matchCount).toFixed(1)}</td>
        `;
        tbody.appendChild(trAvg);
    }
    
    // Enable sorting
    enableSorting('tableGlobal', [
        { index: '1', type: 'shooting' },
        { index: '2', type: 'shooting' },
        { index: '3', type: 'shooting' },
        { index: '4', type: 'simple' },
        { index: '5', type: 'simple' },
        { index: '6', type: 'simple' },
        { index: '7', type: 'simple' },
        { index: '8', type: 'simple' }
    ]);
}

// TABLE 2: HPY (version v2 pour ne pas √©craser l'ancienne)
function renderTableHPYv2(filtered, matchCount) {
    const stats = {};
    
    filtered.forEach(row => {
        const joueur = row.raw['#14 joueurs'];
        if (!joueur || joueur === 'x' || !joueur.trim()) return;
        
        if (!stats[joueur]) stats[joueur] = { but: 0, tir: 0 };
        
        const colBut = (row.raw['|a00| but'] || '').trim();
        const colTir = (row.raw['|a00| tir'] || '').trim();
        
        if (colBut === joueur) stats[joueur].but++;
        if (colTir === joueur && colTir !== 'x') stats[joueur].tir++;
    });
    
    const arr = Object.entries(stats)
        .map(([name, s]) => ({
            name,
            but: s.but,
            tir: s.tir,
            pct: s.tir > 0 ? s.but / s.tir : 0
        }))
        .filter(p => p.tir > 0)
        .sort((a, b) => b.tir - a.tir || b.but - a.but);
    
    const totalBut = arr.reduce((sum, p) => sum + p.but, 0);
    const totalTir = arr.reduce((sum, p) => sum + p.tir, 0);
    const totalPct = totalTir > 0 ? (totalBut / totalTir * 100).toFixed(0) : 0;
    
    document.getElementById('hpyStats').textContent = `${totalBut}/${totalTir} (${totalPct}%)`;
    
    const tbody = document.getElementById('tableHPY');
    tbody.innerHTML = '';
    
    if (arr.length === 0) {
        tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; color: var(--grey);">Aucune donn√©e</td></tr>';
        return;
    }
    
    arr.forEach(p => {
        const tr = document.createElement('tr');
        const hpyVal = `${p.but}/${p.tir} (${(p.pct * 100).toFixed(0)}%)`;
        tr.innerHTML = `
            <td>${p.name}</td>
            <td>${formatValue(hpyVal, 'ratio')}</td>
        `;
        tbody.appendChild(tr);
    });
    
    const trTotal = document.createElement('tr');
    trTotal.className = 'total-row';
    trTotal.innerHTML = `
        <td>Total</td>
        <td>${totalBut}/${totalTir} (${totalPct}%)</td>
    `;
    tbody.appendChild(trTotal);
    
    if (matchCount > 0) {
        const trAvg = document.createElement('tr');
        trAvg.style.background = 'rgba(102, 159, 183, 0.2)';
        trAvg.innerHTML = `
            <td>Moyenne</td>
            <td>${(totalBut / matchCount).toFixed(1)}/${(totalTir / matchCount).toFixed(1)}</td>
        `;
        tbody.appendChild(trAvg);
    }
    
    // Enable sorting
    enableSorting('tableHPY', [
        { index: '1', type: 'shooting' }
    ]);
}

// TABLE 3: PY
function renderTablePY(filtered, matchCount) {
    const stats = {};
    
    filtered.forEach(row => {
        const joueur = row.raw['#14 joueurs'];
        if (!joueur || joueur === 'x' || !joueur.trim()) return;
        
        if (!stats[joueur]) stats[joueur] = { but: 0, tir: 0 };
        
        const colBut = (row.raw['|a01| but py'] || '').trim();
        const colTir = (row.raw['|a01| tir py'] || '').trim();
        
        if (colBut === joueur) stats[joueur].but++;
        if (colTir === joueur) stats[joueur].tir++;
    });
    
    const arr = Object.entries(stats)
        .map(([name, s]) => ({
            name,
            but: s.but,
            tir: s.tir,
            pct: s.tir > 0 ? s.but / s.tir : 0
        }))
        .filter(p => p.tir > 0)
        .sort((a, b) => b.tir - a.tir || b.but - a.but);
    
    const totalBut = arr.reduce((sum, p) => sum + p.but, 0);
    const totalTir = arr.reduce((sum, p) => sum + p.tir, 0);
    const totalPct = totalTir > 0 ? (totalBut / totalTir * 100).toFixed(0) : 0;
    
    document.getElementById('pyStats').textContent = `${totalBut}/${totalTir} (${totalPct}%)`;
    
    const tbody = document.getElementById('tablePY');
    tbody.innerHTML = '';
    
    if (arr.length === 0) {
        tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; color: var(--grey);">Aucune donn√©e</td></tr>';
        return;
    }
    
    arr.forEach(p => {
        const tr = document.createElement('tr');
        const pyVal = `${p.but}/${p.tir} (${(p.pct * 100).toFixed(0)}%)`;
        tr.innerHTML = `
            <td>${p.name}</td>
            <td>${formatValue(pyVal, 'ratio')}</td>
        `;
        tbody.appendChild(tr);
    });
    
    const trTotal = document.createElement('tr');
    trTotal.className = 'total-row';
    trTotal.innerHTML = `
        <td>Total</td>
        <td>${totalBut}/${totalTir} (${totalPct}%)</td>
    `;
    tbody.appendChild(trTotal);
    
    if (matchCount > 0) {
        const trAvg = document.createElement('tr');
        trAvg.style.background = 'rgba(102, 159, 183, 0.2)';
        trAvg.innerHTML = `
            <td>Moyenne</td>
            <td>${(totalBut / matchCount).toFixed(1)}/${(totalTir / matchCount).toFixed(1)}</td>
        `;
        tbody.appendChild(trAvg);
    }
    
    // Enable sorting
    enableSorting('tablePY', [
        { index: '1', type: 'shooting' }
    ]);
}

// TABLE 4: SANCTION OBT
function renderTableSanction(filtered, matchCount) {
    const stats = {};
    
    filtered.forEach(row => {
        const joueur = row.raw['#14 joueurs'];
        if (!joueur || joueur === 'x' || !joueur.trim()) return;
        
        if (!stats[joueur]) stats[joueur] = { pyObt: 0, min2Obt: 0, min2Unique: 0 };
        
        const colPyObt = (row.raw['|a03| py obt'] || '').trim();
        const colMin2Obt = (row.raw["|a04| 2' obt"] || '').trim();
        
        if (colPyObt === joueur) stats[joueur].pyObt++;
        if (colMin2Obt === joueur) {
            stats[joueur].min2Obt++;
            // 2' unique = 2' obt avec py obt vide
            if (!colPyObt) stats[joueur].min2Unique++;
        }
    });
    
    const arr = Object.entries(stats)
        .map(([name, s]) => ({
            name,
            ...s,
            total: s.pyObt + s.min2Obt
        }))
        .filter(p => p.total > 0)
        .sort((a, b) => b.total - a.total);
    
    const totals = arr.reduce((acc, p) => ({
        pyObt: acc.pyObt + p.pyObt,
        min2Obt: acc.min2Obt + p.min2Obt,
        min2Unique: acc.min2Unique + p.min2Unique,
        total: acc.total + p.total
    }), { pyObt: 0, min2Obt: 0, min2Unique: 0, total: 0 });
    
    document.getElementById('sanctionStats').textContent = `${totals.total} sanctions`;
    
    const tbody = document.getElementById('tableSanction');
    tbody.innerHTML = '';
    
    if (arr.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--grey);">Aucune donn√©e</td></tr>';
        return;
    }
    
    arr.forEach(p => {
        const tr = document.createElement('tr');
        const min2Val = `${p.min2Obt} (${p.min2Unique})`;
        tr.innerHTML = `
            <td>${p.name}</td>
            <td>${formatValue(p.pyObt, 'number')}</td>
            <td>${formatValue(min2Val, 'ratio-paren')}</td>
            <td>${formatValue(p.total, 'number')}</td>
        `;
        tbody.appendChild(tr);
    });
    
    const trTotal = document.createElement('tr');
    trTotal.className = 'total-row';
    trTotal.innerHTML = `
        <td>Total</td>
        <td>${totals.pyObt}</td>
        <td>${totals.min2Obt} (${totals.min2Unique})</td>
        <td>${totals.total}</td>
    `;
    tbody.appendChild(trTotal);
    
    if (matchCount > 0) {
        const trAvg = document.createElement('tr');
        trAvg.style.background = 'rgba(102, 159, 183, 0.2)';
        trAvg.innerHTML = `
            <td>Moyenne</td>
            <td>${(totals.pyObt / matchCount).toFixed(1)}</td>
            <td>${(totals.min2Obt / matchCount).toFixed(1)} (${(totals.min2Unique / matchCount).toFixed(1)})</td>
            <td>${(totals.total / matchCount).toFixed(1)}</td>
        `;
        tbody.appendChild(trAvg);
    }
    
    // Enable sorting
    enableSorting('tableSanction', [
        { index: '1', type: 'simple' },
        { index: '2', type: 'simple' },
        { index: '3', type: 'simple' }
    ]);
}

// TABLE 5: RELATION
function renderTableRelation(filtered, matchCount) {
    const stats = {};
    
    filtered.forEach(row => {
        const colPPiv = (row.raw['|a06| p. piv'] || '').trim();
        const colPAilG = (row.raw['|a07| p. ail G'] || '').trim();
        const colPAilD = (row.raw['|a08| p. ail D'] || '').trim();
        
        // Count for the player who made the pass
        if (colPPiv && colPPiv !== 'x') {
            if (!stats[colPPiv]) stats[colPPiv] = { piv: 0, ailG: 0, ailD: 0 };
            stats[colPPiv].piv++;
        }
        if (colPAilG && colPAilG !== 'x') {
            if (!stats[colPAilG]) stats[colPAilG] = { piv: 0, ailG: 0, ailD: 0 };
            stats[colPAilG].ailG++;
        }
        if (colPAilD && colPAilD !== 'x') {
            if (!stats[colPAilD]) stats[colPAilD] = { piv: 0, ailG: 0, ailD: 0 };
            stats[colPAilD].ailD++;
        }
    });
    
    const arr = Object.entries(stats)
        .map(([name, s]) => ({
            name,
            ...s,
            total: s.piv + s.ailG + s.ailD
        }))
        .filter(p => p.total > 0)
        .sort((a, b) => b.total - a.total);
    
    const totals = arr.reduce((acc, p) => ({
        piv: acc.piv + p.piv,
        ailG: acc.ailG + p.ailG,
        ailD: acc.ailD + p.ailD
    }), { piv: 0, ailG: 0, ailD: 0 });
    
    document.getElementById('relationStats').textContent = `${totals.piv + totals.ailG + totals.ailD} passes`;
    
    const tbody = document.getElementById('tableRelation');
    tbody.innerHTML = '';
    
    if (arr.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--grey);">Aucune donn√©e</td></tr>';
        return;
    }
    
    arr.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${p.name}</td>
            <td>${formatValue(p.piv, 'number')}</td>
            <td>${formatValue(p.ailG, 'number')}</td>
            <td>${formatValue(p.ailD, 'number')}</td>
        `;
        tbody.appendChild(tr);
    });
    
    const trTotal = document.createElement('tr');
    trTotal.className = 'total-row';
    trTotal.innerHTML = `
        <td>Total</td>
        <td>${totals.piv}</td>
        <td>${totals.ailG}</td>
        <td>${totals.ailD}</td>
    `;
    tbody.appendChild(trTotal);
    
    if (matchCount > 0) {
        const trAvg = document.createElement('tr');
        trAvg.style.background = 'rgba(102, 159, 183, 0.2)';
        trAvg.innerHTML = `
            <td>Moyenne</td>
            <td>${(totals.piv / matchCount).toFixed(1)}</td>
            <td>${(totals.ailG / matchCount).toFixed(1)}</td>
            <td>${(totals.ailD / matchCount).toFixed(1)}</td>
        `;
        tbody.appendChild(trAvg);
    }
    
    // Enable sorting
    enableSorting('tableRelation', [
        { index: '1', type: 'simple' },
        { index: '2', type: 'simple' },
        { index: '3', type: 'simple' }
    ]);
}

// TABLE 6: PDB
function renderTablePdb(filtered, matchCount) {
    const stats = {};
    
    filtered.forEach(row => {
        const joueur = row.raw['#14 joueurs'];
        if (!joueur || joueur === 'x' || !joueur.trim()) return;
        
        if (!stats[joueur]) stats[joueur] = { pdb: 0 };
        
        const colPdb = (row.raw['|a18| pdb'] || '').trim();
        
        if (colPdb === joueur) stats[joueur].pdb++;
    });
    
    const arr = Object.entries(stats)
        .map(([name, s]) => ({ name, pdb: s.pdb }))
        .filter(p => p.pdb > 0)
        .sort((a, b) => b.pdb - a.pdb);
    
    const totalPdb = arr.reduce((sum, p) => sum + p.pdb, 0);
    
    document.getElementById('pdbStats').textContent = `${totalPdb} pdb`;
    
    const tbody = document.getElementById('tablePdb');
    tbody.innerHTML = '';
    
    if (arr.length === 0) {
        tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; color: var(--grey);">Aucune donn√©e</td></tr>';
        return;
    }
    
    arr.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${p.name}</td>
            <td>${formatValue(p.pdb, 'number')}</td>
        `;
        tbody.appendChild(tr);
    });
    
    const trTotal = document.createElement('tr');
    trTotal.className = 'total-row';
    trTotal.innerHTML = `
        <td>Total</td>
        <td>${totalPdb}</td>
    `;
    tbody.appendChild(trTotal);
    
    if (matchCount > 0) {
        const trAvg = document.createElement('tr');
        trAvg.style.background = 'rgba(102, 159, 183, 0.2)';
        trAvg.innerHTML = `
            <td>Moyenne</td>
            <td>${(totalPdb / matchCount).toFixed(1)}</td>
        `;
        tbody.appendChild(trAvg);
    }
    
    // Enable sorting
    enableSorting('tablePdb', [
        { index: '1', type: 'simple' }
    ]);
}

// TABLE 7: NEUTRALIS√â
function renderTableNeutralise(filtered, matchCount) {
    const stats = {};
    
    filtered.forEach(row => {
        const joueur = row.raw['#14 joueurs'];
        if (!joueur || joueur === 'x' || !joueur.trim()) return;
        
        if (!stats[joueur]) stats[joueur] = { neutralise: 0 };
        
        const colNeutralise = (row.raw['|a19| neutralis√©'] || '').trim();
        
        if (colNeutralise === joueur) stats[joueur].neutralise++;
    });
    
    const arr = Object.entries(stats)
        .map(([name, s]) => ({ name, neutralise: s.neutralise }))
        .filter(p => p.neutralise > 0)
        .sort((a, b) => b.neutralise - a.neutralise);
    
    const totalN = arr.reduce((sum, p) => sum + p.neutralise, 0);
    
    document.getElementById('neutraliseStats').textContent = `${totalN} neutralisations`;
    
    const tbody = document.getElementById('tableNeutralise');
    tbody.innerHTML = '';
    
    if (arr.length === 0) {
        tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; color: var(--grey);">Aucune donn√©e</td></tr>';
        return;
    }
    
    arr.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${p.name}</td>
            <td>${formatValue(p.neutralise, 'number')}</td>
        `;
        tbody.appendChild(tr);
    });
    
    const trTotal = document.createElement('tr');
    trTotal.className = 'total-row';
    trTotal.innerHTML = `
        <td>Total</td>
        <td>${totalN}</td>
    `;
    tbody.appendChild(trTotal);
    
    if (matchCount > 0) {
        const trAvg = document.createElement('tr');
        trAvg.style.background = 'rgba(102, 159, 183, 0.2)';
        trAvg.innerHTML = `
            <td>Moyenne</td>
            <td>${(totalN / matchCount).toFixed(1)}</td>
        `;
        tbody.appendChild(trAvg);
    }
    
    // Enable sorting
    enableSorting('tableNeutralise', [
        { index: '1', type: 'simple' }
    ]);
}
        
        // MODE SWITCH
        document.getElementById('btnModeATT').onclick = () => {
            currentMode = 'ATT';
            document.getElementById('btnModeATT').classList.add('active');
            document.getElementById('btnModeDEF').classList.remove('active');
            
            // Show/hide PhJeu filters
            document.getElementById('filterPhJeuATT').classList.remove('hidden');
            document.getElementById('filterPhJeuDEF').classList.add('hidden');
            
            if (currentTeam) loadTeamData();
        };
        
        document.getElementById('btnModeDEF').onclick = () => {
            currentMode = 'DEF';
            document.getElementById('btnModeDEF').classList.add('active');
            document.getElementById('btnModeATT').classList.remove('active');
            
            // Show/hide PhJeu filters
            document.getElementById('filterPhJeuDEF').classList.remove('hidden');
            document.getElementById('filterPhJeuATT').classList.add('hidden');
            
            if (currentTeam) loadTeamData();
        };
        
        // VIEW TABS
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const view = btn.dataset.view;
                
                // Update tabs
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Update views
                document.querySelectorAll('.view-content').forEach(v => v.classList.remove('active'));
                document.querySelector(`.view-content[data-view="${view}"]`).classList.add('active');
            });
        });
        
        // ACCORDION
        function toggleAccordion(id) {
            const header = document.querySelector(`#accordion-${id}`).previousElementSibling;
            const content = document.getElementById(`accordion-${id}`);
            
            header.classList.toggle('open');
            content.classList.toggle('open');
        }
        
        // UI HELPERS
        function showLoading(msg) {
            document.getElementById('loadingIndicator').classList.remove('hidden');
            document.getElementById('loadingDetails').textContent = msg;
        }
        
        function updateLoading(msg) {
            document.getElementById('loadingDetails').textContent = msg;
        }
        
        function hideLoading() {
            document.getElementById('loadingIndicator').classList.add('hidden');
        }
        
        function showAlert(type, msg) {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = msg;
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
    </script>

    <!-- Service Worker PWA -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(reg => {
                        console.log('‚úÖ Service Worker enregistr√©, scope :', reg.scope);

                        // Detecter une mise a jour du SW
                        reg.addEventListener('updatefound', () => {
                            const newSW = reg.installing;
                            newSW.addEventListener('statechange', () => {
                                if (newSW.state === 'activated') {
                                    console.log('üîÑ Nouveau Service Worker actif - rechargement...');
                                    // Recharger pour prendre les nouveaux fichiers en cache
                                    window.location.reload();
                                }
                            });
                        });
                    })
                    .catch(err => console.warn('‚ö†Ô∏è Service Worker non enregistr√© :', err));
            });
        }
    </script>
</body>
</html>
